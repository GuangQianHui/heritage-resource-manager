
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>资源管理系统</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js - 使用更可靠的CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <!-- 备用Chart.js CDN -->
    <script>
        // 如果主要CDN加载失败，尝试备用CDN
        if (typeof Chart === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js';
            script.onload = function() {
                console.log('Chart.js从备用CDN加载成功');
            };
            script.onerror = function() {
                console.warn('Chart.js加载失败，图表功能将不可用');
                // 禁用图表相关功能
                window.chartDisabled = true;
            };
            document.head.appendChild(script);
        }
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#DC143C',
                        secondary: '#FF6B6B',
                        accent: '#FF8E8E',
                        gold: '#FFD700'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'bounce-in': 'bounceIn 0.6s ease-out',
                        'pulse-slow': 'pulse 3s infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.3)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)' },
                            '70%': { transform: 'scale(0.9)' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* 毛玻璃效果 */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* 卡片悬停效果 */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* 按钮悬停效果 */
        .btn-hover {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-hover:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* 加载动画 */
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #DC143C;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 渐变文字效果 */
        .gradient-text {
            background: linear-gradient(135deg, #FFFFFF, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* 资源卡片动画效果 */
        .resource-card {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .resource-card.adding {
            animation: slideInFromLeft 0.5s ease-out;
        }
        
        .resource-card.removing {
            animation: slideOutToRight 0.5s ease-in;
        }
        
        @keyframes slideInFromLeft {
            0% {
                opacity: 0;
                transform: translateX(-100px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOutToRight {
            0% {
                opacity: 1;
                transform: translateX(0);
            }
            100% {
                opacity: 0;
                transform: translateX(100px);
            }
        }
        
        /* 浮动动画 */
        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        /* 浮动动画 */
        .float-animation {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        /* 输入框焦点效果 */
        input:focus, textarea:focus, select:focus {
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
        }
        
        /* 下拉选择框样式优化 - 清除默认黑色 */
        select {
            background-color: #ffffff !important;
            color: #374151 !important; /* gray-700 */
            border: 1px solid #d1d5db !important; /* gray-300 */
            border-radius: 0.5rem !important;
            padding: 0.5rem 0.75rem !important;
            font-size: 0.875rem !important;
            line-height: 1.25rem !important;
            appearance: none !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e") !important;
            background-position: right 0.5rem center !important;
            background-repeat: no-repeat !important;
            background-size: 1.5em 1.5em !important;
            padding-right: 2.5rem !important;
            cursor: pointer !important;
            transition: all 0.2s ease-in-out !important;
        }
        
        select:hover {
            border-color: #9ca3af !important; /* gray-400 */
            background-color: #f9fafb !important; /* gray-50 */
        }
        
        select:focus {
            outline: none !important;
            border-color: #dc143c !important; /* primary color */
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1) !important;
            background-color: #ffffff !important;
        }
        
        /* 下拉选项样式 */
        select option {
            background-color: #ffffff !important;
            color: #374151 !important; /* gray-700 */
            padding: 0.5rem !important;
        }
        
        select option:hover {
            background-color: #f3f4f6 !important; /* gray-100 */
        }
        
        select option:checked {
            background-color: #dc143c !important; /* primary color */
            color: #ffffff !important;
        }
        
        /* 禁用状态 */
        select:disabled {
            background-color: #f3f4f6 !important; /* gray-100 */
            color: #9ca3af !important; /* gray-400 */
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }
        
        /* 搜索功能样式 */
        #search-input {
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            outline: none !important;
        }
        
        #search-input:focus {
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.15);
            transform: translateY(-1px);
            outline: none !important;
            border-color: #dc143c !important;
        }
        
        #search-input:focus + .absolute {
            color: #dc143c;
        }
        
        #clear-search-btn {
            transition: all 0.2s ease;
        }
        
        #clear-search-btn:hover {
            transform: scale(1.1);
            color: #dc143c !important;
        }
        

        
        #search-filters {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(249, 250, 251, 0.9));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(220, 20, 60, 0.1);
            border-radius: 8px;
            padding: 12px;
        }
        
        #search-filters input[type="checkbox"] {
            accent-color: #dc143c;
        }
        
        #search-filters label {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        #search-filters label:hover {
            color: #dc143c;
            transform: translateY(-1px);
        }
        
        #search-stats {
            background: linear-gradient(135deg, rgba(220, 20, 60, 0.05), rgba(255, 255, 255, 0.8));
            border-radius: 6px;
            padding: 8px 12px;
            border-left: 3px solid #dc143c;
        }
        
        /* 搜索动画效果 */
        @keyframes searchPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .search-active {
            animation: searchPulse 0.3s ease;
        }
        
        /* 搜索结果高亮 */
        .search-highlight {
            background: linear-gradient(135deg, #fef08a 0%, #fde047 100%);
            color: #92400e;
            padding: 1px 3px;
            border-radius: 4px;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            display: inline-block;
            line-height: 1.2;
        }
        
        /* 标题中的高亮效果 */
        h3 .search-highlight {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3);
        }
        
        /* 标签中的高亮效果 */
        .resource-card-tags .search-highlight,
        .resource-card-tags span .search-highlight {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%) !important;
            color: #78350f !important;
            padding: 2px 4px !important;
            border-radius: 4px !important;
            font-weight: 700 !important;
            font-size: 0.75em !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15) !important;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3) !important;
            border: 1px solid rgba(251, 191, 36, 0.3) !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        /* 标签高亮悬停效果 */
        .resource-card-tags .search-highlight:hover,
        .resource-card-tags span .search-highlight:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            transform: scale(1.05) !important;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* 标签高亮动画 */
        .resource-card-tags .search-highlight,
        .resource-card-tags span .search-highlight {
            animation: tagHighlightPulse 0.4s ease-in-out !important;
        }
        
        @keyframes tagHighlightPulse {
            0% { 
                transform: scale(1); 
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            }
            50% { 
                transform: scale(1.1); 
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
            }
            100% { 
                transform: scale(1); 
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            }
        }
        
        /* 内容中的高亮效果 */
        .resource-card-description .search-highlight {
            background: linear-gradient(135deg, #fef08a 0%, #fde047 100%);
            color: #92400e;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        /* 高亮动画效果 */
        @keyframes highlightPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .search-highlight {
            animation: highlightPulse 0.3s ease-in-out;
        }
        
        /* 悬停时的高亮效果 */
        .search-highlight:hover {
            background: linear-gradient(135deg, #fde047 0%, #fbbf24 100%);
            transform: scale(1.02);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* 搜索加载状态 */
        .search-loading {
            position: relative;
        }
        
        .search-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 40px;
            width: 16px;
            height: 16px;
            margin-top: -8px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #dc143c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* 去除所有输入框的默认黑色样式 */
        input[type="text"], 
        input[type="search"], 
        input[type="email"], 
        input[type="password"], 
        input[type="number"], 
        input[type="tel"], 
        input[type="url"], 
        textarea, 
        select {
            outline: none !important;
        }
        
        input[type="text"]:focus, 
        input[type="search"]:focus, 
        input[type="email"]:focus, 
        input[type="password"]:focus, 
        input[type="number"]:focus, 
        input[type="tel"]:focus, 
        input[type="url"]:focus, 
        textarea:focus, 
        select:focus {
            outline: none !important;
            border-color: #dc143c !important;
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1) !important;
        }
        

        
        /* 选择文本样式 */
        ::selection {
            background: rgba(220, 20, 60, 0.2);
            color: #DC143C;
        }
        
        /* 响应式优化 */
        @media (max-width: 768px) {
            .glass-effect {
                backdrop-filter: blur(5px);
            }
        }
        
        /* 模态框背景渐变 */
        .modal-gradient {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(249, 250, 251, 0.95));
            backdrop-filter: blur(10px);
        }
        
        /* 背景纹理 */
        .bg-pattern {
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.15) 3px, transparent 3px),
                radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.12) 2px, transparent 2px),
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.08) 1px, transparent 1px);
            background-size: 40px 40px, 25px 25px, 15px 15px;
            background-position: 0 0, 20px 20px, 8px 8px;
        }
        
        /* 装饰性几何图案 */
        .bg-geometric {
            background-image: 
                linear-gradient(45deg, rgba(255, 255, 255, 0.08) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(255, 255, 255, 0.08) 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, rgba(255, 255, 255, 0.08) 75%),
                linear-gradient(-45deg, transparent 75%, rgba(255, 255, 255, 0.08) 75%);
            background-size: 50px 50px;
            background-position: 0 0, 0 25px, 25px -25px, -25px 0px;
        }
        
        /* 波浪纹理 */
        .bg-waves {
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
            background-size: 80px 80px, 60px 60px, 40px 40px;
        }
        
        /* 资源更新动画 - 优化版 */
        @keyframes updateSuccess {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                opacity: 1;
            }
            25% {
                transform: scale(1.03);
                box-shadow: 0 0 25px rgba(34, 197, 94, 0.5);
                opacity: 0.9;
            }
            50% {
                transform: scale(1.01);
                box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
                opacity: 1;
            }
            75% {
                transform: scale(1.005);
                box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                opacity: 1;
            }
        }
        
        /* 更新成功高亮动画 */
        @keyframes updateHighlight {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }
        }
        
        /* 删除动画 */
        @keyframes deleteAnimation {
            0% {
                transform: scale(1);
                opacity: 1;
                max-height: 500px;
            }
            50% {
                transform: scale(0.95);
                opacity: 0.7;
                max-height: 250px;
            }
            100% {
                transform: scale(0.8);
                opacity: 0;
                max-height: 0;
                margin: 0;
                padding: 0;
            }
        }
        
        /* 添加动画 */
        @keyframes addAnimation {
            0% {
                transform: scale(0.8);
                opacity: 0;
                max-height: 0;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
                max-height: 250px;
            }
            100% {
                transform: scale(1);
                opacity: 1;
                max-height: 500px;
            }
        }
        
        /* 页面加载动画 */
        @keyframes pageLoad {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 卡片悬停动画优化 */
        @keyframes cardHover {
            0% {
                transform: translateY(0);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }
            100% {
                transform: translateY(-8px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.08);
            }
        }
        
        /* 按钮点击动画 */
        @keyframes buttonClick {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.95);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* 模态框动画优化 */
        @keyframes modalSlideIn {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(-30px);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.02) translateY(-5px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        /* 通知动画优化 */
        @keyframes notificationSlideIn {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }
            50% {
                transform: translateX(-10px);
                opacity: 0.8;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* 更新中的卡片样式 */
        .resource-card.updating {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .resource-card.updating::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #fbbf24, #f59e0b, #d97706);
            animation: loadingBar 1.5s ease-in-out infinite;
        }
        
        @keyframes loadingBar {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(0); }
            100% { transform: translateX(100%); }
        }
        
        /* 刚更新的卡片样式 */
        .resource-card.just-updated {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 更新成功的高亮效果 */
        .resource-card.update-highlight {
            animation: updateHighlight 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 删除动画类 */
        .resource-card.deleting {
            animation: deleteAnimation 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            pointer-events: none;
        }
        
        /* 添加动画类 */
        .resource-card.adding {
            animation: addAnimation 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        /* 页面加载动画 */
        .page-loading {
            animation: pageLoad 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 卡片悬停效果优化 */
        .resource-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .resource-card:hover {
            animation: cardHover 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        /* 按钮点击效果 */
        .btn-clickable:active {
            animation: buttonClick 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 模态框动画优化 */
        .modal-content {
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 通知动画优化 */
        .notification.show {
            animation: notificationSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 搜索框聚焦动画 */
        @keyframes searchFocus {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            100% {
                transform: scale(1.02);
                box-shadow: 0 4px 12px rgba(220, 20, 60, 0.15);
            }
        }
        
        #search-input:focus {
            animation: searchFocus 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            -webkit-animation: searchFocus 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        /* 加载状态动画优化 */
        @keyframes loadingPulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite, loadingPulse 2s ease-in-out infinite;
        }
        
        /* 分页按钮动画 */
        @keyframes paginationHover {
            0% {
                transform: translateY(0);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            100% {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            }
        }
        
        .pagination-item:hover {
            animation: paginationHover 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        /* 标签动画 */
        @keyframes tagHover {
            0% {
                transform: translateY(0) scale(1);
            }
            100% {
                transform: translateY(-2px) scale(1.05);
            }
        }
        
        .tag-item:hover {
            animation: tagHover 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        /* 统计卡片动画 */
        @keyframes statsCardHover {
            0% {
                transform: translateY(0) rotate(0deg);
            }
            100% {
                transform: translateY(-5px) rotate(1deg);
            }
        }
        
        .stats-card:hover {
            animation: statsCardHover 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        /* 存储使用卡片特殊样式 */
        [data-stat-card="storage"] {
            position: relative;
            overflow: hidden;
        }
        
        [data-stat-card="storage"]::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FF8C00);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        [data-stat-card="storage"]:hover::before {
            opacity: 1;
        }
        

        
        /* 状态指示器动画 - 只在需要时显示 */
        .status-indicator.pulse {
            animation: pulse 2s infinite;
        }
        
        .status-indicator.warning {
            animation: warningPulse 1.5s infinite;
        }
        
        .status-indicator.critical {
            animation: criticalPulse 1s infinite;
        }
        
        @keyframes warningPulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.2);
                opacity: 0.8;
            }
        }
        
        @keyframes criticalPulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.3);
                opacity: 0.7;
            }
        }
        
        /* 存储趋势变化动画 */
        #storage-trend {
            transition: all 0.3s ease;
        }
        
        #storage-trend.positive {
            color: #10b981 !important;
        }
        
        #storage-trend.negative {
            color: #ef4444 !important;
        }
        
        /* 统计卡片悬停效果增强 */
        [data-stat-card="storage"]:hover,
        [data-stat-card="overall"]:hover,
        [data-stat-card="category"]:hover,
        [data-stat-card="file"]:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        [data-stat-card="storage"]:hover .fa-hdd,
        [data-stat-card="overall"]:hover .fa-database,
        [data-stat-card="category"]:hover .fa-folder,
        [data-stat-card="file"]:hover .fa-file {
            transform: scale(1.1);
            transition: transform 0.3s ease;
        }
        
        /* 状态标签样式 */
        [data-stat-card="storage"] .bg-green-100,
        [data-stat-card="storage"] .bg-yellow-100,
        [data-stat-card="storage"] .bg-red-100,
        [data-stat-card="storage"] .bg-blue-100,
        [data-stat-card="overall"] .bg-blue-100,
        [data-stat-card="overall"] .bg-green-100,
        [data-stat-card="overall"] .bg-yellow-100,
        [data-stat-card="overall"] .bg-gray-100,
        [data-stat-card="category"] .bg-orange-100,
        [data-stat-card="category"] .bg-green-100,
        [data-stat-card="category"] .bg-yellow-100,
        [data-stat-card="category"] .bg-gray-100,
        [data-stat-card="file"] .bg-pink-100,
        [data-stat-card="file"] .bg-green-100,
        [data-stat-card="file"] .bg-yellow-100,
        [data-stat-card="file"] .bg-gray-100 {
            transition: all 0.3s ease;
        }
        

        
        /* 趋势指示器动画 - 根据状态动态显示 */
        .trend-arrow {
            transition: all 0.3s ease;
        }
        
        .trend-arrow.increasing {
            animation: bounceUp 1s infinite;
        }
        
        .trend-arrow.decreasing {
            animation: bounceDown 1s infinite;
        }
        
        .trend-arrow.stable {
            animation: none;
        }
        
        .trend-arrow.warning {
            animation: warningBounce 0.8s infinite;
        }
        
        @keyframes bounceUp {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-3px);
            }
            60% {
                transform: translateY(-1px);
            }
        }
        
        @keyframes bounceDown {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(3px);
            }
            60% {
                transform: translateY(1px);
            }
        }
        
        @keyframes warningBounce {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-2px) scale(1.1);
            }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-3px);
            }
            60% {
                transform: translateY(-1px);
            }
        }
        
        /* 存储详情模态框样式 */
        .storage-modal {
            backdrop-filter: blur(8px);
        }
        
        .storage-modal .modal-content {
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 左侧边栏样式 */
        .storage-sidebar {
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        /* 存储状态卡片悬停效果 */
        .storage-status-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .storage-status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* 快速操作按钮样式 */
        .quick-action-btn {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .quick-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }
        
        .quick-action-btn:hover::before {
            left: 100%;
        }
        
        .quick-action-btn:hover {
            transform: translateX(4px);
            background-color: #f3f4f6;
        }
        
        /* 统计卡片样式 */
        .stats-card {
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* 进度条动画 */
        .progress-bar {
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShine 2s infinite;
        }
        
        /* 响应式调整 */
        @media (max-width: 1024px) {
            .storage-modal .modal-content {
                flex-direction: column;
            }
            
            .storage-sidebar {
                width: 100% !important;
                border-right: none;
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            }
        }
        
        @media (max-width: 768px) {
            .storage-modal {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }
            
            .storage-sidebar {
                padding: 1rem;
            }
            
            .stats-card {
                padding: 1rem;
            }
        }
        
        /* 文件上传区域动画 */
        @keyframes uploadZoneHover {
            0% {
                transform: scale(1);
                border-color: #d1d5db;
            }
            100% {
                transform: scale(1.02);
                border-color: #DC143C;
            }
        }
        
        .file-upload-zone:hover {
            animation: uploadZoneHover 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        /* 拖拽状态动画 */
        @keyframes dragOver {
            0% {
                transform: scale(1);
                background-color: rgba(220, 20, 60, 0.05);
            }
            50% {
                transform: scale(1.03);
                background-color: rgba(220, 20, 60, 0.15);
            }
            100% {
                transform: scale(1.02);
                background-color: rgba(220, 20, 60, 0.1);
            }
        }
        
        .file-upload-zone.dragover {
            animation: dragOver 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
         
         /* 删除中的卡片样式 */
         .resource-card.deleting {
             pointer-events: none;
             position: relative;
         }
         
         .resource-card.deleting::before {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             bottom: 0;
             background: rgba(239, 68, 68, 0.1);
             border-radius: inherit;
             z-index: -1;
        }
        
        /* 网格纹理 */
        .bg-grid {
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.12) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.12) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        /* 按钮组样式 */
        .btn-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-group .btn {
            border-radius: 0.375rem;
        }
        
        .btn-group .btn:first-child {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .btn-group .btn:last-child {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        .btn-group .btn:not(:first-child):not(:last-child) {
            border-radius: 0;
        }
        
        /* 导航按钮悬停效果 */
        .nav-btn-hover {
            position: relative;
            overflow: hidden;
        }
        
        .nav-btn-hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .nav-btn-hover:hover::before {
            left: 100%;
        }
        
        .nav-btn-hover:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="min-h-screen bg-pattern" style="background: linear-gradient(135deg, #E75480 0%, #DB7093 100%);">
    <!-- 顶部导航 -->
    <header class="glass-effect shadow-lg sticky top-0 z-40" style="background: rgba(231, 84, 128, 0.9); backdrop-filter: blur(10px);">
        <div class="container mx-auto px-4 py-4">
            <!-- 桌面端导航 -->
            <div class="hidden md:flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fa fa-database text-gold text-3xl"></i>
                    <h1 class="text-2xl font-bold gradient-text">资源管理系统</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="export-btn" class="bg-gold text-primary px-4 py-2 rounded-lg hover:bg-yellow-400 btn-hover">
                        <i class="fa fa-download mr-2"></i>导出
                    </button>
                    <button id="import-btn" class="bg-white text-primary px-4 py-2 rounded-lg hover:bg-gray-100 btn-hover">
                        <i class="fa fa-upload mr-2"></i>导入
                    </button>
                    <button id="quick-menu-btn" class="text-white hover:text-gold btn-hover px-3 py-2 rounded-lg hover:bg-white/20 transition-all duration-200 nav-btn-hover">
                        <i class="fa fa-bars mr-2"></i>快速菜单
                    </button>

                </div>
            </div>
            
            <!-- 移动端导航 -->
            <div class="md:hidden">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <i class="fa fa-database text-gold text-2xl"></i>
                        <h1 class="text-lg font-bold gradient-text">资源管理系统</h1>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="mobile-menu-btn" class="text-white hover:text-gold transition-colors">
                            <i class="fa fa-bars text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 移动端菜单 -->
                <div id="mobile-menu" class="hidden mt-4 pt-4 border-t border-white/20">
                    <div class="grid grid-cols-2 gap-2">
                        <button id="mobile-export-btn" class="bg-gold text-primary px-3 py-2 rounded text-sm hover:bg-yellow-400 transition-colors">
                            <i class="fa fa-download mr-1"></i>导出
                        </button>
                        <button id="mobile-import-btn" class="bg-white text-primary px-3 py-2 rounded text-sm hover:bg-gray-100 transition-colors">
                            <i class="fa fa-upload mr-1"></i>导入
                        </button>
                        <button id="mobile-quick-menu-btn" class="bg-white/20 text-white px-3 py-2 rounded text-sm hover:bg-white/40 transition-all duration-200 hover:scale-105 nav-btn-hover">
                            <i class="fa fa-bars mr-1"></i>快速菜单
                        </button>

                    </div>
                </div>
            </div>
        </div>
    </header>

            <!-- 主要内容 -->
        <div class="container mx-auto px-4 py-8 relative">
            <!-- 装饰性背景元素 -->
            <div class="absolute inset-0 bg-waves opacity-50 pointer-events-none"></div>
            <div class="absolute top-20 left-10 w-32 h-32 bg-gradient-to-br from-white/15 to-transparent rounded-full blur-xl"></div>
            <div class="absolute bottom-20 right-10 w-40 h-40 bg-gradient-to-br from-white/15 to-transparent rounded-full blur-xl"></div>
            <div class="absolute top-1/2 left-1/4 w-24 h-24 bg-geometric opacity-20 pointer-events-none"></div>
            <div class="absolute bottom-1/3 right-1/4 w-20 h-20 bg-grid opacity-25 pointer-events-none"></div>
            <div class="relative z-10">
            <!-- 加载指示器 -->
            <div id="loading-indicator" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50">
                <div class="bg-white rounded-lg shadow-xl p-6 flex items-center space-x-4 glass-effect">
                    <div class="loading-spinner"></div>
                    <span class="text-gray-700 font-medium">正在加载...</span>
                </div>
            </div>
        <!-- 统计面板 -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-6 lg:mb-8">
            <div class="bg-white rounded-lg shadow-lg p-4 lg:p-6 border-l-4 border-primary card-hover cursor-pointer animate-fade-in bg-pattern" onclick="window.resourceManagerUI.showOverallStats()" data-stat-card="overall">
                <div class="flex items-center">
                    <div class="relative">
                    <i class="fa fa-database text-2xl lg:text-3xl text-primary mr-3 lg:mr-4"></i>
                        <!-- 状态指示器 -->
                        <div class="absolute -top-1 -right-1 w-3 h-3 bg-blue-400 rounded-full border-2 border-white shadow-sm status-indicator"></div>
                    </div>
                    <div class="min-w-0 flex-1">
                        <div class="flex items-center justify-between mb-1">
                        <h3 class="text-sm lg:text-lg font-semibold text-gray-800 truncate">资源使用概况</h3>
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium">活跃</span>
                        </div>
                        <div class="flex items-baseline space-x-2">
                        <p id="total-resources" class="text-xl lg:text-2xl font-bold text-primary">0</p>
                            <span class="text-xs text-gray-500">个资源</span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                        <p class="text-xs text-gray-500">点击查看详情</p>
                            <div class="flex items-center space-x-1">
                                <i class="fa fa-arrow-up text-xs text-blue-500 trend-arrow"></i>
                                <span class="text-xs text-blue-500 font-medium">正常</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-4 lg:p-6 border-l-4 border-secondary card-hover cursor-pointer animate-fade-in bg-pattern" style="animation-delay: 0.1s;" onclick="window.resourceManagerUI.showCategoryStats()" data-stat-card="category">
                <div class="flex items-center">
                    <div class="relative">
                    <i class="fa fa-folder text-2xl lg:text-3xl text-secondary mr-3 lg:mr-4"></i>
                        <!-- 状态指示器 -->
                        <div class="absolute -top-1 -right-1 w-3 h-3 bg-orange-400 rounded-full border-2 border-white shadow-sm status-indicator"></div>
                    </div>
                    <div class="min-w-0 flex-1">
                        <div class="flex items-center justify-between mb-1">
                        <h3 class="text-sm lg:text-lg font-semibold text-gray-800 truncate">分类使用情况</h3>
                            <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-medium">多样</span>
                        </div>
                        <div class="flex items-baseline space-x-2">
                        <p id="total-categories" class="text-xl lg:text-2xl font-bold text-secondary">0</p>
                            <span class="text-xs text-gray-500">个分类</span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                        <p class="text-xs text-gray-500">点击查看详情</p>
                            <div class="flex items-center space-x-1">
                                <i class="fa fa-arrow-up text-xs text-orange-500 trend-arrow"></i>
                                <span class="text-xs text-orange-500 font-medium">正常</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-4 lg:p-6 border-l-4 border-accent card-hover cursor-pointer animate-fade-in bg-pattern" style="animation-delay: 0.2s;" onclick="window.resourceManagerUI.showFileStats()" data-stat-card="file">
                <div class="flex items-center">
                    <div class="relative">
                    <i class="fa fa-file text-2xl lg:text-3xl text-accent mr-3 lg:mr-4"></i>
                        <!-- 状态指示器 -->
                        <div class="absolute -top-1 -right-1 w-3 h-3 bg-pink-400 rounded-full border-2 border-white shadow-sm status-indicator"></div>
                    </div>
                    <div class="min-w-0 flex-1">
                        <div class="flex items-center justify-between mb-1">
                        <h3 class="text-sm lg:text-lg font-semibold text-gray-800 truncate">使用的媒体文件</h3>
                            <span class="text-xs bg-pink-100 text-pink-700 px-2 py-1 rounded-full font-medium">丰富</span>
                        </div>
                        <div class="flex items-baseline space-x-2">
                        <p id="total-files" class="text-xl lg:text-2xl font-bold text-accent">0</p>
                            <span class="text-xs text-gray-500">个文件</span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                        <p class="text-xs text-gray-500">点击查看详情</p>
                            <div class="flex items-center space-x-1">
                                <i class="fa fa-arrow-up text-xs text-pink-500 trend-arrow"></i>
                                <span class="text-xs text-pink-500 font-medium">正常</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-4 lg:p-6 border-l-4 border-gold card-hover cursor-pointer animate-fade-in bg-pattern" style="animation-delay: 0.3s;" onclick="window.resourceManagerUI.showStorageStats()" data-stat-card="storage">
                <div class="flex items-center">
                    <div class="relative">
                    <i class="fa fa-hdd text-2xl lg:text-3xl text-gold mr-3 lg:mr-4"></i>
                        <!-- 存储状态指示器 -->
                        <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full border-2 border-white shadow-sm status-indicator"></div>
                    </div>
                    <div class="min-w-0 flex-1">
                        <div class="flex items-center justify-between mb-1">
                        <h3 class="text-sm lg:text-lg font-semibold text-gray-800 truncate">存储使用</h3>
                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-medium">正常</span>
                        </div>
                        <div class="flex items-baseline space-x-2">
                        <p id="total-size" class="text-xl lg:text-2xl font-bold text-gold">0 MB</p>
                            <span class="text-xs text-gray-500">已使用</span>
                        </div>
                        
                        <div class="flex justify-between items-center mt-2">
                        <p class="text-xs text-gray-500">点击查看详情</p>
                            <div class="flex items-center space-x-1">
                                <i class="fa fa-arrow-up text-xs text-green-500 trend-arrow"></i>
                                <span id="storage-trend" class="text-xs text-green-500 font-medium">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作工具栏 -->
        <div class="bg-white rounded-lg shadow-lg p-4 lg:p-6 mb-6 lg:mb-8 bg-pattern">
            <!-- 主要操作按钮和搜索功能 -->
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 lg:gap-6 mb-6 lg:mb-8">
                <!-- 左侧：主要操作按钮 -->
                <div class="flex flex-wrap items-center gap-3 lg:gap-4">
                <button id="add-resource-btn" class="bg-primary text-white px-3 lg:px-6 py-2 rounded-lg hover:bg-red-700 btn-hover text-sm lg:text-base transition-colors duration-200">
                    <i class="fa fa-plus mr-1 lg:mr-2"></i>添加资源
                </button>
                <button id="refresh-btn" class="bg-secondary text-white px-3 lg:px-6 py-2 rounded-lg hover:bg-orange-600 btn-hover text-sm lg:text-base transition-colors duration-200">
                    <i class="fa fa-sync mr-1 lg:mr-2"></i>刷新
                </button>
                <button id="batch-actions-btn" class="bg-blue-500 text-white px-3 lg:px-6 py-2 rounded-lg hover:bg-blue-600 btn-hover text-sm lg:text-base transition-colors duration-200">
                    <i class="fa fa-tasks mr-1 lg:mr-2"></i>批量操作
                </button>
                    <!-- 视图模式选择器 -->
                    <div class="relative group">
                        <button id="view-mode-btn" class="bg-green-500 text-white px-3 lg:px-6 py-2 rounded-lg hover:bg-green-600 btn-hover text-sm lg:text-base transition-colors duration-200 flex items-center">
                    <i class="fa fa-th-large mr-1 lg:mr-2"></i>视图模式
                            <i class="fa fa-chevron-down ml-1 lg:ml-2 text-xs transition-transform group-hover:rotate-180"></i>
                </button>
                        
                        <!-- 视图模式下拉菜单 -->
                        <div id="view-mode-dropdown" class="absolute top-full left-0 mt-2 bg-white rounded-lg shadow-xl border border-gray-200 py-2 min-w-48 z-50 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                            <div class="px-3 py-2 text-xs font-medium text-gray-500 border-b border-gray-100">选择视图模式</div>
                            
                            <button class="view-mode-option w-full px-4 py-3 text-left hover:bg-gray-50 transition-colors flex items-center" data-mode="grid">
                                <i class="fa fa-th-large mr-3 text-gray-400"></i>
                                <div>
                                    <div class="font-medium text-gray-800">网格视图</div>
                                    <div class="text-xs text-gray-500">卡片式布局，适合浏览</div>
            </div>
                                <i class="fa fa-check ml-auto text-green-500 hidden"></i>
                            </button>
                            
                            <button class="view-mode-option w-full px-4 py-3 text-left hover:bg-gray-50 transition-colors flex items-center" data-mode="list">
                                <i class="fa fa-list mr-3 text-gray-400"></i>
                                <div>
                                    <div class="font-medium text-gray-800">列表视图</div>
                                    <div class="text-xs text-gray-500">紧凑列表，信息密集</div>
                                </div>
                                <i class="fa fa-check ml-auto text-green-500 hidden"></i>
                            </button>
                            
                            <button class="view-mode-option w-full px-4 py-3 text-left hover:bg-gray-50 transition-colors flex items-center" data-mode="compact">
                                <i class="fa fa-th mr-3 text-gray-400"></i>
                                <div>
                                    <div class="font-medium text-gray-800">紧凑视图</div>
                                    <div class="text-xs text-gray-500">小卡片，显示更多项目</div>
                                </div>
                                <i class="fa fa-check ml-auto text-green-500 hidden"></i>
                            </button>
                            
                            <button class="view-mode-option w-full px-4 py-3 text-left hover:bg-gray-50 transition-colors flex items-center" data-mode="detail">
                                <i class="fa fa-file-alt mr-3 text-gray-400"></i>
                                <div>
                                    <div class="font-medium text-gray-800">详细视图</div>
                                    <div class="text-xs text-gray-500">完整信息，适合阅读</div>
                                </div>
                                <i class="fa fa-check ml-auto text-green-500 hidden"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 右侧：搜索功能 -->
                <div class="flex-1 lg:max-w-md search-container">
                    <!-- 搜索框 -->
                    <div class="relative">
                        <input type="text" id="search-input" 
                               class="w-full pl-12 pr-4 py-2 lg:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm lg:text-base transition-all duration-200"
                               placeholder="搜索资源标题、描述、标签或分类..."
                               autocomplete="off">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <i class="fa fa-search text-gray-400"></i>
                        </div>
                        <button id="clear-search-btn" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600 transition-colors hidden">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- 测试按钮 -->

                    
                    <!-- 搜索统计信息 -->
                    <div id="search-stats" class="mt-2 text-sm text-gray-500 hidden">
                        <span id="search-results-count">0</span> 个结果
                        <span id="search-time" class="ml-2"></span>
                    </div>
                    
                    <!-- 搜索过滤器 -->
                    <div id="search-filters" class="mt-2 flex flex-wrap gap-2 hidden">
                        <div class="text-sm text-gray-600 flex items-center">
                            <i class="fa fa-filter mr-1"></i>搜索范围：
                        </div>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="search-title" class="mr-1" checked>
                            标题
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="search-description" class="mr-1" checked>
                            描述
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="search-tags" class="mr-1" checked>
                            标签
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="search-category" class="mr-1" checked>
                            分类
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- 筛选选项 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-5">
                <select id="category-filter" class="px-3 lg:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm lg:text-base">
                    <option value="">所有分类</option>
                    <option value="traditionalFoods">传统美食</option>
                    <option value="traditionalCrafts">传统工艺</option>
                    <option value="traditionalOpera">传统戏曲</option>
                    <option value="traditionalFestivals">传统节日</option>
                    <option value="traditionalMedicine">传统医药</option>
                    <option value="traditionalArchitecture">传统建筑</option>
                </select>
                <select id="sort-by" class="px-3 lg:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm lg:text-base">
                    <option value="updatedAt">更新时间</option>
                    <option value="createdAt">创建时间</option>
                    <option value="title">标题</option>
                </select>
                <select id="sort-order" class="px-3 lg:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm lg:text-base">
                    <option value="desc">降序</option>
                    <option value="asc">升序</option>
                </select>
                <select id="page-size" class="px-3 lg:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm lg:text-base">
                    <option value="12">12项/页</option>
                    <option value="24">24项/页</option>
                    <option value="36">36项/页</option>
                    <option value="48">48项/页</option>
                </select>
            </div>
        </div>

        <!-- 资源列表 -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 lg:gap-7" id="resources-grid">
            <!-- 资源卡片将在这里动态生成 -->
        </div>

        <!-- 加载指示器 -->
        <div id="loading-indicator" class="hidden text-center py-8">
            <div class="inline-flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                <span class="ml-3 text-gray-600">加载中...</span>
            </div>
        </div>

        <!-- 空状态 -->
        <div id="empty-state" class="hidden text-center py-12 animate-fade-in">
            <i class="fa fa-database text-6xl text-gray-300 mb-4 float-animation"></i>
            <h3 class="text-xl font-semibold gradient-text mb-2">暂无资源</h3>
            <p class="text-gray-500 mb-6">开始添加您的第一个非遗文化资源吧！</p>
            <button id="add-first-resource" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-red-700 btn-hover transition-colors duration-200">
                <i class="fa fa-plus mr-2"></i>添加资源
            </button>
        </div>

        <!-- 分页控件 -->
        <div id="pagination" class="hidden mt-6 lg:mt-8 flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-6">
            <button id="prev-page" class="px-3 lg:px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 btn-hover disabled:opacity-50 disabled:cursor-not-allowed text-sm lg:text-base transition-colors duration-200">
                <i class="fa fa-chevron-left mr-1 lg:mr-2"></i>上一页
            </button>
            <div class="flex items-center space-x-2 lg:space-x-3 text-sm lg:text-base">
                <span class="text-gray-600">第</span>
                <span id="current-page" class="font-semibold text-primary">1</span>
                <span class="text-gray-600">页，共</span>
                <span id="total-pages" class="font-semibold text-primary">1</span>
                <span class="text-gray-600">页</span>
            </div>
            <button id="next-page" class="px-3 lg:px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 btn-hover disabled:opacity-50 disabled:cursor-not-allowed text-sm lg:text-base transition-colors duration-200">
                下一页<i class="fa fa-chevron-right ml-1 lg:ml-2"></i>
            </button>
        </div>

        <!-- 结果统计 -->
        <div id="results-info" class="hidden mt-4 text-center text-gray-600">
            <span id="results-count">显示 0 个结果</span>
            <span id="results-total" class="ml-2">(共 0 个资源)</span>
        </div>
            </div>
        </div>

    <!-- 回到顶部按钮 -->
    <button id="back-to-top" class="fixed bottom-8 right-8 bg-gradient-to-br from-primary via-primary-600 to-primary-700 text-white p-4 rounded-2xl shadow-2xl hover:shadow-3xl hover:scale-110 opacity-0 pointer-events-none z-50 transition-all duration-300 ease-out backdrop-blur-sm border border-gold/30 group">
        <div class="relative">
            <i class="fa fa-chevron-up text-xl group-hover:animate-bounce"></i>
            <div class="absolute -top-1 -right-1 w-2 h-2 bg-gold rounded-full animate-pulse"></div>
        </div>
        <!-- 悬停提示 -->
        <div class="absolute bottom-full right-0 mb-2 px-3 py-1 bg-primary text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap shadow-lg">
            回到顶部
            <div class="absolute top-full right-4 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-primary"></div>
        </div>
    </button>

    <!-- 添加资源模态框 -->
    <div id="resource-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] transition-all duration-300 backdrop-blur-sm">
        <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] flex flex-col transition-all duration-300 bg-pattern">
                <!-- 模态框头部 -->
                <div class="p-4 lg:p-6 border-b border-gray-200 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 id="modal-title" class="text-lg lg:text-2xl font-bold text-gray-800">添加资源</h2>
                        <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 模态框内容区域 -->
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- 分类选择指导 -->
                    <div id="category-guide" class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
                        <div class="flex items-start">
                            <i class="fa fa-lightbulb text-blue-500 mt-1 mr-3 text-lg"></i>
                            <div class="flex-1">
                                <h3 class="text-sm font-semibold text-blue-800 mb-2">选择资源类型</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 text-xs text-blue-700">
                                    <div class="flex items-center">
                                        <i class="fa fa-utensils mr-2 text-orange-500"></i>
                                        <span><strong>传统美食</strong>：地方特色菜系、传统小吃、烹饪技艺</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fa fa-hammer mr-2 text-purple-500"></i>
                                        <span><strong>传统工艺</strong>：手工技艺、民间艺术、制作工艺</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fa fa-mask mr-2 text-red-500"></i>
                                        <span><strong>传统戏曲</strong>：地方戏曲、表演艺术、音乐文化</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fa fa-calendar mr-2 text-green-500"></i>
                                        <span><strong>传统节日</strong>：节气文化、民俗活动、传统庆典</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fa fa-leaf mr-2 text-emerald-500"></i>
                                        <span><strong>传统医药</strong>：中药材、中医理论、养生文化</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fa fa-building mr-2 text-gray-500"></i>
                                        <span><strong>传统建筑</strong>：古建筑、建筑风格、建筑文化</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 动态操作指南 -->
                    <div id="dynamic-guide" class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
                        <div class="flex items-start">
                            <i class="fa fa-info-circle text-yellow-600 mt-1 mr-2"></i>
                            <div class="flex-1">
                                <h3 id="guide-title" class="text-sm font-semibold text-yellow-800 mb-1">填写指南</h3>
                                <div id="guide-content" class="text-xs text-yellow-700 space-y-1">
                                    <!-- 动态内容 -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <form id="resource-form" class="space-y-4">
                        <!-- 基本信息 -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fa fa-info-circle mr-2 text-primary"></i>
                                基本信息
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        资源标题 <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="resource-title" required placeholder="请输入资源标题"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">建议使用简洁明了的标题</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        资源类型 <span class="text-red-500">*</span>
                                    </label>
                                    <select id="resource-type" required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="">请选择资源类型</option>
                                        <option value="traditionalFoods">🍽️ 传统美食</option>
                                        <option value="traditionalCrafts">🔨 传统工艺</option>
                                        <option value="traditionalOpera">🎭 传统戏曲</option>
                                        <option value="traditionalFestivals">📅 传统节日</option>
                                        <option value="traditionalMedicine">🍃 传统医药</option>
                                        <option value="traditionalArchitecture">🏛️ 传统建筑</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">选择合适的分类</p>
                                </div>
                            </div>
                        </div>

                        <!-- 核心内容 -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fa fa-file-text mr-2 text-blue-600"></i>
                                核心内容
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        描述内容 <span class="text-red-500">*</span>
                                    </label>
                                    <textarea id="resource-content" rows="3" required placeholder="请详细描述这个传统文化资源的内容、特点等..."
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                    <p class="text-xs text-gray-500 mt-1">建议包含：基本介绍、主要特点、文化价值等信息</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        历史背景 <span class="text-xs text-gray-500">(可选)</span>
                                    </label>
                                    <textarea id="resource-history" rows="3" placeholder="描述该资源的历史发展、传承过程等..."
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                    <p class="text-xs text-gray-500 mt-1">可以补充该资源的历史渊源和文化背景</p>
                                </div>
                            </div>
                        </div>

                        <!-- 分类特定字段 -->
                        <div id="category-specific-fields" class="bg-green-50 p-4 rounded-lg hidden">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fa fa-cogs mr-2 text-green-600"></i>
                                专业信息
                            </h3>
                            
                            <!-- 传统美食特定字段 -->
                            <div id="foods-fields" class="category-fields hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            制作工艺 <span class="text-xs text-gray-500">(可选)</span>
                                        </label>
                                        <textarea id="foods-technique" rows="3" placeholder="描述制作方法、工艺流程等..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">制作步骤、关键技巧、注意事项</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            口感特色 <span class="text-xs text-gray-500">(可选)</span>
                                        </label>
                                        <textarea id="foods-features" rows="3" placeholder="描述口感、风味特点等..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">口感、味道、外观特色</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 传统工艺特定字段 -->
                            <div id="crafts-fields" class="category-fields hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            制作技艺 <span class="text-xs text-gray-500">(可选)</span>
                                        </label>
                                        <textarea id="crafts-technique" rows="3" placeholder="描述制作工艺、技术要点等..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">制作方法、技术难点、工艺特色</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            艺术特色 <span class="text-xs text-gray-500">(可选)</span>
                                        </label>
                                        <textarea id="crafts-features" rows="3" placeholder="描述艺术风格、审美特色等..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">艺术风格、审美价值、文化内涵</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 传统戏曲特定字段 -->
                            <div id="opera-fields" class="category-fields hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            表演技巧 <span class="text-xs text-gray-500">(可选)</span>
                                        </label>
                                        <textarea id="opera-technique" rows="3" placeholder="描述表演方法、唱腔特色等..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">唱腔、身段、表演技巧</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            艺术特色 <span class="text-xs text-gray-500">(可选)</span>
                                        </label>
                                        <textarea id="opera-features" rows="3" placeholder="描述艺术风格、表演特色等..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">艺术风格、表演特色、文化价值</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 传统节日特定字段 -->
                            <div id="festivals-fields" class="category-fields hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            养生方法 <span class="text-xs text-gray-500">(可选)</span>
                                        </label>
                                        <textarea id="festivals-technique" rows="3" placeholder="描述节气养生、生活建议等..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">养生建议、生活指导、健康提示</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            气候特征 <span class="text-xs text-gray-500">(可选)</span>
                                        </label>
                                        <textarea id="festivals-features" rows="3" placeholder="描述节气特点、气候特征等..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">气候特点、自然现象、环境变化</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 传统医药特定字段 -->
                            <div id="medicine-fields" class="category-fields hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            采集炮制 <span class="text-xs text-gray-500">(可选)</span>
                                        </label>
                                        <textarea id="medicine-technique" rows="3" placeholder="描述采集方法、炮制工艺等..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">采集时间、炮制方法、质量要求</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            功效特点 <span class="text-xs text-gray-500">(可选)</span>
                                        </label>
                                        <textarea id="medicine-features" rows="3" placeholder="描述功效作用、应用特点等..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">功效作用、适应症、使用注意</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 传统建筑特定字段 -->
                            <div id="architecture-fields" class="category-fields hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            地理位置 <span class="text-xs text-gray-500">(可选)</span>
                                        </label>
                                        <textarea id="architecture-location" rows="3" placeholder="描述建筑位置、地理环境等..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">地理位置、环境特点、交通信息</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            建筑技术 <span class="text-xs text-gray-500">(可选)</span>
                                        </label>
                                        <textarea id="architecture-technique" rows="3" placeholder="描述建筑技术、结构特点等..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">建筑技术、结构特色、材料工艺</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            建筑特色 <span class="text-xs text-gray-500">(可选)</span>
                                        </label>
                                        <textarea id="architecture-features" rows="3" placeholder="描述建筑风格、艺术特色等..."
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">建筑风格、艺术特色、文化价值</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 通用信息 -->
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fa fa-tags mr-2 text-purple-600"></i>
                                分类标签
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        关键词 <span class="text-xs text-gray-500">(可选)</span>
                                    </label>
                                    <input type="text" id="resource-keywords" placeholder="例如：传统,手工,文化,传承"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">用英文逗号分隔</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        标签 <span class="text-xs text-gray-500">(可选)</span>
                                    </label>
                                    <input type="text" id="resource-tags" placeholder="例如：非遗,传统,手工,文化"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">用英文逗号分隔</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        图标 <span class="text-xs text-gray-500">(可选)</span>
                                    </label>
                                    <select id="resource-icon"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="">选择图标</option>
                                        <option value="fa-utensils">🍽️ 餐具 (美食)</option>
                                        <option value="fa-fire">🔥 火焰 (工艺)</option>
                                        <option value="fa-gem">💎 宝石 (工艺)</option>
                                        <option value="fa-mask">🎭 面具 (戏曲)</option>
                                        <option value="fa-calendar">📅 日历 (节日)</option>
                                        <option value="fa-leaf">🍃 叶子 (医药)</option>
                                        <option value="fa-building">🏛️ 建筑 (建筑)</option>
                                        <option value="fa-fish">🐟 鱼 (美食)</option>
                                        <option value="fa-hammer">🔨 锤子 (工艺)</option>
                                        <option value="fa-music">🎵 音乐 (戏曲)</option>
                                        <option value="fa-moon">🌙 月亮 (节日)</option>
                                        <option value="fa-seedling">🌱 幼苗 (医药)</option>
                                        <option value="fa-home">🏠 房屋 (建筑)</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">选择合适的图标</p>
                                </div>
                            </div>
                        </div>

                        <!-- 有趣小知识 -->
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fa fa-lightbulb mr-2 text-orange-600"></i>
                                有趣小知识
                            </h3>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    小知识 <span class="text-xs text-gray-500">(可选)</span>
                                </label>
                                <textarea id="resource-funFact" rows="3" placeholder="分享一些有趣的历史故事、文化典故或小知识..."
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                <p class="text-xs text-gray-500 mt-1">有趣的历史故事、文化典故、小知识等</p>
                            </div>
                        </div>
                        

                        
                        <!-- 媒体文件 -->
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fa fa-image mr-2 text-indigo-600"></i>
                                媒体文件
                            </h3>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    媒体文件 <span class="text-xs text-gray-500">(可选)</span>
                                </label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-primary transition-colors">
                                    <input type="file" id="file-upload" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt" class="hidden">
                                    <div class="space-y-3">
                                        <i class="fa fa-cloud-upload-alt text-3xl text-gray-400"></i>
                                        <div>
                                            <p class="text-sm text-gray-600 font-medium">📁 点击选择文件或拖拽文件到此处</p>
                                            <p class="text-xs text-gray-500 mt-1">✅ 支持多文件上传，最多10个文件，单个文件最大50MB</p>
                                            <p class="text-xs text-gray-400 mt-1">📋 支持格式：图片(JPG/PNG/GIF)、视频(MP4/AVI/MOV)、音频(MP3/WAV)、文档(PDF/DOC)</p>
                                        </div>
                                        <button type="button" id="select-files" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
                                            <i class="fa fa-plus mr-2"></i>选择多个文件
                                        </button>
                                    </div>
                                </div>
                                <div id="file-list" class="mt-3 space-y-2">
                                    <!-- 文件列表将在这里显示 -->
                                </div>
                                <div class="mt-2 text-xs text-gray-500">
                                    <i class="fa fa-info-circle mr-1"></i>
                                    💡 提示：可以同时选择多个文件，支持拖拽上传，文件会在详情页面显示
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- 模态框底部 -->
                <div class="p-6 border-t border-gray-200 flex-shrink-0">
                    <!-- 保存提示 -->
                    <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <i class="fa fa-check-circle text-green-500 mr-2"></i>
                            <span class="text-sm text-green-700">填写完成后，点击"保存资源"按钮即可完成添加</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4">
                        <button id="cancel-resource" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 btn-hover transition-colors duration-200">
                            <i class="fa fa-times mr-2"></i>取消
                        </button>
                        <button id="save-resource" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-red-700 btn-hover transition-colors duration-200">
                            <i class="fa fa-save mr-2"></i>保存资源
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知 -->
    <div id="notification" class="fixed top-4 right-4 bg-white border border-gray-200 rounded-lg shadow-lg p-4 transform translate-x-full opacity-0 transition-all duration-300 z-50 glass-effect pointer-events-none">
        <div class="flex items-center">
            <i id="notification-icon" class="fa fa-info-circle text-primary mr-2"></i>
            <span id="notification-message" class="text-gray-700"></span>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] transition-all duration-300 backdrop-blur-sm">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div class="bg-red-100 rounded-full p-3 mr-4">
                            <i class="fa fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">确认删除</h3>
                            <p class="text-sm text-gray-600">此操作无法撤销</p>
                        </div>
                    </div>
                    <p id="delete-confirm-message" class="text-gray-700 mb-6">您确定要删除这个资源吗？</p>
                    <div class="flex justify-end space-x-3">
                        <button id="delete-cancel" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 btn-hover transition-colors duration-200">
                            取消
                        </button>
                        <button id="delete-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 btn-hover transition-colors duration-200">
                            <i class="fa fa-trash mr-2"></i>确认删除
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入脚本 -->
    <script type="module">

        class SimpleResourceManagerUI {
            constructor() {
                this.manager = null;
                this.currentResource = null;
                this.isEditing = false;
                this.currentPage = 1;
                this.pageSize = 12; // 默认每页显示12个资源
                this.currentFilters = {
                    category: '',
                    sortBy: 'updatedAt',
                    sortOrder: 'desc'
                };
                this.pagination = {
                    currentPage: 1,
                    totalPages: 1,
                    totalItems: 0,
                    itemsPerPage: 12
                };
                this.resourceServerConfig = {
                    baseUrl: '/api/resources', // 通过主服务器代理到资源服务器
                    endpoints: {
                        loadAll: '/load-all',
                        statistics: '/stats',
                        category: '/category',
                        batch: '/batch',
                        searchAll: '/search-all', // 添加搜索端点
                        resources: '/load-all' // 添加资源端点，使用load-all作为获取所有资源的端点
                    }
                };
                this.init();
            }

            // 生成唯一ID
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            // 获取选中的资源
            getSelectedResources() {
                const selectedResources = [];
                const checkboxes = document.querySelectorAll('.resource-checkbox:checked');
                
                checkboxes.forEach(checkbox => {
                    const resourceCard = checkbox.closest('.resource-card');
                    if (resourceCard) {
                        const category = checkbox.getAttribute('data-category');
                        const id = checkbox.getAttribute('data-id');
                        const title = resourceCard.querySelector('.resource-title, h3, .card-title')?.textContent || '未命名';
                        
                        selectedResources.push({
                            category,
                            id,
                            title,
                            element: resourceCard
                        });
                    }
                });
                
                return selectedResources;
            }

            async init() {
                try {
                    // 检查资源服务器连接状态并获取初始数据
                    await this.checkResourceServerStatus();
                    
                    this.bindEvents();
                    // 注入统一的按钮选中/按压视觉样式与交互
                    this.injectButtonSelectionStyles();
                    this.bindGlobalButtonSelectionHandlers();
                    this.setupScrollListener(); // 设置滚动监听器
                    
                    // 初始化视图模式
                    this.initViewMode();
                    
                    // 启动连接监控
                    this.startConnectionMonitoring();
                    
                    // 启动性能优化系统
                    this.initializePerformanceOptimizer();
                    
                    console.log('简化资源管理器UI初始化完成');
                } catch (error) {
                    console.error('初始化失败:', error);
                    this.showNotification('初始化失败: ' + error.message, 'error');
                }
            }

            // 检查资源服务器状态并初始化数据
            async checkResourceServerStatus() {
                try {
                    // 并行获取统计信息和资源数据，减少API调用次数
                    const [statsData, resourcesData] = await Promise.all([
                        this.getStatistics(),
                        this.loadResourcesWithPagination(1, 12, { 
                            sortBy: 'updatedAt', 
                            sortOrder: 'desc',
                            preload: true 
                        })
                    ]);
                    
                    console.log('资源服务器连接正常，总资源数:', statsData.statistics.totalResources);
                    
                    // 更新统计信息UI
                    await this.updateStatisticsUI(statsData.statistics);
                    
                    // 渲染资源列表
                    await this.renderResourcesFromData(resourcesData);
                    
                } catch (error) {
                    console.error('资源服务器连接检查失败:', error);
                    this.showNotification('资源服务器连接失败，请检查服务状态', 'error');
                    throw error;
                }
            }

            // 性能优化系统
            performanceOptimizer = {
                // 多级缓存系统
                cache: {
                    // 内存缓存
                    memory: new Map(),
                    // 本地存储缓存
                    localStorage: new Map(),
                    // 缓存配置
                    config: {
                        memoryTTL: 30000, // 30秒内存缓存
                        localStorageTTL: 300000, // 5分钟本地存储缓存
                        maxMemorySize: 100, // 最大内存缓存条目数
                        maxLocalStorageSize: 50 // 最大本地存储缓存条目数
                    }
                },

                // 请求队列管理
                requestQueue: {
                    pending: new Map(),
                    processing: new Set(),
                    maxConcurrent: 2, // 减少最大并发请求数（从3减少到2）
                    retryAttempts: 2, // 减少重试次数（从3减少到2）
                    retryDelay: 2000 // 增加重试延迟（从1000增加到2000毫秒）
                },

                // 数据预加载系统
                preloader: {
                    queue: [],
                    isPreloading: false,
                    preloadDistance: 2, // 预加载距离（页数）
                    preloadDelay: 500 // 预加载延迟
                },

                // 虚拟滚动优化
                virtualScroll: {
                    itemHeight: 120, // 每个资源卡片的高度
                    visibleItems: 10, // 可见项目数
                    bufferSize: 5 // 缓冲区大小
                }
            };

            // 智能缓存管理
            async getCachedData(key, fetchFunction, options = {}) {
                const { useLocalStorage = true, ttl = this.performanceOptimizer.cache.config.memoryTTL } = options;
                
                // 检查内存缓存
                const memoryCache = this.performanceOptimizer.cache.memory.get(key);
                if (memoryCache && Date.now() - memoryCache.timestamp < ttl) {
                    console.log(`使用内存缓存: ${key}`);
                    return memoryCache.data;
                }

                // 检查本地存储缓存
                if (useLocalStorage) {
                    try {
                        const localStorageKey = `cache_${key}`;
                        const stored = localStorage.getItem(localStorageKey);
                        if (stored) {
                            const parsed = JSON.parse(stored);
                            if (Date.now() - parsed.timestamp < this.performanceOptimizer.cache.config.localStorageTTL) {
                                console.log(`使用本地存储缓存: ${key}`);
                                // 更新内存缓存
                                this.setCacheData(key, parsed.data, { useLocalStorage: false });
                                return parsed.data;
                            }
                        }
                    } catch (error) {
                        console.warn('本地存储缓存读取失败:', error);
                    }
                }

                // 获取新数据
                const data = await fetchFunction();
                
                // 缓存数据
                this.setCacheData(key, data, options);
                
                return data;
            }

            // 设置缓存数据
            setCacheData(key, data, options = {}) {
                const { useLocalStorage = true } = options;
                
                // 设置内存缓存
                const memoryCache = {
                    data,
                    timestamp: Date.now()
                };
                
                // 清理过期缓存
                this.cleanupCache();
                
                // 检查缓存大小限制
                if (this.performanceOptimizer.cache.memory.size >= this.performanceOptimizer.cache.config.maxMemorySize) {
                    // 删除最旧的缓存
                    const oldestKey = this.performanceOptimizer.cache.memory.keys().next().value;
                    this.performanceOptimizer.cache.memory.delete(oldestKey);
                }
                
                this.performanceOptimizer.cache.memory.set(key, memoryCache);

                // 设置本地存储缓存
                if (useLocalStorage) {
                    try {
                        const localStorageKey = `cache_${key}`;
                        const storedData = {
                            data,
                            timestamp: Date.now()
                        };
                        
                        // 检查本地存储大小限制
                        const keys = Object.keys(localStorage).filter(k => k.startsWith('cache_'));
                        if (keys.length >= this.performanceOptimizer.cache.config.maxLocalStorageSize) {
                            // 删除最旧的缓存
                            const oldestKey = keys.sort((a, b) => {
                                const aData = JSON.parse(localStorage.getItem(a) || '{}');
                                const bData = JSON.parse(localStorage.getItem(b) || '{}');
                                return aData.timestamp - bData.timestamp;
                            })[0];
                            localStorage.removeItem(oldestKey);
                        }
                        
                        localStorage.setItem(localStorageKey, JSON.stringify(storedData));
                    } catch (error) {
                        console.warn('本地存储缓存设置失败:', error);
                    }
                }
            }

            // 清理过期缓存
            cleanupCache() {
                const now = Date.now();
                
                // 清理内存缓存
                for (const [key, value] of this.performanceOptimizer.cache.memory.entries()) {
                    if (now - value.timestamp > this.performanceOptimizer.cache.config.memoryTTL) {
                        this.performanceOptimizer.cache.memory.delete(key);
                    }
                }
                
                // 清理本地存储缓存
                try {
                    const keys = Object.keys(localStorage).filter(k => k.startsWith('cache_'));
                    for (const key of keys) {
                        const stored = localStorage.getItem(key);
                        if (stored) {
                            const parsed = JSON.parse(stored);
                            if (now - parsed.timestamp > this.performanceOptimizer.cache.config.localStorageTTL) {
                                localStorage.removeItem(key);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('本地存储缓存清理失败:', error);
                }
            }

            // 智能请求队列管理
            async queueRequest(requestId, requestFunction) {
                // 如果请求已在处理中，返回现有Promise
                if (this.performanceOptimizer.requestQueue.processing.has(requestId)) {
                    return this.performanceOptimizer.requestQueue.pending.get(requestId);
                }

                // 如果队列已满，等待
                if (this.performanceOptimizer.requestQueue.processing.size >= this.performanceOptimizer.requestQueue.maxConcurrent) {
                    await new Promise(resolve => {
                        const checkQueue = () => {
                            if (this.performanceOptimizer.requestQueue.processing.size < this.performanceOptimizer.requestQueue.maxConcurrent) {
                                resolve();
                            } else {
                                setTimeout(checkQueue, 100);
                            }
                        };
                        checkQueue();
                    });
                }

                // 创建请求Promise
                const requestPromise = this.executeRequestWithRetry(requestFunction);
                
                // 添加到队列
                this.performanceOptimizer.requestQueue.pending.set(requestId, requestPromise);
                this.performanceOptimizer.requestQueue.processing.add(requestId);

                try {
                    const result = await requestPromise;
                    return result;
                } finally {
                    // 清理队列
                    this.performanceOptimizer.requestQueue.pending.delete(requestId);
                    this.performanceOptimizer.requestQueue.processing.delete(requestId);
                }
            }

            // 带重试的请求执行
            async executeRequestWithRetry(requestFunction, attempts = 0) {
                try {
                    // 添加请求间隔，避免过于频繁的请求
                    if (attempts > 0) {
                        const delay = Math.min(1000 * Math.pow(2, attempts), 5000); // 指数退避，最大5秒
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                    
                    return await requestFunction();
                } catch (error) {
                    // 如果是429错误，增加更长的延迟
                    if (error.message && error.message.includes('429')) {
                        const delay = Math.min(3000 * Math.pow(2, attempts), 10000); // 429错误使用更长的延迟
                        console.warn(`请求频率限制，${delay}ms后重试 (${attempts + 1}/${this.performanceOptimizer.requestQueue.retryAttempts})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else if (attempts < this.performanceOptimizer.requestQueue.retryAttempts) {
                        console.warn(`请求失败，${this.performanceOptimizer.requestQueue.retryDelay}ms后重试 (${attempts + 1}/${this.performanceOptimizer.requestQueue.retryAttempts})`);
                        await new Promise(resolve => setTimeout(resolve, this.performanceOptimizer.requestQueue.retryDelay * (attempts + 1)));
                    } else {
                        throw error;
                    }
                    
                    if (attempts < this.performanceOptimizer.requestQueue.retryAttempts) {
                        return this.executeRequestWithRetry(requestFunction, attempts + 1);
                    }
                    throw error;
                }
            }

            // 数据预加载系统
            async preloadData(currentPage, totalPages, fetchFunction) {
                if (this.performanceOptimizer.preloader.isPreloading) return;
                
                this.performanceOptimizer.preloader.isPreloading = true;
                
                try {
                    const preloadPages = [];
                    
                    // 计算需要预加载的页面
                    for (let i = 1; i <= this.performanceOptimizer.preloader.preloadDistance; i++) {
                        if (currentPage + i <= totalPages) {
                            preloadPages.push(currentPage + i);
                        }
                        if (currentPage - i >= 1) {
                            preloadPages.push(currentPage - i);
                        }
                    }

                    // 异步预加载
                    const preloadPromises = preloadPages.map(page => 
                        this.getCachedData(`page_${page}`, () => fetchFunction(page), { ttl: 60000 })
                    );

                    await Promise.allSettled(preloadPromises);
                    console.log(`预加载完成: 页面 ${preloadPages.join(', ')}`);
                    
                } catch (error) {
                    console.warn('预加载失败:', error);
                } finally {
                    this.performanceOptimizer.preloader.isPreloading = false;
                }
            }

            // 虚拟滚动优化
            calculateVisibleRange(scrollTop, containerHeight) {
                const startIndex = Math.floor(scrollTop / this.performanceOptimizer.virtualScroll.itemHeight);
                const visibleCount = Math.ceil(containerHeight / this.performanceOptimizer.virtualScroll.itemHeight);
                
                const start = Math.max(0, startIndex - this.performanceOptimizer.virtualScroll.bufferSize);
                const end = Math.min(this.resources.length, startIndex + visibleCount + this.performanceOptimizer.virtualScroll.bufferSize);
                
                return { start, end, visibleStart: startIndex, visibleEnd: startIndex + visibleCount };
            }

            // 统一的API调用方法（带缓存和防抖）
            async callResourceAPI(endpoint, options = {}) {
                const url = `${this.resourceServerConfig.baseUrl}${endpoint}`;
                const requestId = `${options.method || 'GET'}_${url}_${Date.now()}`;
                
                return this.queueRequest(requestId, async () => {
                    return this.getCachedData(
                        `${options.method || 'GET'}_${url}`,
                        async () => {
                const defaultOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                };

                const finalOptions = { ...defaultOptions, ...options };
                
                    console.log(`调用资源API: ${url}`, finalOptions);
                    const response = await fetch(url, finalOptions);
                    
                    if (!response.ok) {
                        throw new Error(`API调用失败: HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || 'API响应异常');
                    }
                    
                            return data;
                        },
                        { 
                            ttl: options.method === 'GET' ? 30000 : 0, // GET请求缓存30秒
                            useLocalStorage: options.method === 'GET' // 仅GET请求使用本地存储
                        }
                    );
                });
            }

            // 清理API缓存
            clearApiCache() {
                this.performanceOptimizer.cache.memory.clear();
                console.log('API缓存已清理');
            }

            // 验证资源是否已删除
            async verifyResourceDeleted(category, id) {
                try {
                    const data = await this.getResources({ category, limit: 1000 });
                    const categoryResources = data.resources[category];
                    const resource = categoryResources?.[id];
                    
                    if (resource) {
                        console.warn(`资源 ${category}/${id} 仍然存在，删除可能失败`);
                        return false;
                    } else {
                        console.log(`资源 ${category}/${id} 已成功删除`);
                        return true;
                    }
                } catch (error) {
                    console.error('验证资源删除状态失败:', error);
                    return false;
                }
            }

            // 获取资源数据（优化版本）
            async getResources(params = {}) {
                const queryString = new URLSearchParams(params).toString();
                const endpoint = `${this.resourceServerConfig.endpoints.loadAll}?${queryString}`;
                
                // 使用智能缓存和队列管理
                return await this.callResourceAPI(endpoint);
            }

            // 分页加载资源（带预加载）
            async loadResourcesWithPagination(page = 1, limit = 12, options = {}) {
                const { category, sortBy = 'updatedAt', sortOrder = 'desc', preload = true } = options;
                
                const params = {
                    page,
                    limit,
                    sortBy,
                    sortOrder,
                    ...(category && { category })
                };

                try {
                    // 加载当前页面数据
                    const data = await this.getResources(params);
                    
                    // 如果启用预加载且有分页信息
                    if (preload && data.pagination) {
                        const { currentPage, totalPages } = data.pagination;
                        
                        // 异步预加载相邻页面
                        setTimeout(() => {
                            this.preloadData(currentPage, totalPages, (pageNum) => 
                                this.getResources({ ...params, page: pageNum })
                            );
                        }, this.performanceOptimizer.preloader.preloadDelay);
                    }
                    
                    return data;
                } catch (error) {
                    console.error('分页加载资源失败:', error);
                    throw error;
                }
            }

            // 批量预加载资源
            async preloadResources(categories = [], pages = 3) {
                const preloadPromises = [];
                
                // 预加载所有分类的前几页
                for (const category of categories) {
                    for (let page = 1; page <= pages; page++) {
                        preloadPromises.push(
                            this.getCachedData(
                                `resources_${category}_${page}`,
                                () => this.getResources({ category, page, limit: 12 }),
                                { ttl: 120000 } // 2分钟缓存
                            )
                        );
                    }
                }
                
                // 预加载总体资源
                for (let page = 1; page <= pages; page++) {
                    preloadPromises.push(
                        this.getCachedData(
                            `resources_all_${page}`,
                            () => this.getResources({ page, limit: 12 }),
                            { ttl: 120000 }
                        )
                    );
                }
                
                try {
                    await Promise.allSettled(preloadPromises);
                    console.log('批量预加载完成');
                } catch (error) {
                    console.warn('批量预加载失败:', error);
                }
            }

            // 获取统计信息（兼容不同字段名：statistics/stats）
            async getStatistics() {
                try {
                const data = await this.callResourceAPI(this.resourceServerConfig.endpoints.statistics);
                const statistics = (data && (data.statistics || data.stats)) || {};
                    
                    // 确保统计数据包含必要的字段
                    if (!statistics.totalResources) statistics.totalResources = 0;
                    if (!statistics.totalCategories) statistics.totalCategories = 0;
                    if (!statistics.totalMedia) statistics.totalMedia = 0;
                    if (!statistics.totalFileSize) statistics.totalFileSize = 0;
                    if (!statistics.categories) statistics.categories = {};
                    if (!statistics.fileTypes) statistics.fileTypes = {};
                    if (!statistics.mediaFiles) statistics.mediaFiles = { images: 0, videos: 0, audio: 0, documents: 0 };
                    
                return { success: true, statistics };
                } catch (error) {
                    console.error('获取统计信息失败:', error);
                    // 返回默认统计信息
                    return {
                        success: true,
                        statistics: {
                            totalResources: 0,
                            totalCategories: 0,
                            totalMedia: 0,
                            totalFileSize: 0,
                            categories: {},
                            fileTypes: {},
                            mediaFiles: { images: 0, videos: 0, audio: 0, documents: 0 }
                        }
                    };
                }
            }

            // 批量操作
            async batchOperation(action, resources, options = {}) {
                const endpoint = this.resourceServerConfig.endpoints.batch;
                const body = { action, resources, options };
                return await this.callResourceAPI(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(body)
                });
            }

            // 初始化性能优化系统
            initializePerformanceOptimizer() {
                // 定期清理过期缓存
                setInterval(() => {
                    this.cleanupCache();
                }, 30000); // 每30秒清理一次

                // 预加载常用数据
                setTimeout(() => {
                    this.preloadCommonData();
                }, 2000); // 2秒后开始预加载

                console.log('性能优化系统已启动');
            }

            // 预加载常用数据
            async preloadCommonData() {
                try {
                    // 预加载统计信息
                    await this.getCachedData('statistics', () => this.getStatistics(), { ttl: 60000 });
                    
                    // 预加载前几页资源
                    await this.preloadResources([], 2);
                    
                    console.log('常用数据预加载完成');
                } catch (error) {
                    console.warn('预加载常用数据失败:', error);
                }
            }

            // 监控资源服务器连接状态
            startConnectionMonitoring() {
                // 每60秒检查一次连接状态（减少频率）
                setInterval(async () => {
                    try {
                        await this.getStatistics();
                        console.log('资源服务器连接正常');
                    } catch (error) {
                        console.warn('资源服务器连接异常:', error.message);
                        this.showNotification('资源服务器连接异常，请检查服务状态', 'warning');
                    }
                }, 60000); // 60秒
            }

            // 获取资源服务器状态信息
            async getServerStatus() {
                try {
                    const data = await this.getStatistics();
                    return {
                        connected: true,
                        totalResources: data.statistics.totalResources,
                        totalCategories: data.statistics.totalCategories,
                        lastCheck: new Date().toISOString()
                    };
                } catch (error) {
                    return {
                        connected: false,
                        error: error.message,
                        lastCheck: new Date().toISOString()
                    };
                }
            }

            // 获取性能优化系统状态
            getPerformanceStatus() {
                return {
                    cache: {
                        memorySize: this.performanceOptimizer.cache.memory.size,
                        memoryTTL: this.performanceOptimizer.cache.config.memoryTTL,
                        localStorageSize: Object.keys(localStorage).filter(k => k.startsWith('cache_')).length
                    },
                    requestQueue: {
                        pending: this.performanceOptimizer.requestQueue.pending.size,
                        processing: this.performanceOptimizer.requestQueue.processing.size,
                        maxConcurrent: this.performanceOptimizer.requestQueue.maxConcurrent
                    },
                    preloader: {
                        isPreloading: this.performanceOptimizer.preloader.isPreloading,
                        queueLength: this.performanceOptimizer.preloader.queue.length
                    }
                };
            }

            // 性能优化建议
            getPerformanceRecommendations() {
                const status = this.getPerformanceStatus();
                const recommendations = [];

                if (status.cache.memorySize > 80) {
                    recommendations.push('内存缓存接近上限，建议清理或增加缓存大小');
                }

                if (status.requestQueue.pending.size > 5) {
                    recommendations.push('请求队列积压较多，建议检查网络连接或减少并发请求');
                }

                if (status.cache.localStorageSize > 40) {
                    recommendations.push('本地存储缓存较多，建议清理过期缓存');
                }

                return recommendations;
            }

            // 注入统一按钮样式（选中/按压/悬停/聚焦）
            injectButtonSelectionStyles() {
                const styleId = 'sr-btn-selection-styles';
                if (document.getElementById(styleId)) return;
                const style = document.createElement('style');
                style.id = styleId;
                style.textContent = `
                /* 基础按钮交互优化 */
                button, .btn, .btn-hover {
                    transition: background-color 160ms ease, color 160ms ease, box-shadow 160ms ease, transform 120ms ease;
                }
                button:hover, .btn-hover:hover {
                    filter: brightness(0.98);
                }
                button:active, .btn-hover:active {
                    transform: translateY(1px) scale(0.99);
                    filter: brightness(0.96);
                }
                button:focus-visible, .btn-hover:focus-visible {
                    outline: none;
                    box-shadow: 0 0 0 3px rgba(59,130,246,0.35); /* primary focus ring */
                }
                /* 选中态 */
                .btn-selected, [aria-pressed="true"], .is-selected {
                    background-image: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(59,130,246,0.08));
                    border-color: rgba(59,130,246,0.35) !important;
                    color: #1f2937 !important; /* gray-800 */
                    box-shadow: 0 4px 12px rgba(59,130,246,0.15);
                }
                .btn-selected:hover, [aria-pressed="true"]:hover, .is-selected:hover {
                    background-image: linear-gradient(135deg, rgba(239,68,68,0.12), rgba(59,130,246,0.12));
                }
                /* 轻量级徽标类按钮的选中态（如筛选Chip） */
                .chip, .filter-chip {
                    transition: all 160ms ease;
                }
                .chip.is-selected, .filter-chip.is-selected {
                    background-color: rgba(59,130,246,0.08);
                    border-color: rgba(59,130,246,0.4);
                    color: #1f2937;
                }
                
                /* 数字滚动动画 */
                .number-counter {
                    display: inline-block;
                    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
                }
                
                .number-counter.updating {
                    transform: scale(1.1);
                    color: #10b981 !important; /* green-500 */
                    text-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
                }
                
                .number-counter.decreasing {
                    color: #ef4444 !important; /* red-500 */
                    text-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
                }
                
                /* 统计卡片更新动画 */
                .stat-card-updating {
                    animation: statCardPulse 0.8s ease-in-out;
                }
                
                @keyframes statCardPulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.02); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
                    100% { transform: scale(1); }
                }
                
                /* 数字滚动效果 */
                .number-scroll {
                    display: inline-block;
                    overflow: hidden;
                    position: relative;
                }
                
                .number-scroll-inner {
                    display: flex;
                    flex-direction: column;
                    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
                }
                
                .number-scroll-item {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    min-height: 1.2em;
                }
                `;
                document.head.appendChild(style);
            }

            // 统一处理按钮"选中/单选组/多选组"交互
            bindGlobalButtonSelectionHandlers() {
                document.addEventListener('click', (evt) => {
                    const btn = evt.target.closest('button, .toggle-button, .chip, .filter-chip');
                    if (!btn) return;

                    const group = btn.closest('[data-toggle-group]');
                    const isToggle = btn.matches('[data-toggle], .toggle-button, .chip, .filter-chip') || btn.hasAttribute('aria-pressed');
                    if (!isToggle && !group) return;

                    // 支持单选/多选
                    const mode = (group && group.getAttribute('data-toggle-group')) || btn.getAttribute('data-toggle') || 'single';

                    if (group && mode === 'single') {
                        // 组内清除
                        const siblings = group.querySelectorAll('button, .toggle-button, .chip, .filter-chip');
                        siblings.forEach(el => {
                            el.classList.remove('btn-selected', 'is-selected');
                            if (el.hasAttribute('aria-pressed')) el.setAttribute('aria-pressed', 'false');
                            el.dataset.selected = 'false';
                        });
                        btn.classList.add('btn-selected');
                        btn.classList.add('is-selected');
                        btn.dataset.selected = 'true';
                        if (btn.hasAttribute('aria-pressed')) btn.setAttribute('aria-pressed', 'true');
                        return;
                    }

                    // 多选/独立切换
                    const selected = btn.classList.toggle('btn-selected');
                    btn.classList.toggle('is-selected', selected);
                    const now = selected ? 'true' : 'false';
                    if (btn.hasAttribute('aria-pressed')) btn.setAttribute('aria-pressed', now);
                    btn.dataset.selected = now;
                }, { passive: true });
            }

            bindEvents() {
                // 防止重复绑定事件
                if (this._eventsBound) {
                    console.log('事件已绑定，跳过重复绑定');
                    return;
                }
                
                this._eventsBound = true;
                
                // 按钮事件 - 添加安全检查
                const addResourceBtn = document.getElementById('add-resource-btn');
                if (addResourceBtn) {
                    addResourceBtn.addEventListener('click', () => this.showResourceModal());
                } else {
                    console.warn('添加资源按钮不存在: add-resource-btn');
                }
                
                const addFirstResourceBtn = document.getElementById('add-first-resource');
                if (addFirstResourceBtn) {
                    addFirstResourceBtn.addEventListener('click', () => this.showResourceModal());
                } else {
                    console.warn('添加第一个资源按钮不存在: add-first-resource');
                }
                
                const refreshBtn = document.getElementById('refresh-btn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => this.forceRefreshData());
                }
                
                const importBtn = document.getElementById('import-btn');
                if (importBtn) {
                    importBtn.addEventListener('click', () => this.importResources());
                }
                
                const exportBtn = document.getElementById('export-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => this.exportResources());
                }
                
                const batchActionsBtn = document.getElementById('batch-actions-btn');
                if (batchActionsBtn) {
                    batchActionsBtn.addEventListener('click', () => this.showBatchActions());
                }
                
                // 视图模式相关事件
                const viewModeBtn = document.getElementById('view-mode-btn');
                if (viewModeBtn) {
                    // 视图模式按钮点击事件（保持兼容性）
                    viewModeBtn.addEventListener('click', () => this.toggleViewMode());
                }
                
                // 视图模式选项点击事件
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.view-mode-option')) {
                        const option = e.target.closest('.view-mode-option');
                        const mode = option.dataset.mode;
                        if (mode) {
                            this.switchViewMode(mode);
                        }
                    }
                });
                
                const quickMenuBtn = document.getElementById('quick-menu-btn');
                if (quickMenuBtn) {
                    quickMenuBtn.addEventListener('click', () => this.showQuickMenu());
                }

                // 筛选 - 添加安全检查
                const categoryFilter = document.getElementById('category-filter');
                if (categoryFilter) {
                    categoryFilter.addEventListener('change', (e) => this.handleCategoryFilter(e.target.value));
                }
                
                const sortBy = document.getElementById('sort-by');
                if (sortBy) {
                    sortBy.addEventListener('change', (e) => this.handleSortChange(e.target.value));
                }
                
                const sortOrder = document.getElementById('sort-order');
                if (sortOrder) {
                    sortOrder.addEventListener('change', (e) => this.handleSortOrderChange(e.target.value));
                }
                
                const pageSize = document.getElementById('page-size');
                if (pageSize) {
                    pageSize.addEventListener('change', (e) => this.handlePageSizeChange(e.target.value));
                }

                // 搜索功能事件绑定
                this.bindSearchEvents();

                // 分页事件 - 添加安全检查
                const prevPage = document.getElementById('prev-page');
                if (prevPage) {
                    prevPage.addEventListener('click', () => this.goToPage(this.currentPage - 1));
                }
                
                const nextPage = document.getElementById('next-page');
                if (nextPage) {
                    nextPage.addEventListener('click', () => this.goToPage(this.currentPage + 1));
                }

                // 回到顶部按钮事件 - 添加安全检查
                const backToTop = document.getElementById('back-to-top');
                if (backToTop) {
                    backToTop.addEventListener('click', () => this.scrollToTop());
                }

                // 模态框事件 - 添加安全检查
                const closeModalBtn = document.getElementById('close-modal');
                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', () => this.hideResourceModal());
                }
                
                const cancelResourceBtn = document.getElementById('cancel-resource');
                if (cancelResourceBtn) {
                    cancelResourceBtn.addEventListener('click', () => this.hideResourceModal());
                }
                
                const saveResourceBtn = document.getElementById('save-resource');
                if (saveResourceBtn) {
                    saveResourceBtn.addEventListener('click', () => this.saveResource());
                }
                
                const selectFilesBtn = document.getElementById('select-files');
                if (selectFilesBtn) {
                    selectFilesBtn.addEventListener('click', () => {
                        const fileUpload = document.getElementById('file-upload');
                        if (fileUpload) {
                            fileUpload.click();
                        }
                    });
                }
                
                const fileUpload = document.getElementById('file-upload');
                if (fileUpload) {
                    fileUpload.addEventListener('change', (e) => this.handleFileUpload(e.target.files));
                }

                // 表单验证和实时反馈
                this.setupFormValidation();
                
                // 添加资源类型变化监听器
                const typeSelect = document.getElementById('resource-type');
                if (typeSelect) {
                    typeSelect.addEventListener('change', (e) => {
                        console.log('资源类型已更改:', {
                            oldValue: this.currentResource?.category,
                            newValue: e.target.value,
                            isEditing: this.isEditing
                        });
                        
                        // 处理分类特定字段显示
                        this.handleCategoryChange(e.target.value);
                    });
                }

                // 拖拽上传 - 添加安全检查
                const dropZone = document.querySelector('.border-dashed');
                if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('border-primary');
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('border-primary');
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-primary');
                    this.handleFileUpload(e.dataTransfer.files);
                });
                }
                
                // 动画事件绑定
                this.bindAnimationEvents();
                
                // 初始化页面加载动画
                this.initPageLoadAnimation();
            }

            // 处理分类变化
            handleCategoryChange(category) {
                // 隐藏所有分类特定字段
                const categoryFields = document.querySelectorAll('.category-fields');
                categoryFields.forEach(field => field.classList.add('hidden'));
                
                // 隐藏分类特定字段容器
                const specificFieldsContainer = document.getElementById('category-specific-fields');
                if (specificFieldsContainer) {
                    specificFieldsContainer.classList.add('hidden');
                }
                
                // 隐藏动态指导
                const dynamicGuide = document.getElementById('dynamic-guide');
                if (dynamicGuide) {
                    dynamicGuide.classList.add('hidden');
                }
                
                // 根据选择的分类显示相应字段
                if (category) {
                    // 显示分类特定字段容器
                    if (specificFieldsContainer) {
                        specificFieldsContainer.classList.remove('hidden');
                    }
                    
                    // 显示对应的分类字段
                    const fieldId = this.getCategoryFieldId(category);
                    const targetField = document.getElementById(fieldId);
                    if (targetField) {
                        targetField.classList.remove('hidden');
                    }
                    
                    // 显示动态指导信息
                    this.showDynamicGuide(category);
                }
            }
            
            // 获取分类字段ID
            getCategoryFieldId(category) {
                const fieldMap = {
                    'traditionalFoods': 'foods-fields',
                    'traditionalCrafts': 'crafts-fields',
                    'traditionalOpera': 'opera-fields',
                    'traditionalFestivals': 'festivals-fields',
                    'traditionalMedicine': 'medicine-fields',
                    'traditionalArchitecture': 'architecture-fields'
                };
                return fieldMap[category] || '';
            }
            
            // 显示动态指导信息
            showDynamicGuide(category) {
                const dynamicGuide = document.getElementById('dynamic-guide');
                const guideTitle = document.getElementById('guide-title');
                const guideContent = document.getElementById('guide-content');
                
                if (!dynamicGuide || !guideTitle || !guideContent) return;
                
                const guideInfo = this.getCategoryGuideInfo(category);
                if (guideInfo) {
                    guideTitle.textContent = guideInfo.title;
                    guideContent.innerHTML = guideInfo.content;
                    dynamicGuide.classList.remove('hidden');
                }
            }
            
            // 获取分类指导信息
            getCategoryGuideInfo(category) {
                const guideMap = {
                    'traditionalFoods': {
                        title: '🍽️ 传统美食填写指南',
                        content: `
                            <div class="space-y-1">
                                <div><strong>描述内容</strong>：介绍美食的基本信息、特色、文化背景</div>
                                <div><strong>历史背景</strong>：美食的起源、发展历程、地域文化</div>
                                <div><strong>制作工艺</strong>：详细的制作步骤、关键技巧、注意事项</div>
                                <div><strong>口感特色</strong>：味道、口感、外观、营养价值</div>
                                <div><strong>小知识</strong>：有趣的历史故事、文化典故</div>
                            </div>
                        `
                    },
                    'traditionalCrafts': {
                        title: '🔨 传统工艺填写指南',
                        content: `
                            <div class="space-y-1">
                                <div><strong>描述内容</strong>：工艺的基本介绍、文化价值、应用领域</div>
                                <div><strong>历史背景</strong>：工艺的起源、传承历史、地域特色</div>
                                <div><strong>制作技艺</strong>：制作方法、技术难点、工艺特色</div>
                                <div><strong>艺术特色</strong>：艺术风格、审美价值、文化内涵</div>
                                <div><strong>小知识</strong>：工艺大师、经典作品、传承故事</div>
                            </div>
                        `
                    },
                    'traditionalOpera': {
                        title: '🎭 传统戏曲填写指南',
                        content: `
                            <div class="space-y-1">
                                <div><strong>描述内容</strong>：戏曲的基本介绍、艺术特色、文化地位</div>
                                <div><strong>历史背景</strong>：戏曲的起源、发展历程、流派传承</div>
                                <div><strong>表演技巧</strong>：唱腔、身段、表演技巧、音乐伴奏</div>
                                <div><strong>艺术特色</strong>：艺术风格、表演特色、文化价值</div>
                                <div><strong>小知识</strong>：著名演员、经典剧目、艺术成就</div>
                            </div>
                        `
                    },
                    'traditionalFestivals': {
                        title: '📅 传统节日填写指南',
                        content: `
                            <div class="space-y-1">
                                <div><strong>描述内容</strong>：节日的基本介绍、文化内涵、庆祝方式</div>
                                <div><strong>历史背景</strong>：节日的起源、历史演变、文化意义</div>
                                <div><strong>养生方法</strong>：节气养生、生活建议、健康提示</div>
                                <div><strong>气候特征</strong>：气候特点、自然现象、环境变化</div>
                                <div><strong>小知识</strong>：民俗活动、传统习俗、文化典故</div>
                            </div>
                        `
                    },
                    'traditionalMedicine': {
                        title: '🍃 传统医药填写指南',
                        content: `
                            <div class="space-y-1">
                                <div><strong>描述内容</strong>：药材的基本介绍、功效作用、应用领域</div>
                                <div><strong>历史背景</strong>：药用历史、传统理论、文化传承</div>
                                <div><strong>采集炮制</strong>：采集时间、炮制方法、质量要求</div>
                                <div><strong>功效特点</strong>：功效作用、适应症、使用注意</div>
                                <div><strong>小知识</strong>：药用典故、名医故事、传统理论</div>
                            </div>
                        `
                    },
                    'traditionalArchitecture': {
                        title: '🏛️ 传统建筑填写指南',
                        content: `
                            <div class="space-y-1">
                                <div><strong>描述内容</strong>：建筑的基本介绍、建筑特色、文化价值</div>
                                <div><strong>历史背景</strong>：建筑历史、建造背景、文化意义</div>
                                <div><strong>地理位置</strong>：地理位置、环境特点、交通信息</div>
                                <div><strong>建筑技术</strong>：建筑技术、结构特色、材料工艺</div>
                                <div><strong>建筑特色</strong>：建筑风格、艺术特色、文化价值</div>
                                <div><strong>小知识</strong>：建筑典故、历史故事、文化内涵</div>
                            </div>
                        `
                    }
                };
                
                return guideMap[category] || null;
            }
            
            // 获取分类特定数据
            getCategorySpecificData(category) {
                const data = {};
                
                switch (category) {
                    case 'traditionalFoods':
                        data.technique = document.getElementById('foods-technique')?.value || '';
                        data.features = document.getElementById('foods-features')?.value || '';
                        break;
                    case 'traditionalCrafts':
                        data.technique = document.getElementById('crafts-technique')?.value || '';
                        data.features = document.getElementById('crafts-features')?.value || '';
                        break;
                    case 'traditionalOpera':
                        data.technique = document.getElementById('opera-technique')?.value || '';
                        data.features = document.getElementById('opera-features')?.value || '';
                        break;
                    case 'traditionalFestivals':
                        data.technique = document.getElementById('festivals-technique')?.value || '';
                        data.features = document.getElementById('festivals-features')?.value || '';
                        break;
                    case 'traditionalMedicine':
                        data.technique = document.getElementById('medicine-technique')?.value || '';
                        data.features = document.getElementById('medicine-features')?.value || '';
                        break;
                    case 'traditionalArchitecture':
                        data.location = document.getElementById('architecture-location')?.value || '';
                        data.technique = document.getElementById('architecture-technique')?.value || '';
                        data.features = document.getElementById('architecture-features')?.value || '';
                        break;
                }
                
                // 过滤空值
                Object.keys(data).forEach(key => {
                    if (!data[key]) {
                        delete data[key];
                    }
                });
                
                return data;
            }
            
            // 填充分类特定字段
            populateCategorySpecificFields(resource) {
                const category = resource.category || resource.type;
                
                // 先触发分类变化，显示对应的字段
                this.handleCategoryChange(category);
                
                // 安全地填充字段
                const setFieldValue = (fieldId, value) => {
                    const element = document.getElementById(fieldId);
                    if (element && value) {
                        element.value = value;
                    }
                };
                
                switch (category) {
                    case 'traditionalFoods':
                        setFieldValue('foods-technique', resource.technique);
                        setFieldValue('foods-features', resource.features);
                        break;
                    case 'traditionalCrafts':
                        setFieldValue('crafts-technique', resource.technique);
                        setFieldValue('crafts-features', resource.features);
                        break;
                    case 'traditionalOpera':
                        setFieldValue('opera-technique', resource.technique);
                        setFieldValue('opera-features', resource.features);
                        break;
                    case 'traditionalFestivals':
                        setFieldValue('festivals-technique', resource.technique);
                        setFieldValue('festivals-features', resource.features);
                        break;
                    case 'traditionalMedicine':
                        setFieldValue('medicine-technique', resource.technique);
                        setFieldValue('medicine-features', resource.features);
                        break;
                    case 'traditionalArchitecture':
                        setFieldValue('architecture-location', resource.location);
                        setFieldValue('architecture-technique', resource.technique);
                        setFieldValue('architecture-features', resource.features);
                        break;
                }
            }

            // 从已有数据渲染资源（避免重复API调用）
            async renderResourcesFromData(data) {
                try {
                    console.log('从已有数据渲染资源列表...');
                    
                    const grid = document.getElementById('resources-grid');
                    const loading = document.getElementById('loading-indicator');
                    const empty = document.getElementById('empty-state');
                    const pagination = document.getElementById('pagination');
                    const resultsInfo = document.getElementById('results-info');

                    if (!grid) {
                        console.error('资源网格容器不存在');
                        return;
                    }

                    // 隐藏加载状态
                    if (loading) loading.classList.add('hidden');

                    // 清空现有内容
                    grid.innerHTML = '';

                    // 添加调试信息
                    console.log('API响应数据:', data);
                    console.log('分页信息:', data.pagination);
                    console.log('资源分类:', Object.keys(data.resources));

                    // 更新分页信息
                    this.pagination = data.pagination;
                    this.updatePaginationUI();

                    // 转换资源为数组（添加去重逻辑）
                    const resourceArray = [];
                    const seenIds = new Set(); // 用于去重
                    
                    for (const [category, categoryResources] of Object.entries(data.resources)) {
                        console.log(`分类 ${category} 的资源:`, Object.keys(categoryResources));
                        for (const [id, resource] of Object.entries(categoryResources)) {
                            // 创建唯一标识符（category + id）
                            const uniqueId = `${category}_${id}`;
                            
                            // 检查是否已存在
                            if (seenIds.has(uniqueId)) {
                                console.warn(`发现重复资源: ${uniqueId}`, resource);
                                continue; // 跳过重复项
                            }
                            
                            seenIds.add(uniqueId);
                            
                            // 确保资源有正确的ID和分类
                            const resourceWithMeta = {
                                id: id,
                                category: category,
                                uniqueId: uniqueId, // 添加唯一标识符
                                ...resource
                            };
                            resourceArray.push(resourceWithMeta);
                        }
                    }
                    
                    console.log('转换后的资源数组:', resourceArray);

                    if (resourceArray.length === 0) {
                        if (empty) empty.classList.remove('hidden');
                        if (pagination) pagination.classList.add('hidden');
                        if (resultsInfo) resultsInfo.classList.add('hidden');
                        return;
                    }

                    if (empty) empty.classList.add('hidden');

                    // 渲染资源卡片
                    for (let i = 0; i < resourceArray.length; i++) {
                        const resource = resourceArray[i];
                        try {
                            console.log('正在渲染资源卡片:', {
                                id: resource.id,
                                title: resource.title,
                                category: resource.category,
                                hasContent: !!resource.content,
                                hasMedia: Array.isArray(resource.media) && resource.media.length > 0,
                                hasTags: Array.isArray(resource.tags) && resource.tags.length > 0
                            });
                            
                            const card = this.createResourceCard(resource);
                            if (card && grid) {
                                grid.appendChild(card);
                                
                                // 添加动画效果 - 延迟执行，创造瀑布流效果
                                setTimeout(() => {
                                    card.style.opacity = '1';
                                    card.style.transform = 'translateX(0)';
                                }, i * 100); // 每个卡片延迟100ms
                            } else {
                                console.warn('卡片创建失败或网格容器不存在');
                            }
                        } catch (error) {
                            console.error('渲染单个资源卡片失败:', error, resource);
                        }
                    }

                    // 更新结果统计（包含动态获取资源总数）
                    await this.updateResultsInfo();

                    if (pagination) pagination.classList.remove('hidden');
                    if (resultsInfo) resultsInfo.classList.remove('hidden');

                    console.log(`成功渲染 ${resourceArray.length} 个资源卡片`);

                } catch (error) {
                    console.error('从数据渲染资源失败:', error);
                    this.showNotification('渲染资源失败: ' + error.message, 'error');
                }
            }

            async renderResources() {
                // 安全地获取DOM元素
                const getElement = (id) => {
                    const element = document.getElementById(id);
                    if (!element) {
                        console.warn(`DOM元素不存在: ${id}`);
                    }
                    return element;
                };

                const grid = getElement('resources-grid');
                const loading = getElement('loading-indicator');
                const empty = getElement('empty-state');
                const pagination = getElement('pagination');
                const resultsInfo = getElement('results-info');

                // 检查必要的元素是否存在
                if (!grid) {
                    console.error('资源网格元素不存在');
                    return;
                }

                if (loading) loading.classList.remove('hidden');
                if (grid) grid.innerHTML = '';

                try {
                    // 构建查询参数
                    const params = {
                        page: this.currentPage,
                        limit: this.pageSize,
                        sortBy: this.currentFilters.sortBy,
                        sortOrder: this.currentFilters.sortOrder,
                        _t: Date.now() // 添加时间戳防止缓存
                    };

                    if (this.currentFilters.category) {
                        params.category = this.currentFilters.category;
                    }


                    console.log('正在请求资源数据，参数:', params);
                    const data = await this.getResources(params);

                    // 添加调试信息
                    console.log('API响应数据:', data);
                    console.log('分页信息:', data.pagination);
                    console.log('资源分类:', Object.keys(data.resources));

                    // 更新分页信息
                    this.pagination = data.pagination;
                    this.updatePaginationUI();

                    // 转换资源为数组（添加去重逻辑）
                    const resourceArray = [];
                    const seenIds = new Set(); // 用于去重
                    
                    for (const [category, categoryResources] of Object.entries(data.resources)) {
                        console.log(`分类 ${category} 的资源:`, Object.keys(categoryResources));
                        for (const [id, resource] of Object.entries(categoryResources)) {
                            // 创建唯一标识符（category + id）
                            const uniqueId = `${category}_${id}`;
                            
                            // 检查是否已存在
                            if (seenIds.has(uniqueId)) {
                                console.warn(`发现重复资源: ${uniqueId}`, resource);
                                continue; // 跳过重复项
                            }
                            
                            seenIds.add(uniqueId);
                            
                            // 确保资源有正确的ID和分类
                            const resourceWithMeta = {
                                id: id,
                                category: category,
                                uniqueId: uniqueId, // 添加唯一标识符
                                ...resource
                            };
                            resourceArray.push(resourceWithMeta);
                        }
                    }
                    
                    console.log('转换后的资源数组:', resourceArray);

                    if (resourceArray.length === 0) {
                        if (loading) loading.classList.add('hidden');
                        if (empty) empty.classList.remove('hidden');
                        if (pagination) pagination.classList.add('hidden');
                        if (resultsInfo) resultsInfo.classList.add('hidden');
                        return;
                    }

                    if (empty) empty.classList.add('hidden');

                    // 渲染资源卡片
                    for (let i = 0; i < resourceArray.length; i++) {
                        const resource = resourceArray[i];
                        try {
                            console.log('正在渲染资源卡片:', {
                                id: resource.id,
                                title: resource.title,
                                category: resource.category,
                                hasContent: !!resource.content,
                                hasMedia: Array.isArray(resource.media) && resource.media.length > 0,
                                hasTags: Array.isArray(resource.tags) && resource.tags.length > 0
                            });
                            
                            const card = this.createResourceCard(resource);
                            if (card && grid) {
                                grid.appendChild(card);
                                
                                // 添加动画效果 - 延迟执行，创造瀑布流效果
                                setTimeout(() => {
                                    card.style.opacity = '1';
                                    card.style.transform = 'translateX(0)';
                                }, i * 100); // 每个卡片延迟100ms
                            } else {
                                console.warn('卡片创建失败或网格容器不存在');
                            }
                        } catch (error) {
                            console.error('渲染单个资源卡片失败:', error, resource);
                        }
                    }

                    // 更新结果统计（包含动态获取资源总数）
                    await this.updateResultsInfo();

                    if (loading) loading.classList.add('hidden');
                    if (pagination) pagination.classList.remove('hidden');
                    if (resultsInfo) resultsInfo.classList.remove('hidden');

                    console.log(`成功渲染 ${resourceArray.length} 个资源卡片`);

                } catch (error) {
                    console.error('渲染资源失败:', error);
                    if (loading) loading.classList.add('hidden');
                    this.showNotification('渲染资源失败: ' + error.message, 'error');
                }
            }

            createResourceCard(resource) {
                // 数据验证和默认值处理
                if (!resource) {
                    console.error('资源数据为空');
                    return document.createElement('div');
                }
                
                console.log('创建资源卡片:', {
                    id: resource.id,
                    title: resource.title,
                    category: resource.category
                });
                
                const grid = document.getElementById('resources-grid');
                const currentMode = grid ? grid.dataset.viewMode || 'grid' : 'grid';
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-lg card-hover border border-gray-100 hover:border-primary/20 resource-card glass-effect';
                card.style.opacity = '0';
                card.style.transform = 'translateX(-100px)';
                card.style.transition = 'all 0.5s ease-out';
                
                // 安全获取资源数据，提供默认值
                const title = resource.title || resource.id || '无标题';
                const content = resource.content || resource.description || '暂无内容';
                const category = resource.category || 'unknown';
                const icon = resource.icon || 'fa-utensils';
                const tags = Array.isArray(resource.tags) ? resource.tags : [];
                const media = Array.isArray(resource.media) ? resource.media : [];
                const updatedAt = resource.updatedAt || new Date().toISOString();
                
                // 检查是否需要高亮搜索关键词
                const searchQuery = this.searchState.query || '';
                const highlightedTitle = searchQuery ? this.highlightText(title, searchQuery) : title;
                const highlightedContent = searchQuery ? this.highlightText(content, searchQuery) : content;
                
                // 获取分类颜色
                const categoryColors = {
                    'traditionalFoods': 'bg-red-500',
                    'traditionalCrafts': 'bg-orange-500',
                    'traditionalOpera': 'bg-pink-500',
                    'traditionalFestivals': 'bg-yellow-500',
                    'traditionalMedicine': 'bg-green-500',
                    'traditionalArchitecture': 'bg-gray-500'
                };
                const categoryColor = categoryColors[category] || 'bg-gray-500';
                
                // 安全地序列化资源对象用于点击事件
                const safeResource = {
                    id: resource.id,
                    category: category,
                    title: title,
                    content: content,
                    icon: icon,
                    tags: tags,
                    media: media,
                    updatedAt: updatedAt
                };
                
                // 根据视图模式生成不同的卡片内容
                switch (currentMode) {
                    case 'list':
                        card.innerHTML = this.createListViewCard(resource, highlightedTitle, highlightedContent, category, icon, categoryColor, tags, media, updatedAt, safeResource);
                        break;
                    case 'compact':
                        card.innerHTML = this.createCompactViewCard(resource, highlightedTitle, category, icon, categoryColor, updatedAt, safeResource);
                        break;
                    case 'detail':
                        card.innerHTML = this.createDetailViewCard(resource, highlightedTitle, highlightedContent, category, icon, categoryColor, tags, media, updatedAt, safeResource);
                        break;
                    default: // grid
                        card.innerHTML = this.createGridViewCard(resource, highlightedTitle, highlightedContent, category, icon, categoryColor, tags, media, updatedAt, safeResource);
                }
                
                return card;
            }

            // 网格视图卡片
            createGridViewCard(resource, highlightedTitle, highlightedContent, category, icon, categoryColor, tags, media, updatedAt, safeResource) {
                return `
                    <div class="p-4 lg:p-6 resource-card-content">
                        <!-- 卡片头部 -->
                        <div class="flex justify-between items-start mb-3 resource-card-header">
                            <div class="flex items-center flex-1 min-w-0">
                                <div class="flex-shrink-0">
                                    <i class="fa ${icon} text-xl lg:text-2xl text-primary mr-3"></i>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <h3 class="text-base lg:text-lg font-semibold text-gray-800 truncate" title="${highlightedTitle.replace(/<[^>]*>/g, '')}">${highlightedTitle}</h3>
                                    <div class="flex items-center mt-1">
                                        <span class="inline-block ${categoryColor} text-white text-xs px-2 py-1 rounded-full">${this.getCategoryName(category)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-1 lg:space-x-2 flex-shrink-0">
                                <button class="text-blue-500 hover:text-blue-700 p-1 lg:p-2 rounded hover:bg-blue-50 transition-colors" onclick="console.log('编辑按钮被点击'); window.resourceManagerUI.editResource('${category}', '${resource.id}')" title="编辑" data-category="${category}" data-id="${resource.id}">
                                    <i class="fa fa-edit text-sm lg:text-base"></i>
                                </button>
                                <button class="text-red-500 hover:text-red-700 p-1 lg:p-2 rounded hover:bg-red-50 transition-colors" onclick="window.resourceManagerUI.deleteResource('${category}', '${resource.id}')" title="删除" data-category="${category}" data-id="${resource.id}">
                                    <i class="fa fa-trash text-sm lg:text-base"></i>
                                </button>
                                <button class="text-green-500 hover:text-green-700 p-1 lg:p-2 rounded hover:bg-green-50 transition-colors" onclick="window.resourceManagerUI.showResourcePreview(${JSON.stringify(safeResource).replace(/"/g, '&quot;')}).catch(console.error)" title="查看详情">
                                    <i class="fa fa-eye text-sm lg:text-base"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 内容描述 -->
                        <div class="mb-3 resource-card-description">
                            <p class="text-gray-600 text-sm lg:text-base leading-relaxed line-clamp-2">${highlightedContent}</p>
                        </div>
                        
                        <!-- 媒体文件 -->
                        <div class="resource-card-media">
                            ${this.renderResourceMedia({...resource, media: media})}
                        </div>
                        
                        <!-- 标签 -->
                        ${tags.length > 0 ? `
                            <div class="flex flex-wrap gap-1 mb-3 resource-card-tags">
                                ${tags.slice(0, 3).map(tag => 
                                    `<span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-full" title="${tag}">${this.highlightText(tag, this.searchState.query || '')}</span>`
                                ).join('')}
                                ${tags.length > 3 ? `<span class="text-gray-400 text-xs">+${tags.length - 3}</span>` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- 卡片底部 -->
                        <div class="flex justify-between items-center text-xs text-gray-500 pt-2 border-t border-gray-100 resource-card-footer">
                            <span class="truncate">${new Date(updatedAt).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
            }

            // 列表视图卡片
            createListViewCard(resource, highlightedTitle, highlightedContent, category, icon, categoryColor, tags, media, updatedAt, safeResource) {
                return `
                    <div class="p-4 lg:p-6 resource-card-content">
                        <div class="flex items-center space-x-4">
                            <!-- 图标和分类 -->
                            <div class="flex-shrink-0">
                                <div class="flex items-center space-x-3">
                                    <i class="fa ${icon} text-xl text-primary"></i>
                                    <span class="inline-block ${categoryColor} text-white text-xs px-2 py-1 rounded-full">${this.getCategoryName(category)}</span>
                                </div>
                            </div>
                            
                            <!-- 标题和内容 -->
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold text-gray-800 mb-1" title="${highlightedTitle.replace(/<[^>]*>/g, '')}">${highlightedTitle}</h3>
                                <p class="text-gray-600 text-sm line-clamp-1">${highlightedContent}</p>
                                ${tags.length > 0 ? `
                                    <div class="flex flex-wrap gap-1 mt-2">
                                        ${tags.slice(0, 2).map(tag => 
                                            `<span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-full">${this.highlightText(tag, this.searchState.query || '')}</span>`
                                        ).join('')}
                                        ${tags.length > 2 ? `<span class="text-gray-400 text-xs">+${tags.length - 2}</span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- 媒体文件数量 -->
                            <div class="flex-shrink-0 text-center">
                                <div class="text-sm text-gray-500">${media.length}</div>
                                <div class="text-xs text-gray-400">媒体</div>
                            </div>
                            
                            <!-- 更新时间 -->
                            <div class="flex-shrink-0 text-right">
                                <div class="text-sm text-gray-500">${new Date(updatedAt).toLocaleDateString()}</div>
                            </div>
                            
                            <!-- 操作按钮 -->
                            <div class="flex-shrink-0 flex space-x-2">
                                <button class="text-blue-500 hover:text-blue-700 p-2 rounded hover:bg-blue-50 transition-colors" onclick="window.resourceManagerUI.editResource('${category}', '${resource.id}')" title="编辑">
                                    <i class="fa fa-edit"></i>
                                </button>
                                <button class="text-red-500 hover:text-red-700 p-2 rounded hover:bg-red-50 transition-colors" onclick="window.resourceManagerUI.deleteResource('${category}', '${resource.id}')" title="删除">
                                    <i class="fa fa-trash"></i>
                                </button>
                                <button class="text-green-500 hover:text-green-700 p-2 rounded hover:bg-green-50 transition-colors" onclick="window.resourceManagerUI.showResourcePreview(${JSON.stringify(safeResource).replace(/"/g, '&quot;')}).catch(console.error)" title="查看详情">
                                    <i class="fa fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 紧凑视图卡片
            createCompactViewCard(resource, highlightedTitle, category, icon, categoryColor, updatedAt, safeResource) {
                return `
                    <div class="p-3 resource-card-content text-center relative group">
                        <div class="mb-2">
                            <i class="fa ${icon} text-2xl text-primary"></i>
                        </div>
                        <h3 class="text-sm font-medium text-gray-800 mb-1 truncate" title="${highlightedTitle.replace(/<[^>]*>/g, '')}">${highlightedTitle}</h3>
                        <span class="inline-block ${categoryColor} text-white text-xs px-2 py-1 rounded-full mb-2">${this.getCategoryName(category)}</span>
                        <div class="text-xs text-gray-500">${new Date(updatedAt).toLocaleDateString()}</div>
                        
                        <!-- 悬停时显示操作按钮 -->
                        <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity duration-200 rounded-lg flex items-center justify-center space-x-2">
                            <button class="text-white hover:text-blue-200 p-1 transition-colors" onclick="window.resourceManagerUI.editResource('${category}', '${resource.id}')" title="编辑">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="text-white hover:text-red-200 p-1 transition-colors" onclick="window.resourceManagerUI.deleteResource('${category}', '${resource.id}')" title="删除">
                                <i class="fa fa-trash"></i>
                            </button>
                            <button class="text-white hover:text-green-200 p-1 transition-colors" onclick="window.resourceManagerUI.showResourcePreview(${JSON.stringify(safeResource).replace(/"/g, '&quot;')}).catch(console.error)" title="查看详情">
                                <i class="fa fa-eye"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            // 详细视图卡片
            createDetailViewCard(resource, highlightedTitle, highlightedContent, category, icon, categoryColor, tags, media, updatedAt, safeResource) {
                return `
                    <div class="p-6 resource-card-content">
                        <!-- 详细头部 -->
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center space-x-4">
                                <i class="fa ${icon} text-3xl text-primary"></i>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800 mb-1">${highlightedTitle}</h3>
                                    <span class="inline-block ${categoryColor} text-white text-sm px-3 py-1 rounded-full">${this.getCategoryName(category)}</span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button class="text-blue-500 hover:text-blue-700 p-2 rounded hover:bg-blue-50 transition-colors" onclick="window.resourceManagerUI.editResource('${category}', '${resource.id}')" title="编辑">
                                    <i class="fa fa-edit"></i>
                                </button>
                                <button class="text-red-500 hover:text-red-700 p-2 rounded hover:bg-red-50 transition-colors" onclick="window.resourceManagerUI.deleteResource('${category}', '${resource.id}')" title="删除">
                                    <i class="fa fa-trash"></i>
                                </button>
                                <button class="text-green-500 hover:text-green-700 p-2 rounded hover:bg-green-50 transition-colors" onclick="window.resourceManagerUI.showResourcePreview(${JSON.stringify(safeResource).replace(/"/g, '&quot;')}).catch(console.error)" title="查看详情">
                                    <i class="fa fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 详细内容 -->
                        <div class="mb-4">
                            <p class="text-gray-700 text-base leading-relaxed">${highlightedContent}</p>
                        </div>
                        
                        <!-- 媒体文件 -->
                        <div class="mb-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">媒体文件 (${media.length})</h4>
                            <div class="resource-card-media">
                                ${this.renderResourceMedia({...resource, media: media})}
                            </div>
                        </div>
                        
                        <!-- 标签 -->
                        ${tags.length > 0 ? `
                            <div class="mb-4">
                                <h4 class="text-sm font-semibold text-gray-700 mb-2">标签</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${tags.map(tag => 
                                        `<span class="bg-gray-100 text-gray-700 text-sm px-3 py-1 rounded-full">${this.highlightText(tag, this.searchState.query || '')}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- 详细信息 -->
                        <div class="flex justify-between items-center text-sm text-gray-500 pt-4 border-t border-gray-200">
                            <span>更新时间: ${new Date(updatedAt).toLocaleString()}</span>
                            <span>资源ID: ${resource.id}</span>
                        </div>
                    </div>
                `;
            }



            getFileIcon(fileType) {
                if (fileType === 'image') return 'fa-image';
                if (fileType === 'video') return 'fa-video';
                if (fileType === 'audio') return 'fa-music';
                return 'fa-file';
            }

            getCategoryName(category) {
                const names = {
                    'traditionalFoods': '传统美食',
                    'traditionalCrafts': '传统工艺',
                    'traditionalOpera': '传统戏曲',
                    'traditionalFestivals': '传统节日',
                    'traditionalMedicine': '传统医药',
                    'traditionalArchitecture': '传统建筑'
                };
                return names[category] || category;
            }

            getMediaTypeName(type) {
                const names = {
                    'image': '图片',
                    'video': '视频',
                    'audio': '音频',
                    'document': '文档'
                };
                return names[type] || type;
            }

            setupFormValidation() {
                // 实时表单验证
                const titleInput = document.getElementById('resource-title');
                const typeSelect = document.getElementById('resource-type');
                const contentTextarea = document.getElementById('resource-content');
                const saveButton = document.getElementById('save-resource');

                const validateForm = () => {
                    const title = titleInput.value.trim();
                    const type = typeSelect.value;
                    const content = contentTextarea.value.trim();
                    
                    // 强制布尔化，避免出现诸如 '2' 之类的字符串被当作真值
                    const isValid = Boolean(title && type && content);
                    
                    // 更新保存按钮状态
                    if (saveButton) {
                        saveButton.disabled = !isValid;
                        saveButton.classList.toggle('opacity-50', !isValid);
                        saveButton.classList.toggle('cursor-not-allowed', !isValid);
                    }

                    // 实时验证提示
                    this.updateValidationStatus(titleInput, title, '请输入资源标题');
                    this.updateValidationStatus(typeSelect, type, '请选择资源类型');
                    this.updateValidationStatus(contentTextarea, content, '请输入资源内容');
                    
                    // 调试信息
                    console.log('表单验证状态:', {
                        title: title,
                        type: type,
                        content: content,
                        isValid: isValid
                    });
                };

                // 添加事件监听器
                [titleInput, typeSelect, contentTextarea].forEach(element => {
                    if (element) {
                        element.addEventListener('input', validateForm);
                        element.addEventListener('change', validateForm);
                    }
                });

                // 初始验证
                validateForm();
            }

            updateValidationStatus(element, value, message) {
                if (!element) return;
                
                const isValid = value.trim() !== '';
                const parent = element.parentElement;
                
                // 移除之前的验证样式
                element.classList.remove('border-red-300', 'border-green-300');
                element.classList.add('border-gray-300');
                
                // 移除之前的提示信息
                const existingTip = parent.querySelector('.validation-tip');
                if (existingTip) {
                    existingTip.remove();
                }
                
                if (!isValid && value.trim() === '' && element.hasAttribute('required')) {
                    // 显示错误状态
                    element.classList.remove('border-gray-300');
                    element.classList.add('border-red-300');
                    
                    // 添加错误提示
                    const tip = document.createElement('p');
                    tip.className = 'validation-tip text-xs text-red-500 mt-1';
                    tip.textContent = message;
                    parent.appendChild(tip);
                } else if (isValid && value.trim() !== '') {
                    // 显示成功状态
                    element.classList.remove('border-gray-300');
                    element.classList.add('border-green-300');
                }
            }

            // 更新统计信息UI（使用已有数据，不重新调用API）
            async updateStatisticsUI(stats) {
                try {
                    console.log('正在更新统计信息UI...', stats);
                    
                    // 使用动画更新统计信息元素
                    const updateElementWithAnimation = async (id, newValue, options = {}) => {
                        const element = document.getElementById(id);
                        if (element) {
                            await this.animateNumber(element, newValue, null, options);
                        } else {
                            console.warn(`统计元素不存在: ${id}`);
                        }
                    };
                    
                    // 并行更新所有统计数字，带动画效果
                    await Promise.all([
                        updateElementWithAnimation('total-resources', stats.totalResources || 0),
                        updateElementWithAnimation('total-categories', stats.totalCategories || 0),
                        updateElementWithAnimation('total-files', stats.totalMedia || 0),
                        updateElementWithAnimation('total-size', this.formatFileSize(stats.totalFileSize || 0), { showAnimation: false }) // 文件大小不显示动画
                    ]);
                    
                    // 更新存储状态
                    this.updateStorageProgress(stats.totalFileSize || 0);
                    
                    // 更新其他卡片状态
                    this.updateOtherCardStatuses(stats);
                    
                    console.log('统计信息UI更新完成');
                } catch (error) {
                    console.error('更新统计信息UI失败:', error);
                    // 如果更新失败，使用默认值
                    const updateElement = (id, value) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                        }
                    };
                    
                    updateElement('total-resources', '0');
                    updateElement('total-categories', '0');
                    updateElement('total-files', '0');
                    updateElement('total-size', '0 B');
                    
                    // 重置存储状态
                    this.updateStorageProgress(0);
                }
            }

            // 获取并更新统计信息（当需要刷新数据时使用）
            async updateStatistics() {
                try {
                    console.log('正在获取统计信息...');
                    const data = await this.getStatistics();
                    const stats = data.statistics;
                    console.log('获取到的统计信息:', stats);
                    
                    await this.updateStatisticsUI(stats);
                    console.log('统计信息更新完成');
                } catch (error) {
                    console.error('更新统计信息失败:', error);
                    // 如果API失败，使用默认值
                    const updateElement = (id, value) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                        }
                    };
                    
                    updateElement('total-resources', '0');
                    updateElement('total-categories', '0');
                    updateElement('total-files', '0');
                    updateElement('total-size', '0 B');
                    
                    this.showNotification('统计信息获取失败，使用默认值', 'warning');
                }
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // 获取存储使用百分比
            getStorageUsagePercentage(totalBytes) {
                const totalCapacity = 1024 * 1024 * 1024; // 1GB
                return Math.min((totalBytes / totalCapacity) * 100, 100).toFixed(1);
            }

            // 获取存储状态文本
            getStorageStatus(totalBytes) {
                const percentage = parseFloat(this.getStorageUsagePercentage(totalBytes));
                
                if (percentage >= 90) {
                    return '警告';
                } else if (percentage >= 70) {
                    return '注意';
                } else if (percentage >= 30) {
                    return '正常';
                } else {
                    return '空闲';
                }
            }

            // 获取分类显示名称
            getCategoryDisplayName(category) {
                const categoryNames = {
                    'traditionalFoods': '传统美食',
                    'traditionalCrafts': '传统工艺',
                    'traditionalOpera': '传统戏曲',
                    'traditionalFestivals': '传统节日',
                    'traditionalMedicine': '传统医药',
                    'traditionalArchitecture': '传统建筑'
                };
                return categoryNames[category] || category;
            }

            // 更新存储状态
            updateStorageProgress(totalBytes) {
                try {
                    const statusIndicator = document.querySelector('[data-stat-card="storage"] .status-indicator');
                    const statusText = document.querySelector('[data-stat-card="storage"] .bg-green-100');
                    const trendElement = document.getElementById('storage-trend');
                    const trendIcon = document.querySelector('[data-stat-card="storage"] .trend-arrow');
                    
                    // 计算存储使用百分比（假设总容量为1GB）
                    const totalCapacity = 1024 * 1024 * 1024; // 1GB
                    const usagePercentage = Math.min((totalBytes / totalCapacity) * 100, 100);
                    
                    // 根据使用量更新状态
                    let status = '正常';
                    let statusColor = 'green';
                    let trendValue = '0%';
                    let trendDirection = 'up';
                    let animationClass = 'pulse';
                    let trendAnimation = 'stable';
                    
                    if (usagePercentage >= 90) {
                        status = '警告';
                        statusColor = 'red';
                        trendValue = '高';
                        trendDirection = 'up';
                        animationClass = 'critical';
                        trendAnimation = 'warning';
                    } else if (usagePercentage >= 70) {
                        status = '注意';
                        statusColor = 'yellow';
                        trendValue = '中';
                        trendDirection = 'up';
                        animationClass = 'warning';
                        trendAnimation = 'increasing';
                    } else if (usagePercentage >= 30) {
                        status = '正常';
                        statusColor = 'green';
                        trendValue = '低';
                        trendDirection = 'up';
                        animationClass = 'pulse';
                        trendAnimation = 'increasing';
                    } else {
                        status = '空闲';
                        statusColor = 'blue';
                        trendValue = '0%';
                        trendDirection = 'down';
                        animationClass = '';
                        trendAnimation = 'decreasing';
                    }
                    
                    // 更新状态指示器
                    if (statusIndicator) {
                        statusIndicator.className = `absolute -top-1 -right-1 w-3 h-3 bg-${statusColor}-400 rounded-full border-2 border-white shadow-sm status-indicator ${animationClass}`;
                    }
                    
                    // 更新状态文本
                    if (statusText) {
                        statusText.className = `text-xs bg-${statusColor}-100 text-${statusColor}-700 px-2 py-1 rounded-full font-medium`;
                        statusText.textContent = status;
                    }
                    
                    // 更新趋势
                    if (trendElement) {
                        trendElement.textContent = trendValue;
                        trendElement.className = `text-xs text-${statusColor}-500 font-medium`;
                    }
                    
                    // 更新趋势图标
                    if (trendIcon) {
                        trendIcon.className = `fa fa-arrow-${trendDirection} text-xs text-${statusColor}-500 trend-arrow ${trendAnimation}`;
                    }
                    
                    console.log(`存储状态更新: ${usagePercentage.toFixed(1)}% (${this.formatFileSize(totalBytes)})`);
                    
                } catch (error) {
                    console.error('更新存储状态失败:', error);
                }
            }

            // 更新其他卡片状态
            updateOtherCardStatuses(stats) {
                try {
                    // 更新资源概况卡片状态
                    this.updateOverallCardStatus(stats.totalResources || 0);
                    
                    // 更新分类卡片状态
                    this.updateCategoryCardStatus(stats.totalCategories || 0);
                    
                    // 更新文件卡片状态
                    this.updateFileCardStatus(stats.totalMedia || 0);
                    
                } catch (error) {
                    console.error('更新其他卡片状态失败:', error);
                }
            }

            // 更新资源概况卡片状态
            updateOverallCardStatus(totalResources) {
                const statusIndicator = document.querySelector('[data-stat-card="overall"] .status-indicator');
                const statusText = document.querySelector('[data-stat-card="overall"] .bg-blue-100');
                const trendElement = document.querySelector('[data-stat-card="overall"] .text-blue-500');
                const trendIcon = document.querySelector('[data-stat-card="overall"] .trend-arrow');
                
                let status = '活跃';
                let statusColor = 'blue';
                let trendValue = '正常';
                let animationClass = 'pulse';
                let trendAnimation = 'stable';
                
                if (totalResources >= 100) {
                    status = '丰富';
                    statusColor = 'green';
                    trendValue = '优秀';
                    animationClass = 'pulse';
                    trendAnimation = 'increasing';
                } else if (totalResources >= 50) {
                    status = '活跃';
                    statusColor = 'blue';
                    trendValue = '良好';
                    animationClass = 'pulse';
                    trendAnimation = 'increasing';
                } else if (totalResources >= 10) {
                    status = '一般';
                    statusColor = 'yellow';
                    trendValue = '正常';
                    animationClass = 'warning';
                    trendAnimation = 'stable';
                } else {
                    status = '较少';
                    statusColor = 'gray';
                    trendValue = '待补充';
                    animationClass = '';
                    trendAnimation = 'decreasing';
                }
                
                // 更新状态指示器
                if (statusIndicator) {
                    statusIndicator.className = `absolute -top-1 -right-1 w-3 h-3 bg-${statusColor}-400 rounded-full border-2 border-white shadow-sm status-indicator ${animationClass}`;
                }
                
                // 更新状态文本
                if (statusText) {
                    statusText.className = `text-xs bg-${statusColor}-100 text-${statusColor}-700 px-2 py-1 rounded-full font-medium`;
                    statusText.textContent = status;
                }
                
                // 更新趋势
                if (trendElement) {
                    trendElement.textContent = trendValue;
                    trendElement.className = `text-xs text-${statusColor}-500 font-medium`;
                }
                
                // 更新趋势图标
                if (trendIcon) {
                    trendIcon.className = `fa fa-arrow-up text-xs text-${statusColor}-500 trend-arrow ${trendAnimation}`;
                }
            }

            // 更新分类卡片状态
            updateCategoryCardStatus(totalCategories) {
                const statusIndicator = document.querySelector('[data-stat-card="category"] .status-indicator');
                const statusText = document.querySelector('[data-stat-card="category"] .bg-orange-100');
                const trendElement = document.querySelector('[data-stat-card="category"] .text-orange-500');
                const trendIcon = document.querySelector('[data-stat-card="category"] .trend-arrow');
                
                let status = '多样';
                let statusColor = 'orange';
                let trendValue = '正常';
                let animationClass = 'pulse';
                let trendAnimation = 'stable';
                
                if (totalCategories >= 6) {
                    status = '全面';
                    statusColor = 'green';
                    trendValue = '优秀';
                    animationClass = 'pulse';
                    trendAnimation = 'increasing';
                } else if (totalCategories >= 4) {
                    status = '多样';
                    statusColor = 'orange';
                    trendValue = '良好';
                    animationClass = 'pulse';
                    trendAnimation = 'increasing';
                } else if (totalCategories >= 2) {
                    status = '一般';
                    statusColor = 'yellow';
                    trendValue = '正常';
                    animationClass = 'warning';
                    trendAnimation = 'stable';
                } else {
                    status = '单一';
                    statusColor = 'gray';
                    trendValue = '待扩展';
                    animationClass = '';
                    trendAnimation = 'decreasing';
                }
                
                // 更新状态指示器
                if (statusIndicator) {
                    statusIndicator.className = `absolute -top-1 -right-1 w-3 h-3 bg-${statusColor}-400 rounded-full border-2 border-white shadow-sm status-indicator ${animationClass}`;
                }
                
                // 更新状态文本
                if (statusText) {
                    statusText.className = `text-xs bg-${statusColor}-100 text-${statusColor}-700 px-2 py-1 rounded-full font-medium`;
                    statusText.textContent = status;
                }
                
                // 更新趋势
                if (trendElement) {
                    trendElement.textContent = trendValue;
                    trendElement.className = `text-xs text-${statusColor}-500 font-medium`;
                }
                
                // 更新趋势图标
                if (trendIcon) {
                    trendIcon.className = `fa fa-arrow-up text-xs text-${statusColor}-500 trend-arrow ${trendAnimation}`;
                }
            }

            // 更新文件卡片状态
            updateFileCardStatus(totalFiles) {
                const statusIndicator = document.querySelector('[data-stat-card="file"] .status-indicator');
                const statusText = document.querySelector('[data-stat-card="file"] .bg-pink-100');
                const trendElement = document.querySelector('[data-stat-card="file"] .text-pink-500');
                const trendIcon = document.querySelector('[data-stat-card="file"] .trend-arrow');
                
                let status = '丰富';
                let statusColor = 'pink';
                let trendValue = '正常';
                let animationClass = 'pulse';
                let trendAnimation = 'stable';
                
                if (totalFiles >= 50) {
                    status = '丰富';
                    statusColor = 'green';
                    trendValue = '优秀';
                    animationClass = 'pulse';
                    trendAnimation = 'increasing';
                } else if (totalFiles >= 20) {
                    status = '丰富';
                    statusColor = 'pink';
                    trendValue = '良好';
                    animationClass = 'pulse';
                    trendAnimation = 'increasing';
                } else if (totalFiles >= 5) {
                    status = '一般';
                    statusColor = 'yellow';
                    trendValue = '正常';
                    animationClass = 'warning';
                    trendAnimation = 'stable';
                } else {
                    status = '较少';
                    statusColor = 'gray';
                    trendValue = '待添加';
                    animationClass = '';
                    trendAnimation = 'decreasing';
                }
                
                // 更新状态指示器
                if (statusIndicator) {
                    statusIndicator.className = `absolute -top-1 -right-1 w-3 h-3 bg-${statusColor}-400 rounded-full border-2 border-white shadow-sm status-indicator ${animationClass}`;
                }
                
                // 更新状态文本
                if (statusText) {
                    statusText.className = `text-xs bg-${statusColor}-100 text-${statusColor}-700 px-2 py-1 rounded-full font-medium`;
                    statusText.textContent = status;
                }
                
                // 更新趋势
                if (trendElement) {
                    trendElement.textContent = trendValue;
                    trendElement.className = `text-xs text-${statusColor}-500 font-medium`;
                }
                
                // 更新趋势图标
                if (trendIcon) {
                    trendIcon.className = `fa fa-arrow-up text-xs text-${statusColor}-500 trend-arrow ${trendAnimation}`;
                }
            }

            // 创建文件类型分布图表
            createFileTypeChart(fileTypes) {
                const ctx = document.getElementById('fileTypeChart');
                if (!ctx) return;

                // 销毁现有图表
                if (window.fileTypeChart && typeof window.fileTypeChart.destroy === 'function') {
                    window.fileTypeChart.destroy();
                }

                const entries = Object.entries(fileTypes || {});
                if (entries.length === 0) return;

                // 优雅配色数组 - 参考现代优秀网站
                const colors = [
                    '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e',
                    '#f97316', '#eab308', '#22c55e', '#06b6d4'
                ];

                const data = {
                    labels: entries.map(([type]) => type.toLowerCase()),
                    datasets: [{
                        data: entries.map(([, count]) => count),
                        backgroundColor: colors.slice(0, entries.length).map(color => color + '20'),
                        borderColor: colors.slice(0, entries.length),
                        borderWidth: 2,
                        hoverBackgroundColor: colors.slice(0, entries.length).map(color => color + '40'),
                        hoverBorderColor: colors.slice(0, entries.length),
                        hoverBorderWidth: 3,
                        cutout: '75%',
                        borderRadius: 0,
                        spacing: 0
                    }]
                };

                const config = {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1,
                                cornerRadius: 8,
                                displayColors: false,
                                titleFont: {
                                    size: 14,
                                    weight: '600'
                                },
                                bodyFont: {
                                    size: 13
                                },
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label.toUpperCase();
                                    },
                                    label: function(context) {
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${value} files (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true,
                            duration: 1500,
                            easing: 'easeOutQuart'
                        },
                        elements: {
                            arc: {
                                borderJoinStyle: 'round'
                            }
                        }
                    }
                };

                window.fileTypeChart = new Chart(ctx, config);
            }

            // 创建各分类资源数立体柱状图
            createCategoryChart(categoryStats) {
                console.log('创建分类图表，数据:', categoryStats);
                const ctx = document.getElementById('categoryChart');
                if (!ctx) {
                    console.error('找不到 categoryChart canvas 元素');
                    return;
                }

                // 销毁现有图表
                if (window.categoryChart && typeof window.categoryChart.destroy === 'function') {
                    window.categoryChart.destroy();
                }

                const categories = Object.keys(categoryStats || {});
                console.log('存储统计 - 分类数量:', categories.length, '分类列表:', categories);
                if (categories.length === 0) {
                    console.log('存储统计 - 没有分类数据，跳过图表创建');
                    return;
                }

                // 优雅配色数组 - 参考现代优秀网站
                const colors = [
                    '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e',
                    '#f97316', '#eab308', '#22c55e', '#06b6d4'
                ];

                const data = {
                    labels: categories.map(cat => this.getCategoryDisplayName(cat)),
                    datasets: [{
                        label: 'Resources',
                        data: categories.map(cat => categoryStats[cat]),
                        backgroundColor: colors.slice(0, categories.length).map(color => color + '15'),
                        borderColor: colors.slice(0, categories.length),
                        borderWidth: 1.5,
                        hoverBackgroundColor: colors.slice(0, categories.length).map(color => color + '25'),
                        hoverBorderColor: colors.slice(0, categories.length),
                        hoverBorderWidth: 2,
                        borderRadius: 4,
                        borderSkipped: false,
                        barThickness: 32,
                        maxBarThickness: 40
                    }]
                };

                const config = {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1,
                                cornerRadius: 8,
                                displayColors: false,
                                titleFont: {
                                    size: 14,
                                    weight: '600'
                                },
                                bodyFont: {
                                    size: 13
                                },
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        return `${context.parsed.y} resources`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#656d76',
                                    font: {
                                        size: 12,
                                        weight: '500'
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(101, 109, 118, 0.08)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#656d76',
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value) {
                                        return value;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 1200,
                            easing: 'easeOutQuart'
                        },
                        elements: {
                            bar: {
                                borderSkipped: false
                            }
                        }
                    }
                };

                window.categoryChart = new Chart(ctx, config);
                console.log('存储统计 - 分类图表创建成功');
            }

            // 创建总体统计的文件类型分布图表
            createOverallFileTypeChart(fileTypes) {
                const ctx = document.getElementById('overallFileTypeChart');
                if (!ctx) return;

                // 销毁现有图表
                if (window.overallFileTypeChart && typeof window.overallFileTypeChart.destroy === 'function') {
                    window.overallFileTypeChart.destroy();
                }

                const entries = Object.entries(fileTypes || {});
                if (entries.length === 0) return;

                // 现代优雅配色数组
                const colors = [
                    '#3B82F6', '#10B981', '#F59E0B', '#EF4444',
                    '#8B5CF6', '#06B6D4', '#F97316', '#84CC16'
                ];

                const data = {
                    labels: entries.map(([type]) => type.toLowerCase()),
                    datasets: [{
                        data: entries.map(([, count]) => count),
                        backgroundColor: colors.slice(0, entries.length),
                        borderColor: 'rgba(255, 255, 255, 0.9)',
                        borderWidth: 4,
                        hoverBackgroundColor: colors.slice(0, entries.length).map(color => color + 'DD'),
                        hoverBorderColor: 'rgba(255, 255, 255, 1)',
                        hoverBorderWidth: 6,
                        cutout: '60%',
                        borderRadius: 12,
                        spacing: 6,
                        shadowOffsetX: 0,
                        shadowOffsetY: 4,
                        shadowBlur: 8,
                        shadowColor: 'rgba(0, 0, 0, 0.3)'
                    }]
                };

                const config = {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255, 255, 255, 0.3)',
                                borderWidth: 2,
                                cornerRadius: 12,
                                displayColors: false,
                                padding: 12,
                                callbacks: {
                                    title: function(context) {
                                        return `文件类型：${context[0].label}`;
                                    },
                                    label: function(context) {
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `数量：${value} 个文件`;
                                    },
                                    afterLabel: function(context) {
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `占比：${percentage}%`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true,
                            duration: 2000,
                            easing: 'easeOutCubic'
                        },
                        elements: {
                            arc: {
                                borderJoinStyle: 'round'
                            }
                        }
                    }
                };

                window.overallFileTypeChart = new Chart(ctx, config);
            }

            // 创建总体统计的各分类资源数立体柱状图
            createOverallCategoryChart(categoryStats) {
                console.log('创建总体分类图表，数据:', categoryStats);
                const ctx = document.getElementById('overallCategoryChart');
                if (!ctx) {
                    console.error('找不到 overallCategoryChart canvas 元素');
                    return;
                }

                // 销毁现有图表
                if (window.overallCategoryChart && typeof window.overallCategoryChart.destroy === 'function') {
                    window.overallCategoryChart.destroy();
                }

                const categories = Object.keys(categoryStats || {});
                console.log('总体统计 - 分类数量:', categories.length, '分类列表:', categories);
                if (categories.length === 0) {
                    console.log('总体统计 - 没有分类数据，跳过图表创建');
                    return;
                }

                // 现代优雅配色数组
                const colors = [
                    '#3B82F6', '#10B981', '#F59E0B', '#EF4444',
                    '#8B5CF6', '#06B6D4', '#F97316', '#84CC16'
                ];

                const data = {
                    labels: categories.map(cat => this.getCategoryDisplayName(cat)),
                    datasets: [{
                        label: '资源数量',
                        data: categories.map(cat => categoryStats[cat]),
                        backgroundColor: colors.slice(0, categories.length).map(color => color + 'CC'),
                        borderColor: colors.slice(0, categories.length),
                        borderWidth: 2,
                        hoverBackgroundColor: colors.slice(0, categories.length),
                        hoverBorderColor: 'rgba(255, 255, 255, 1)',
                        hoverBorderWidth: 3,
                        borderRadius: {
                            topLeft: 8,
                            topRight: 8,
                            bottomLeft: 4,
                            bottomRight: 4
                        },
                        borderSkipped: false,
                        barThickness: 40,
                        maxBarThickness: 50
                    }]
                };

                const config = {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255, 255, 255, 0.3)',
                                borderWidth: 2,
                                cornerRadius: 12,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    title: function(context) {
                                        return `分类：${context[0].label}`;
                                    },
                                    label: function(context) {
                                        return `资源数量：${context.parsed.y} 个`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#6b7280',
                                    font: {
                                        size: 12,
                                        weight: '500'
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(107, 114, 128, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#6b7280',
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value) {
                                        return value + ' 个';
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeOutCubic',
                            onProgress: function(animation) {
                                const chart = animation.chart;
                                const ctx = chart.ctx;
                                const dataset = chart.data.datasets[0];
                                const meta = chart.getDatasetMeta(0);
                                
                                meta.data.forEach((bar, index) => {
                                    const data = dataset.data[index];
                                    const model = bar.getCenterPoint();
                                    
                                    // 添加3D阴影效果
                                    ctx.save();
                                    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                                    ctx.fillRect(
                                        model.x + 3, 
                                        model.y + 3, 
                                        bar.width, 
                                        chart.chartArea.height - model.y
                                    );
                                    ctx.restore();
                                });
                            }
                        },
                        elements: {
                            bar: {
                                borderSkipped: false
                            }
                        }
                    }
                };

                window.overallCategoryChart = new Chart(ctx, config);
                console.log('总体统计 - 分类图表创建成功');
            }

            // 数字滚动动画方法
            async animateNumber(element, newValue, oldValue = null, options = {}) {
                if (!element) return;
                
                const {
                    duration = 600,
                    easing = 'cubic-bezier(0.4, 0, 0.2, 1)',
                    showAnimation = true
                } = options;
                
                // 如果不需要动画，直接更新
                if (!showAnimation) {
                    element.textContent = newValue;
                    return;
                }
                
                // 获取旧值
                if (oldValue === null) {
                    oldValue = parseInt(element.textContent) || 0;
                }
                
                const newNum = parseInt(newValue) || 0;
                const oldNum = parseInt(oldValue) || 0;
                
                // 如果数值相同，不执行动画
                if (newNum === oldNum) return;
                
                // 添加更新动画类
                element.classList.add('number-counter');
                if (newNum > oldNum) {
                    element.classList.add('updating');
                } else if (newNum < oldNum) {
                    element.classList.add('decreasing');
                }
                
                // 添加卡片动画
                const card = element.closest('.bg-white');
                if (card) {
                    card.classList.add('stat-card-updating');
                }
                
                // 执行数字滚动动画
                const startTime = performance.now();
                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // 使用缓动函数
                    const easeProgress = this.easeInOutCubic(progress);
                    const currentValue = Math.round(oldNum + (newNum - oldNum) * easeProgress);
                    
                    element.textContent = currentValue;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        // 动画完成，移除动画类
                        element.classList.remove('updating', 'decreasing');
                        if (card) {
                            card.classList.remove('stat-card-updating');
                        }
                    }
                };
                
                requestAnimationFrame(animate);
            }

            // 缓动函数
            easeInOutCubic(t) {
                return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
            }

            // 格式化数字显示
            formatNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                }
                return num.toString();
            }

            // 统计卡片点击动画
            animateStatCardClick(cardType) {
                const card = document.querySelector(`[data-stat-card="${cardType}"]`);
                if (card) {
                    card.classList.add('stat-card-updating');
                    setTimeout(() => {
                        card.classList.remove('stat-card-updating');
                    }, 800);
                }
            }

            showResourceModal(resource = null) {
                this.currentResource = resource;
                this.isEditing = !!resource;
                
                // 调试信息
                if (resource) {
                    console.log('显示资源模态框，资源信息:', {
                        category: resource.category,
                        id: resource.id,
                        title: resource.title,
                        mediaCount: Array.isArray(resource.media) ? resource.media.length : 0
                    });
                }
                
                const modal = document.getElementById('resource-modal');
                const title = document.getElementById('modal-title');
                const guide = document.getElementById('modal-guide');
                const submitBtn = document.getElementById('save-resource');
                
                // 安全检查：确保所有必要的DOM元素都存在
                if (!modal) {
                    console.error('模态框元素不存在: resource-modal');
                    return;
                }
                if (!title) {
                    console.error('标题元素不存在: modal-title');
                    return;
                }
                if (!submitBtn) {
                    console.error('提交按钮元素不存在: save-resource');
                    return;
                }
                
                if (this.isEditing) {
                    title.textContent = '编辑资源';
                    submitBtn.textContent = '更新资源';
                    submitBtn.className = 'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors';
                    
                    // 编辑模式下隐藏操作指南
                    if (guide) guide.style.display = 'none';
                    
                    // 填充表单数据
                    this.populateForm(resource);
                } else {
                    title.textContent = '添加资源';
                    submitBtn.textContent = '添加资源';
                    submitBtn.className = 'px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors';
                    
                    // 添加模式下显示操作指南
                    if (guide) guide.style.display = 'block';
                    
                    // 清空表单
                    this.clearForm();
                }
                
                // 添加淡入动画
                modal.classList.remove('hidden');
                modal.style.opacity = '0';
                modal.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    modal.style.opacity = '1';
                    modal.style.transform = 'scale(1)';
                }, 10);
                
                // 重新初始化表单验证
                setTimeout(() => {
                    this.setupFormValidation();
                }, 100);
                
                // 聚焦到标题输入框
                setTimeout(() => {
                    const titleInput = document.getElementById('resource-title');
                    if (titleInput) {
                        titleInput.focus();
                    }
                }, 150);
            }

            hideResourceModal() {
                const modal = document.getElementById('resource-modal');
                
                // 安全检查
                if (!modal) {
                    console.warn('模态框元素不存在，无法隐藏');
                    return;
                }
                
                // 添加淡出动画
                modal.style.opacity = '0';
                modal.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                    this.currentResource = null;
                    this.isEditing = false;
                }, 200);
            }

            populateForm(resource) {
                console.log('填充表单数据:', resource);
                
                try {
                    // 安全地填充表单字段
                    const setFieldValue = (fieldId, value, defaultValue = '') => {
                        const element = document.getElementById(fieldId);
                        if (element) {
                            element.value = value || defaultValue;
                        } else {
                            console.warn(`表单字段不存在: ${fieldId}`);
                        }
                    };
                    
                    // 填充基本信息
                    setFieldValue('resource-title', resource.title);
                    setFieldValue('resource-type', resource.category || resource.type);
                    setFieldValue('resource-content', resource.content || resource.description);
                    setFieldValue('resource-history', resource.history);
                    setFieldValue('resource-icon', resource.icon);
                    setFieldValue('resource-funFact', resource.funFact);
                    
                    // 处理数组字段
                    const keywords = Array.isArray(resource.keywords) ? resource.keywords : 
                                   (typeof resource.keywords === 'string' ? resource.keywords.split(',').map(k => k.trim()) : []);
                    setFieldValue('resource-keywords', keywords.join(', '));
                    
                    const tags = Array.isArray(resource.tags) ? resource.tags : 
                               (typeof resource.tags === 'string' ? resource.tags.split(',').map(t => t.trim()) : []);
                    setFieldValue('resource-tags', tags.join(', '));
                    
                    // 填充分类特定字段
                    this.populateCategorySpecificFields(resource);
                
                    // 显示已有的媒体文件
                    this.renderExistingMediaFiles(resource.media);
                    
                    console.log('表单数据填充完成');
                } catch (error) {
                    console.error('填充表单数据失败:', error);
                    this.showNotification('表单数据加载失败', 'error');
                }
            }

            clearForm() {
                const form = document.getElementById('resource-form');
                if (form) {
                    form.reset();
                }
                
                // 清空分类特定字段
                this.clearCategorySpecificFields();
                
                // 隐藏分类特定字段和动态指导
                const specificFieldsContainer = document.getElementById('category-specific-fields');
                const dynamicGuide = document.getElementById('dynamic-guide');
                if (specificFieldsContainer) specificFieldsContainer.classList.add('hidden');
                if (dynamicGuide) dynamicGuide.classList.add('hidden');
                
                const fileList = document.getElementById('file-list');
                if (fileList) {
                    fileList.innerHTML = '';
                }
            }
            
            // 清空分类特定字段
            clearCategorySpecificFields() {
                const fieldIds = [
                    'foods-technique', 'foods-features',
                    'crafts-technique', 'crafts-features',
                    'opera-technique', 'opera-features',
                    'festivals-technique', 'festivals-features',
                    'medicine-technique', 'medicine-features',
                    'architecture-location', 'architecture-technique', 'architecture-features'
                ];
                
                fieldIds.forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = '';
                    }
                });
            }

            async saveResource() {
                // 防止重复保存
                if (this._saving) {
                    console.log('[saveResource] 正在保存中，跳过重复调用');
                    return;
                }
                
                this._saving = true;
                
                // 显示保存中的状态
                const saveBtn = document.getElementById('save-resource');
                const originalText = saveBtn ? saveBtn.innerHTML : '';
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>保存中...';
                }
                
                // 显示保存进度通知
                this.showNotification('正在保存资源...', 'info');
                console.log('[saveResource] 准备开始保存，当前状态:', { isEditing: this.isEditing, currentResource: this.currentResource && { id: this.currentResource.id, category: this.currentResource.category } });
                
                try {
                    const formData = this.getFormData();
                    console.log('[saveResource] 表单数据:', {
                        ...formData,
                        mediaCount: Array.isArray(formData.media) ? formData.media.length : 0
                    });
                    
                    if (this.isEditing && this.currentResource) {
                        console.log('编辑资源:', this.currentResource);
                        
                        // 验证currentResource的category和id是否存在
                        if (!this.currentResource.category || !this.currentResource.id) {
                            console.error('资源信息不完整:', {
                                category: this.currentResource.category,
                                id: this.currentResource.id,
                                fullResource: this.currentResource
                            });
                            throw new Error('资源信息不完整，无法更新');
                        }
                        
                        // 检查资源类型是否发生变化
                        const newCategory = formData.category;
                        const oldCategory = this.currentResource.category;
                        const categoryChanged = newCategory !== oldCategory;
                        
                        console.log('[saveResource] 资源类型检查:', {
                            oldCategory: oldCategory,
                            newCategory: newCategory,
                            categoryChanged: categoryChanged
                        });
                        
                        if (categoryChanged) {
                            // 跨分类更新：先删除原资源，再添加到新分类
                            console.log('[saveResource] 执行跨分类更新');
                            
                            try {
                                // 删除原资源
                                await this.batchOperation('delete', [{
                                    category: oldCategory,
                                    id: this.currentResource.id
                                }]);
                                
                                // 添加新资源
                                const newResource = {
                                    id: this.currentResource.id,
                                category: newCategory,
                                ...formData,
                                createdAt: this.currentResource.createdAt || new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            };
                            
                                // 使用资源服务器的API添加资源
                                const apiFormData = new FormData();
                                apiFormData.append('title', newResource.title || '');
                                apiFormData.append('description', newResource.content || newResource.description || '');
                                apiFormData.append('tags', (newResource.tags || []).join(','));
                                apiFormData.append('keywords', (newResource.keywords || []).join(','));
                                
                                // 添加媒体文件信息
                                if (Array.isArray(newResource.media) && newResource.media.length > 0) {
                                    apiFormData.append('media', JSON.stringify(newResource.media));
                                    console.log('[saveResource] 跨分类更新添加媒体文件信息:', newResource.media);
                                }
                                
                                const response = await fetch(`${this.resourceServerConfig.baseUrl}/${newCategory}`, {
                                    method: 'POST',
                                    body: apiFormData
                                });
                                
                                if (!response.ok) {
                                    const errorText = await response.text();
                                    throw new Error(`添加资源失败: ${response.status} ${errorText}`);
                                }
                                
                                const result = await response.json();
                                console.log('[saveResource] 跨分类更新成功:', result);
                            
                            this.showNotification(`资源已从"${this.getCategoryName(oldCategory)}"移动到"${this.getCategoryName(newCategory)}"`, 'success');
                            } catch (error) {
                                console.error('跨分类更新失败:', error);
                                this.showNotification(`跨分类更新失败: ${error.message}`, 'error');
                                throw error;
                            }
                        } else {
                            // 同分类更新
                            console.log('[saveResource] 执行同分类更新');
                            
                            try {
                            const updatedResource = {
                                    ...this.currentResource,
                                ...formData,
                                updatedAt: new Date().toISOString()
                            };
                                
                                // 使用批量操作API更新资源
                                const updateResult = await this.batchOperation('update', [{
                                    category: this.currentResource.category,
                                    id: this.currentResource.id
                                }], {
                                    updates: updatedResource
                                });
                                
                                console.log('[saveResource] 批量更新结果:', updateResult);
                            
                            console.log('[saveResource] 更新后的资源:', {
                                id: updatedResource.id,
                                category: updatedResource.category,
                                    mediaCount: Array.isArray(updatedResource.media) ? updatedResource.media.length : 0
                            });
                            this.showNotification('资源更新成功', 'success');
                            
                            // 立即更新页面上的资源卡片，提供即时反馈
                            await this.updateResourceCardInPage(updatedResource);
                            
                            // 刷新当前打开的详细信息模态框（如果存在）
                            await this.refreshCurrentPreviewModal(updatedResource);
                            
                            // 添加更新成功的视觉反馈
                            this.showUpdateSuccessFeedback(updatedResource);
                            } catch (error) {
                                console.error('同分类更新失败:', error);
                                this.showNotification(`更新失败: ${error.message}`, 'error');
                                throw error;
                            }
                        }
                    } else {
                        const category = (formData && formData.category) || document.getElementById('category-filter').value || 'traditionalFoods';
                        console.log('[saveResource] 添加新资源到分类:', category);
                        
                        const resourceId = this.generateId();
                        const resource = {
                            id: resourceId,
                            category: category,
                            ...formData,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        // 使用资源服务器的API添加资源
                        const apiFormData = new FormData();
                        apiFormData.append('title', resource.title || '');
                        apiFormData.append('description', resource.content || resource.description || '');
                        apiFormData.append('tags', (resource.tags || []).join(','));
                        apiFormData.append('keywords', (resource.keywords || []).join(','));
                        
                        // 添加媒体文件信息
                        if (Array.isArray(resource.media) && resource.media.length > 0) {
                            apiFormData.append('media', JSON.stringify(resource.media));
                            console.log('[saveResource] 添加媒体文件信息:', resource.media);
                        }
                        
                        // 使用FormData发送请求，包含媒体文件信息
                        const response = await fetch(`${this.resourceServerConfig.baseUrl}/${category}`, {
                            method: 'POST',
                            body: apiFormData
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`添加资源失败: ${response.status} ${errorText}`);
                        }
                        
                        const result = await response.json();
                        console.log('[saveResource] 添加资源成功:', result);
                        
                        console.log('[saveResource] 新增资源对象:', {
                            id: resourceId,
                            category,
                            mediaCount: Array.isArray(resource.media) ? resource.media.length : 0
                        });
                        
                        this.showNotification('资源添加成功', 'success');
                        
                        // 直接添加新资源到页面，而不是重新渲染整个页面
                        await this.addNewResourceToPage(result.resource);
                    }
                    
                    this.hideResourceModal();
                    
                    // 更新统计信息
                    console.log('[saveResource] 保存完成，更新统计信息...');
                    await this.updateStatistics();
                    
                    // 隐藏保存进度通知
                    this.hideNotification();
                } catch (error) {
                    console.error('[saveResource] 保存资源失败:', error);
                    this.showNotification('保存失败: ' + error.message, 'error');
                } finally {
                    // 恢复按钮状态
                    const saveBtn = document.getElementById('save-resource');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="fa fa-save mr-2"></i>保存资源';
                    }
                    
                    this._saving = false;
                    console.log('[saveResource] 保存流程结束');
                }
            }

            getFormData() {
                // 获取基本表单数据
                const formData = {
                    title: document.getElementById('resource-title').value,
                    category: document.getElementById('resource-type').value, // 使用category字段
                    type: document.getElementById('resource-type').value, // 保持向后兼容
                    content: document.getElementById('resource-content').value,
                    description: document.getElementById('resource-content').value, // 添加description字段以通过验证
                    history: document.getElementById('resource-history').value,
                    keywords: document.getElementById('resource-keywords').value.split(',').map(k => k.trim()).filter(k => k),
                    tags: document.getElementById('resource-tags').value.split(',').map(t => t.trim()).filter(t => t),
                    icon: document.getElementById('resource-icon').value,
                    funFact: document.getElementById('resource-funFact').value
                };

                // 获取分类特定字段
                const category = formData.category;
                const categorySpecificData = this.getCategorySpecificData(category);
                Object.assign(formData, categorySpecificData);

                // 获取媒体文件信息
                const mediaFiles = [];

                // 获取文件列表中的所有文件（包括已有的和新上传的）
                const fileList = document.getElementById('file-list');
                const fileItems = fileList.querySelectorAll('.flex.items-center.justify-between');
                
                console.log('[getFormData] 处理文件列表，文件项数量:', fileItems.length);
                
                // 分别收集已有的文件和新上传的文件
                const existingFiles = [];
                const newUploadedFiles = [];
                
                fileItems.forEach(item => {
                    const fileName = item.dataset.fileName || item.querySelector('.text-sm.text-gray-700').textContent;
                    const fileSize = parseInt(item.dataset.fileSize || '0');
                    const fileType = item.dataset.fileType || 'unknown';
                    const uploadedUrl = item.dataset.uploadedUrl; // 获取上传后的URL
                    
                    console.log('[getFormData] 处理文件项:', {
                        fileName: fileName,
                        fileSize: fileSize,
                        fileType: fileType,
                        uploadedUrl: uploadedUrl
                    });

                    // 跳过无URL的占位项，避免重复（例如 fallback 生成 uploads/xxx 的情况）
                    if (!uploadedUrl) {
                        console.warn('[getFormData] 跳过无URL的文件项（可能是占位或未成功上传）:', { fileName, fileSize, fileType });
                        return;
                    }
                    
                    // 根据文件类型推断媒体类型
                    let mediaType = 'unknown';
                    if (fileType.startsWith('image/')) {
                        mediaType = 'image';
                    } else if (fileType.startsWith('video/')) {
                        mediaType = 'video';
                    } else if (fileType.startsWith('audio/')) {
                        mediaType = 'audio';
                    } else if (fileType.includes('pdf') || fileType.includes('document')) {
                        mediaType = 'document';
                    } else {
                        // 根据文件扩展名推断
                        const fileExtension = fileName.split('.').pop().toLowerCase();
                        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension)) {
                            mediaType = 'image';
                        } else if (['mp4', 'avi', 'mov', 'wmv', 'flv'].includes(fileExtension)) {
                            mediaType = 'video';
                        } else if (['mp3', 'wav', 'ogg', 'aac'].includes(fileExtension)) {
                            mediaType = 'audio';
                        } else if (['pdf', 'doc', 'docx', 'txt'].includes(fileExtension)) {
                            mediaType = 'document';
                        }
                    }

                    // 检查是否是已有的文件（通过URL判断）
                    const isExistingFile = uploadedUrl && uploadedUrl.startsWith('/resources/');
                    const isWrongPath = uploadedUrl && uploadedUrl.startsWith('/uploads/');
                    
                    console.log('[getFormData] 文件类型判断:', {
                        fileName: fileName,
                        uploadedUrl: uploadedUrl,
                        isExistingFile: isExistingFile,
                        isWrongPath: isWrongPath
                    });
                    
                    // 如果URL是错误的路径（/uploads/），需要修复为正确的路径（/resources/）
                    let correctUrl = uploadedUrl;
                    if (isWrongPath) {
                        const fileNameOnly = uploadedUrl.split('/').pop();
                        if (mediaType === 'image') {
                            correctUrl = `/resources/images/${fileNameOnly}`;
                        } else if (mediaType === 'video') {
                            correctUrl = `/resources/videos/${fileNameOnly}`;
                        } else if (mediaType === 'audio') {
                            correctUrl = `/resources/audio/${fileNameOnly}`;
                        } else {
                            correctUrl = `/resources/documents/${fileNameOnly}`;
                        }
                        console.log('[getFormData] 修复错误路径:', uploadedUrl, '->', correctUrl);
                    }
                    
                    const mediaFile = {
                        name: fileName,
                        type: mediaType,
                        size: fileSize,
                        url: correctUrl // 仅使用有效URL
                    };
                    
                    // 根据URL类型分类文件
                    if (isExistingFile) {
                        console.log('[getFormData] 添加到已有文件列表:', mediaFile);
                        existingFiles.push(mediaFile);
                    } else {
                        // 新上传的文件或默认处理
                        console.log('[getFormData] 添加到新上传文件列表:', mediaFile);
                        newUploadedFiles.push(mediaFile);
                    }
                });

                // 合并所有媒体文件（已有文件 + 新上传文件）
                const allMediaFiles = [...existingFiles, ...newUploadedFiles];
                console.log('[getFormData] 合并媒体文件数量:', { existing: existingFiles.length, new: newUploadedFiles.length, merged: allMediaFiles.length });

                // 第一步：按 url|name 去重（粗去重）
                const roughMap = new Map();
                for (const f of allMediaFiles) {
                    const key = `${f.url}|${f.name}`;
                    if (!roughMap.has(key)) roughMap.set(key, f);
                }
                let mergedOnce = Array.from(roughMap.values());
                if (mergedOnce.length !== allMediaFiles.length) {
                    console.warn('[getFormData] 媒体存在重复(URL+Name)，已初步去重:', { before: allMediaFiles.length, after: mergedOnce.length });
                }

                // 第二步：按 name+type 归并，优先选择更优版本（/resources/ > 其它 > /uploads/，size 大者优先）
                const pickScore = (file) => {
                    let score = 0;
                    const url = file.url || '';
                    if (url.startsWith('/resources/')) score += 100;
                    else if (url.startsWith('/uploads/')) score += 0;
                    else score += 50; // 其它未知但可能可用
                    const sizeNum = Number(file.size || 0);
                    score += Math.min(sizeNum / 1024, 50); // 适度加权，最多+50
                    if (url) score += 5;
                    return score;
                };
                const byNameType = new Map();
                for (const f of mergedOnce) {
                    const key = `${(f.name || '').toLowerCase()}|${f.type || 'unknown'}`;
                    const prev = byNameType.get(key);
                    if (!prev) {
                        byNameType.set(key, f);
                    } else {
                        const better = pickScore(f) >= pickScore(prev) ? f : prev;
                        byNameType.set(key, better);
                    }
                }
                const dedupedMedia = Array.from(byNameType.values());
                if (dedupedMedia.length !== mergedOnce.length) {
                    console.warn('[getFormData] 媒体按名称+类型归并后，去重数量变化:', { before: mergedOnce.length, after: dedupedMedia.length });
                }

                // 如果有媒体文件，添加到表单数据中
                if (dedupedMedia.length > 0) {
                    formData.media = dedupedMedia;
                    console.log('[getFormData] 收集到的媒体文件(最终):', dedupedMedia);
                }

                return formData;
            }

            async handleFileUpload(files) {
                console.log('=== handleFileUpload 开始 ===');
                console.log('调用时间:', new Date().toISOString());
                console.log('文件数量:', files.length);
                console.log('文件列表:', Array.from(files).map(f => f.name));
                console.log('当前上传状态:', this._uploadingFiles);
                
                // 防止重复调用
                if (this._uploadingFiles) {
                    console.log('文件正在上传中，跳过重复调用');
                    return;
                }
                
                this._uploadingFiles = true;
                console.log('设置上传状态为 true');
                
                const fileList = document.getElementById('file-list');
                
                // 验证文件数量限制
                const maxFiles = 10; // 最多允许上传10个文件
                if (files.length > maxFiles) {
                    this.showNotification(`最多只能上传${maxFiles}个文件`, 'error');
                    this._uploadingFiles = false;
                    return;
                }
                
                // 验证文件大小限制
                const maxFileSize = 50 * 1024 * 1024; // 50MB
                const invalidFiles = Array.from(files).filter(file => file.size > maxFileSize);
                if (invalidFiles.length > 0) {
                    this.showNotification(`文件 ${invalidFiles.map(f => f.name).join(', ')} 超过50MB限制`, 'error');
                    this._uploadingFiles = false;
                    return;
                }
                
                // 验证文件类型
                const allowedTypes = [
                    // images
                    'image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/bmp', 'image/svg+xml',
                    // videos
                    'video/mp4', 'video/webm', 'video/x-msvideo', 'video/quicktime', 'video/x-ms-wmv', 'video/x-flv', 'video/x-matroska',
                    // audios
                    'audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/x-wav', 'audio/ogg', 'audio/aac', 'audio/flac', 'audio/mp4', 'audio/x-m4a',
                    // documents
                    'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain', 'application/rtf', 'application/vnd.oasis.opendocument.text'
                ];
                
                const invalidTypeFiles = Array.from(files).filter(file => !allowedTypes.includes(file.type));
                if (invalidTypeFiles.length > 0) {
                    this.showNotification(`文件 ${invalidTypeFiles.map(f => f.name).join(', ')} 类型不支持`, 'error');
                    this._uploadingFiles = false;
                    return;
                }
                
                // 显示上传进度
                this.showNotification(`开始上传 ${files.length} 个文件...`, 'info');
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    try {
                        // 创建文件上传项
                        const fileItem = document.createElement('div');
                        fileItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 mb-2';
                        fileItem.innerHTML = `
                            <div class="flex items-center justify-between flex-1">
                                <div class="flex items-center space-x-2">
                                    <i class="fa ${this.getFileIcon(file.type)} text-gray-400 text-lg"></i>
                                    <span class="text-sm text-gray-700 font-medium">${file.name}</span>
                                    <span class="text-xs text-gray-500">(${this.formatFileSize(file.size)})</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs text-blue-500">准备上传...</span>
                                    <button class="text-red-500 hover:text-red-700" onclick="this.parentElement.remove()">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        fileList.appendChild(fileItem);
                        console.log('[handleFileUpload] 列表加入文件(待上传):', { name: file.name, size: file.size, type: file.type });
                        
                        // 模拟上传进度
                        const statusSpan = fileItem.querySelector('.text-blue-500');
                        
                        // 更新进度
                        const updateProgress = (progress) => {
                            statusSpan.textContent = `上传中 ${progress}%`;
                        };
                        
                        // 上传文件到服务器
                        const formData = new FormData();
                        formData.append('file', file);
                        
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error(`上传失败: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        console.log('[handleFileUpload] 文件上传成功:', { url: result && result.url, filename: result && result.filename, originalName: result && result.originalName });
                        
                        // 更新文件项显示上传成功
                        statusSpan.textContent = '上传成功';
                        statusSpan.className = 'text-xs text-green-500';
                        
                        // 保存文件信息到data属性中
                        fileItem.dataset.fileName = file.name;
                        fileItem.dataset.fileSize = file.size;
                        fileItem.dataset.fileType = file.type;
                        fileItem.dataset.uploadedFilename = result.filename;
                        fileItem.dataset.uploadedUrl = result.url; // 保存上传后的URL
                        console.log('[handleFileUpload] 数据集更新:', { uploadedUrl: fileItem.dataset.uploadedUrl, fileName: fileItem.dataset.fileName });
                        
                        // 更新文件项样式
                        fileItem.className = 'flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200 mb-2';

                        // 列表级去重：如果已存在同URL的其他项，则移除当前项，避免保存时被采集两次
                        try {
                            const allItems = Array.from(fileList.querySelectorAll('.flex.items-center.justify-between'));
                            const dupItem = allItems.find(el => el !== fileItem && el.dataset && el.dataset.uploadedUrl === fileItem.dataset.uploadedUrl);
                            if (dupItem) {
                                console.warn('[handleFileUpload] 列表存在相同URL的文件项，移除当前重复项:', fileItem.dataset.uploadedUrl);
                                fileItem.remove();
                                continue; // 进入下一个文件
                            }
                        } catch (e) {
                            console.warn('[handleFileUpload] 列表去重检查异常:', e);
                        }

                        // 移除上传过程中的自动保存，避免重复保存
                        // 文件信息已保存在DOM中，用户点击保存时会统一处理
                        
                    } catch (error) {
                        console.error('[handleFileUpload] 文件上传失败:', error);
                        // 显示上传失败状态
                        const fileItem = fileList.lastElementChild;
                        if (fileItem) {
                            const statusSpan = fileItem.querySelector('.text-blue-500');
                            statusSpan.textContent = '上传失败';
                            statusSpan.className = 'text-xs text-red-500 mt-1';
                            fileItem.className = 'flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200 mb-2';
                        }
                    }
                }
                
                this.showNotification(`文件上传完成，成功上传 ${files.length} 个文件`, 'success');
                console.log('文件上传处理完成，文件数量:', files.length);
                
                // 重置上传标志位
                this._uploadingFiles = false;
                console.log('重置上传状态为 false');
                console.log('=== handleFileUpload 结束 ===');
            }



            handleCategoryFilter(category) {
                this.currentFilters.category = category;
                this.currentPage = 1; // 重置到第一页
                this.renderResources();
            }

            handleSortChange(sortBy) {
                console.log(`排序方式改变: ${sortBy}`);
                this.currentFilters.sortBy = sortBy;
                console.log('当前筛选条件:', this.currentFilters);
                this.currentPage = 1; // 重置到第一页
                this.renderResources();
            }

            handleSortOrderChange(sortOrder) {
                this.currentFilters.sortOrder = sortOrder;
                this.currentPage = 1; // 重置到第一页
                this.renderResources();
            }

            handlePageSizeChange(pageSize) {
                this.pageSize = parseInt(pageSize);
                this.currentPage = 1; // 重置到第一页
                this.renderResources();
            }

            goToPage(page) {
                if (page >= 1 && page <= this.pagination.totalPages) {
                    this.currentPage = page;
                    this.renderResources();
                }
            }

            updatePaginationUI() {
                const prevBtn = document.getElementById('prev-page');
                const nextBtn = document.getElementById('next-page');
                const currentPageEl = document.getElementById('current-page');
                const totalPagesEl = document.getElementById('total-pages');

                currentPageEl.textContent = this.pagination.currentPage;
                totalPagesEl.textContent = this.pagination.totalPages;

                prevBtn.disabled = !this.pagination.hasPrevPage;
                nextBtn.disabled = !this.pagination.hasNextPage;

                if (prevBtn.disabled) {
                    prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }

                if (nextBtn.disabled) {
                    nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            async updateResultsInfo() {
                const resultsCount = document.getElementById('results-count');
                const resultsTotal = document.getElementById('results-total');

                if (!resultsCount || !resultsTotal) {
                    console.warn('结果统计元素不存在');
                    return;
                }

                // 获取当前页面实际的资源数量
                const grid = document.getElementById('resources-grid');
                const currentCards = grid ? grid.querySelectorAll('.resource-card') : [];
                const actualCurrentCount = currentCards.length;
                
                // 计算理论上的起始和结束项
                const startItem = (this.pagination.currentPage - 1) * this.pagination.itemsPerPage + 1;
                const endItem = Math.min(this.pagination.currentPage * this.pagination.itemsPerPage, this.pagination.totalItems);

                // 使用实际的资源数量来显示
                const displayEndItem = startItem + actualCurrentCount - 1;
                
                resultsCount.textContent = `显示 ${startItem}-${displayEndItem} 个结果`;
                
                // 动态获取实际的资源总数
                try {
                    const totalResources = await this.getActualTotalResources();
                    
                    // 根据当前分类状态显示不同的信息
                    if (this.currentCategory && this.currentCategory !== 'all') {
                        resultsTotal.textContent = `(共 ${totalResources} 个资源，当前分类: ${this.getCategoryDisplayName(this.currentCategory)})`;
                    } else {
                        resultsTotal.textContent = `(共 ${totalResources} 个资源)`;
                    }
                    
                    console.log(`更新结果统计: 当前页面 ${actualCurrentCount} 个资源，总数 ${totalResources}，分类: ${this.currentCategory || 'all'}`);
                } catch (error) {
                    console.error('获取资源总数失败:', error);
                    // 如果获取失败，使用分页中的总数作为备选
                resultsTotal.textContent = `(共 ${this.pagination.totalItems} 个资源)`;
                }
            }

            // 动态获取实际的资源总数
            async getActualTotalResources() {
                try {
                    console.log(`开始获取资源总数，当前分类: ${this.currentCategory || 'all'}`);
                    
                    // 首先尝试从当前分类获取准确的资源数量
                    if (this.currentCategory && this.currentCategory !== 'all') {
                        console.log(`尝试获取分类 ${this.currentCategory} 的资源`);
                        const categoryData = await this.getCategoryResources(this.currentCategory);
                        console.log(`分类 ${this.currentCategory} 数据:`, categoryData);
                        if (categoryData && categoryData.length > 0) {
                            console.log(`当前分类 ${this.currentCategory} 资源总数: ${categoryData.length}`);
                            return categoryData.length;
                        }
                    }
                    
                    // 如果没有分类或获取失败，获取所有资源
                    console.log('尝试获取所有资源');
                    const allResources = await this.getAllResources();
                    const totalResources = allResources.length;
                    
                    console.log(`动态获取资源总数: ${totalResources}`);
                    if (totalResources > 0) {
                        return totalResources;
                    }
                    
                    // 如果获取所有资源失败，尝试从统计信息获取
                    console.log('所有资源为空，尝试从统计信息获取');
                    const data = await this.getStatistics();
                    const totalFromStats = data.statistics.totalResources || 0;
                    console.log(`从统计信息获取资源总数: ${totalFromStats}`);
                    return totalFromStats;
                } catch (error) {
                    console.error('获取实际资源总数失败:', error);
                    
                    // 如果API失败，尝试从统计信息获取
                    try {
                        console.log('尝试从统计信息获取');
                        const data = await this.getStatistics();
                        const totalResources = data.statistics.totalResources || 0;
                        console.log(`从统计信息获取资源总数: ${totalResources}`);
                        return totalResources;
                    } catch (statsError) {
                        console.error('获取统计信息也失败:', statsError);
                        // 最后备选方案：从当前缓存计算
                        console.log('尝试从缓存获取');
                        const cachedResources = await this.getAllResources();
                        const totalFromCache = cachedResources.length;
                        console.log(`从缓存计算总数: ${totalFromCache}`);
                        return totalFromCache;
                    }
                }
            }

            // 获取所有资源的辅助方法
            async getAllResources() {
                try {
                    // 如果当前有缓存的资源数据，使用缓存
                    if (this.cachedResources && this.cachedResources.length > 0) {
                        console.log(`使用缓存资源: ${this.cachedResources.length} 个`);
                        return this.cachedResources;
                    }
                    
                    // 否则从API获取
                    console.log(`调用API端点: ${this.resourceServerConfig.endpoints.resources}`);
                    const response = await this.callResourceAPI(this.resourceServerConfig.endpoints.resources);
                    console.log('API响应:', response);
                    
                    if (response && response.resources) {
                        // 将分类资源转换为数组
                        const allResources = [];
                        console.log('开始处理分类资源:', Object.keys(response.resources));
                        
                        for (const [category, categoryResources] of Object.entries(response.resources)) {
                            console.log(`处理分类 ${category}:`, Object.keys(categoryResources));
                            for (const [id, resource] of Object.entries(categoryResources)) {
                                allResources.push({
                                    id: id,
                                    category: category,
                                    ...resource
                                });
                            }
                        }
                        this.cachedResources = allResources;
                        console.log(`从API获取到 ${allResources.length} 个资源`);
                        return this.cachedResources;
                    }
                    
                    console.log('API响应中没有resources字段，完整响应:', response);
                    return [];
                } catch (error) {
                    console.error('获取所有资源失败:', error);
                    return [];
                }
            }
            
            // 获取指定分类的资源
            async getCategoryResources(category) {
                try {
                    // 使用分类特定的端点
                    const endpoint = `/${category}`;
                    const response = await this.callResourceAPI(endpoint);
                    if (response && response.resources && Array.isArray(response.resources)) {
                        return response.resources;
                    }
                    return [];
                } catch (error) {
                    console.error(`获取分类 ${category} 资源失败:`, error);
                    return [];
                }
            }
            
            // 获取分类的显示名称
            getCategoryDisplayName(category) {
                const categoryNames = {
                    'traditionalCrafts': '传统工艺',
                    'traditionalFoods': '传统美食',
                    'traditionalMedicine': '传统医药',
                    'traditionalOpera': '传统戏曲',
                    'traditionalArchitecture': '传统建筑',
                    'traditionalFestivals': '传统节日'
                };
                return categoryNames[category] || category;
            }

            // 获取最丰富的分类
            getMostPopulatedCategory(categories) {
                if (!categories || Object.keys(categories).length === 0) {
                    return '暂无数据';
                }
                
                let maxCategory = '';
                let maxCount = 0;
                
                Object.entries(categories).forEach(([category, data]) => {
                    const count = data.resourceCount || 0;
                    if (count > maxCount) {
                        maxCount = count;
                        maxCategory = category;
                    }
                });
                
                return this.getCategoryDisplayName(maxCategory);
            }
            
            // 初始化分类筛选器事件监听
            initCategoryFilterListener() {
                const categoryFilter = document.getElementById('category-filter');
                if (categoryFilter) {
                    categoryFilter.addEventListener('change', async (event) => {
                        const selectedCategory = event.target.value;
                        
                        // 更新当前分类
                        this.currentCategory = selectedCategory || 'all';
                        
                        // 更新筛选条件
                        this.currentFilters = this.currentFilters || {};
                        this.currentFilters.category = selectedCategory || null;
                        
                        // 重置分页
                        this.pagination.currentPage = 1;
                        
                        // 重新渲染资源
                        await this.renderResources();
                        
                        // 更新统计信息
                        await this.updateResultsInfo();
                        
                        console.log(`分类筛选器变化: ${selectedCategory || 'all'}`);
                    });
                }
            }



            async forceRefreshData() {
                try {
                    console.log('执行强制刷新...');
                    this.showNotification('正在强制刷新数据...', 'info');
                    
                    // 清除所有缓存
                    if ('caches' in window) {
                        try {
                            const cacheNames = await caches.keys();
                            await Promise.all(cacheNames.map(name => caches.delete(name)));
                            console.log('已清除浏览器缓存');
                        } catch (error) {
                            console.warn('清除缓存失败:', error);
                        }
                    }
                    
                    // 强制重新加载数据
                    await this.updateStatistics();
                    await this.renderResources();
                    
                    this.showNotification('强制刷新完成', 'success');
                } catch (error) {
                    console.error('强制刷新失败:', error);
                    this.showNotification('强制刷新失败: ' + error.message, 'error');
                }
            }

            async importResources() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,.csv';
                input.multiple = false;
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            this.showNotification('正在导入资源...', 'info');
                            
                            const format = file.name.endsWith('.csv') ? 'csv' : 'json';
                            const fileContent = await this.readFileAsText(file);
                            
                            // 解析文件内容
                            let resources = [];
                            if (format === 'json') {
                                const data = JSON.parse(fileContent);
                                resources = Array.isArray(data) ? data : [data];
                            } else {
                                // CSV格式处理
                                const lines = fileContent.split('\n');
                                const headers = lines[0].split(',');
                                resources = lines.slice(1).map(line => {
                                    const values = line.split(',');
                                    const resource = {};
                                    headers.forEach((header, index) => {
                                        resource[header.trim()] = values[index]?.trim() || '';
                                    });
                                    return resource;
                                });
                            }
                            
                            // 批量添加资源
                            for (const resource of resources) {
                                const category = resource.category || 'traditionalFoods';
                                const resourceData = {
                                    id: this.generateId(),
                                    category: category,
                                    title: resource.title || '未命名资源',
                                    content: resource.content || resource.description || '',
                                    tags: Array.isArray(resource.tags) ? resource.tags : [],
                                    media: Array.isArray(resource.media) ? resource.media : [],
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                };
                                
                                // 使用API添加资源
                                const formData = new FormData();
                                formData.append('title', resourceData.title || '');
                                formData.append('description', resourceData.content || resourceData.description || '');
                                formData.append('tags', (resourceData.tags || []).join(','));
                                formData.append('keywords', (resourceData.keywords || []).join(','));
                                
                                const response = await fetch(`${this.resourceServerConfig.baseUrl}/${category}`, {
                                    method: 'POST',
                                    body: formData
                                });
                                
                                if (!response.ok) {
                                    throw new Error(`添加资源失败: ${response.status}`);
                                }
                            }
                            
                            this.showNotification(`成功导入 ${resources.length} 个资源`, 'success');
                            await this.updateStatistics();
                            await this.renderResources();
                        } catch (error) {
                            console.error('导入失败:', error);
                            this.showNotification('导入失败: ' + error.message, 'error');
                        }
                    }
                };
                
                input.click();
            }

            async readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(new Error('文件读取失败'));
                    reader.readAsText(file);
                });
            }

            async exportResources() {
                try {
                    // 显示导出选项对话框
                    const exportOptions = await this.showExportOptionsDialog();
                    if (!exportOptions) return; // 用户取消
                    
                    this.showNotification('正在准备导出...', 'info');
                    
                    // 获取要导出的资源
                    let resourcesToExport = [];
                    
                    if (exportOptions.scope === 'selected') {
                        // 导出选中的资源
                        const selectedResources = this.getSelectedResources();
                        if (selectedResources.length === 0) {
                            this.showNotification('请先选择要导出的资源', 'warning');
                            return;
                        }
                        resourcesToExport = selectedResources;
                    } else if (exportOptions.scope === 'current') {
                        // 导出当前分类的资源
                        const currentCategory = this.currentCategory || 'all';
                        if (currentCategory === 'all') {
                            // 导出所有资源
                            const allData = await this.getResources({ limit: 10000 });
                            resourcesToExport = Object.values(allData.resources).flatMap(category => 
                                Object.values(category)
                            );
                        } else {
                            // 导出当前分类的资源
                            const categoryData = await this.getResources({ 
                                category: currentCategory, 
                                limit: 10000 
                            });
                            resourcesToExport = Object.values(categoryData.resources[currentCategory] || {});
                        }
                    } else {
                        // 导出所有资源
                        const allData = await this.getResources({ limit: 10000 });
                        resourcesToExport = Object.values(allData.resources).flatMap(category => 
                            Object.values(category)
                        );
                    }
                    
                    if (resourcesToExport.length === 0) {
                        this.showNotification('没有找到可导出的资源', 'warning');
                        return;
                    }
                    
                    // 准备导出数据 - 只需要资源引用
                    const resourceRefs = resourcesToExport.map(resource => {
                        // 确保资源有正确的category和id
                        const category = resource.category || resource.type || 'unknown';
                        const id = resource.id || resource.title || 'unknown';
                        return { category, id };
                    }).filter(ref => ref.category !== 'unknown' && ref.id !== 'unknown');
                    
                    // 调用导出API
                    console.log('导出请求参数:', {
                        resources: resourceRefs,
                        format: exportOptions.format,
                        filename: exportOptions.filename
                    });
                    
                    const response = await fetch(`${this.resourceServerConfig.baseUrl}/export`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            resources: resourceRefs,
                            format: exportOptions.format,
                            filename: exportOptions.filename
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('导出API错误响应:', {
                            status: response.status,
                            statusText: response.statusText,
                            body: errorText
                        });
                        throw new Error(`导出失败: ${response.status} - ${errorText}`);
                    }
                        
                        // 下载文件
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g, '') || 
                                    `resources_export_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.${exportOptions.format}`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    
                    this.showNotification(`成功导出 ${resourcesToExport.length} 个资源`, 'success');
                    
                } catch (error) {
                    console.error('导出失败:', error);
                    this.showNotification('导出失败: ' + error.message, 'error');
                }
            }

            async showExportOptionsDialog() {
                return new Promise((resolve) => {
                    // 创建导出选项对话框
                    const dialog = document.createElement('div');
                    dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    dialog.innerHTML = `
                        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                            <h3 class="text-lg font-semibold mb-4">导出选项</h3>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">导出范围</label>
                                <select id="export-scope" class="w-full p-2 border border-gray-300 rounded-md">
                                    <option value="selected">选中的资源</option>
                                    <option value="current">当前分类</option>
                                    <option value="all">所有资源</option>
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">导出格式</label>
                                <select id="export-format" class="w-full p-2 border border-gray-300 rounded-md">
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV</option>
                                    <option value="txt">文本文件</option>
                                </select>
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">文件名</label>
                                <input type="text" id="export-filename" 
                                       class="w-full p-2 border border-gray-300 rounded-md"
                                       value="resources_export" placeholder="输入文件名">
                            </div>
                            
                            <div class="flex justify-end space-x-3">
                                <button id="export-cancel" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                    取消
                                </button>
                                <button id="export-confirm" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                    导出
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(dialog);
                    
                    // 绑定事件
                    const cancelBtn = dialog.querySelector('#export-cancel');
                    const confirmBtn = dialog.querySelector('#export-confirm');
                    
                    const cleanup = () => {
                        document.body.removeChild(dialog);
                    };
                    
                    cancelBtn.addEventListener('click', () => {
                        cleanup();
                        resolve(null);
                    });
                    
                    confirmBtn.addEventListener('click', () => {
                        const scope = dialog.querySelector('#export-scope').value;
                        const format = dialog.querySelector('#export-format').value;
                        const filename = dialog.querySelector('#export-filename').value.trim() || 'resources_export';
                        
                        cleanup();
                        resolve({ scope, format, filename });
                    });
                    
                    // 点击背景关闭
                    dialog.addEventListener('click', (e) => {
                        if (e.target === dialog) {
                            cleanup();
                            resolve(null);
                        }
                    });
                });
            }

            // 回到顶部功能
            scrollToTop() {
                const backToTopBtn = document.getElementById('back-to-top');
                if (backToTopBtn) {
                    // 添加点击反馈动画
                    backToTopBtn.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        backToTopBtn.style.transform = 'scale(1)';
                    }, 150);
                }
                
                // 平滑滚动到顶部
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
                // 滚动完成后隐藏按钮
                setTimeout(() => {
                    if (backToTopBtn) {
                        backToTopBtn.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                        backToTopBtn.classList.remove('opacity-100', 'scale-100');
                    }
                }, 1000);
            }

            // 监听滚动事件，控制回到顶部按钮的显示
            setupScrollListener() {
                const backToTopBtn = document.getElementById('back-to-top');
                if (!backToTopBtn) return;

                let scrollTimeout;
                window.addEventListener('scroll', () => {
                    // 清除之前的定时器
                    clearTimeout(scrollTimeout);
                    
                    // 设置新的定时器，实现防抖
                    scrollTimeout = setTimeout(() => {
                        const scrollY = window.pageYOffset;
                        const showThreshold = 400; // 显示阈值
                        const hideThreshold = 200; // 隐藏阈值
                        
                        if (scrollY > showThreshold) {
                            // 显示按钮
                            backToTopBtn.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                            backToTopBtn.classList.add('opacity-100', 'scale-100');
                            
                            // 添加轻微的弹跳效果
                            backToTopBtn.style.transform = 'translateY(0) scale(1)';
                        } else if (scrollY < hideThreshold) {
                            // 隐藏按钮
                            backToTopBtn.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                            backToTopBtn.classList.remove('opacity-100', 'scale-100');
                            
                            // 添加向下滑出效果
                            backToTopBtn.style.transform = 'translateY(20px) scale(0.95)';
                        }
                    }, 50); // 50ms 防抖延迟
                });
            }

            // 旧的导出功能已移除，使用新的批量导出功能

            async performExport(format, scope, options = {}) {
                try {
                    let exportData;
                    
                    if (scope === 'all') {
                        // 尝试服务端逐分类拉取，确保"全部导出"不受分页限制
                        const allData = {};
                        const knownCategories = [
                            'traditionalFoods',
                            'traditionalCrafts',
                            'traditionalOpera',
                            'traditionalFestivals',
                            'traditionalMedicine',
                            'traditionalArchitecture'
                        ];

                        // 先用内存中的分类键补充类别清单
                        const memCats = Object.keys(this.manager?.resources || {});
                        memCats.forEach(c => { if (!knownCategories.includes(c)) knownCategories.push(c); });

                        try {
                            const fetches = knownCategories.map(async (cat) => {
                                try {
                                    const resp = await fetch(`/api/resources/category/${encodeURIComponent(cat)}?_t=${Date.now()}`);
                                    if (resp.ok) {
                                        const data = await resp.json();
                                        if (data && data.category && data.category.resources && Object.keys(data.category.resources).length > 0) {
                                            allData[cat] = data.category.resources;
                                        }
                                    }
                                } catch (e) {
                                    // 忽略单类错误，后续用内存回补
                                }
                            });
                            await Promise.all(fetches);
                        } catch (e) {
                            // 忽略整体错误
                        }

                        // 回退：用内存数据补齐
                        const memAll = this.manager?.resources || {};
                        for (const [catName, resources] of Object.entries(memAll)) {
                            if (!allData[catName]) allData[catName] = {};
                            Object.assign(allData[catName], resources || {});
                        }

                        exportData = allData;
                    } else {
                        // 首先请求后端该分类的完整数据
                        let selected = {};
                        try {
                            const resp = await fetch(`/api/resources/category/${encodeURIComponent(scope)}?_t=${Date.now()}`);
                            if (resp.ok) {
                                const data = await resp.json();
                                if (data && data.success !== false && data.category && data.category.resources) {
                                    selected = data.category.resources;
                                }
                            }
                        } catch (e) {
                            // 忽略网络错误，转入本地回退
                        }

                        // 回退：从API获取数据
                        if (!selected || Object.keys(selected).length === 0) {
                            try {
                                const data = await this.getResources({ category: scope, limit: 1000 });
                                selected = data.resources[scope] || {};
                            } catch (error) {
                                console.error('获取分类数据失败:', error);
                                selected = {};
                            }
                        }

                        exportData = { [scope]: selected };
                    }

                    let content, filename, mimeType;
                    
                    // 规范化媒体URL（支持相对/绝对两种模式）
                    const normalizedData = this.prepareExportData(exportData, options);

                    if (format === 'json') {
                        content = JSON.stringify(normalizedData, null, 2);
                        filename = `resources_${scope}_${new Date().toISOString().slice(0, 10)}.json`;
                        mimeType = 'application/json';
                    } else if (format === 'csv') {
                        content = this.convertToCSV(normalizedData);
                        filename = `resources_${scope}_${new Date().toISOString().slice(0, 10)}.csv`;
                        mimeType = 'text/csv';
                    }

                    // 创建下载链接
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    this.showNotification(`资源已导出为 ${filename}`, 'success');
                } catch (error) {
                    console.error('导出失败:', error);
                    this.showNotification('导出失败: ' + error.message, 'error');
                }
            }

            // 将相对路径转换为绝对可访问网址
            getAbsoluteUrl(url, options = {}) {
                if (!url) return '';
                try {
                    // 已是绝对地址
                    if (/^https?:\/\//i.test(url)) return url;
                    if (/^\/\//.test(url)) return `${window.location.protocol}${url}`;

                    // 统一出一个以 / 开头的路径
                    const toPath = (u) => {
                        if (/^(uploads|resources)\//.test(u)) return `/${u}`;
                        if (u.startsWith('/')) return u;
                        return `/${u}`;
                    };
                    const normalizedPath = toPath(url);
                    // 自动识别Base Origin
                    const metaBase = (document.querySelector('meta[name="app-base-url"]') || {}).content || '';
                    let base = metaBase && /^https?:\/\//i.test(metaBase) ? metaBase : ((window.location && window.location.origin) ? window.location.origin : 'http://127.0.0.1:3000');
                    base = (base || '').toString().trim().replace(/\/$/, '');
                    const candidate = `${base}${normalizedPath}`;
                    return /^https?:\/\//i.test(candidate) ? candidate : normalizedPath;
                } catch (e) {
                    return url;
                }
            }

            // 规范化导出数据中媒体URL
            prepareExportData(data, options = {}) {
                const cloned = {};
                for (const [category, resources] of Object.entries(data || {})) {
                    cloned[category] = {};
                    for (const [id, resource] of Object.entries(resources || {})) {
                        const media = Array.isArray(resource.media) ? resource.media.map(file => ({
                            ...file,
                            url: this.getAbsoluteUrl(file && file.url ? file.url : '', options)
                        })) : [];

                        cloned[category][id] = {
                            ...resource,
                            media
                        };
                    }
                }
                return cloned;
            }

            convertToCSV(data) {
                const headers = ['分类', 'ID', '标题', '描述', '内容', '标签', '关键词', '媒体URLs', '创建时间', '更新时间'];
                const rows = [];

                for (const [category, resources] of Object.entries(data)) {
                    for (const [id, resource] of Object.entries(resources)) {
                        const mediaUrls = (resource.media || []).map(f => (f && f.url) ? f.url : '').filter(Boolean).join('|');
                        rows.push([
                            category,
                            id,
                            resource.title || '',
                            resource.description || '',
                            resource.content || '',
                            (resource.tags || []).join(';'),
                            (resource.keywords || []).join(';'),
                            mediaUrls,
                            resource.createdAt || '',
                            resource.updatedAt || ''
                        ]);
                    }
                }

                return [headers, ...rows]
                    .map(row => row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(','))
                    .join('\n');
            }

            // 批量操作功能
            showBatchActions() {
                const dialog = document.createElement('div');
                dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                dialog.innerHTML = `
                    <div class="bg-gradient-to-br from-white to-gray-50 rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fa fa-tasks text-primary mr-2"></i>批量操作
                            </h3>
                            <button id="close-batch-dialog" class="text-gray-400 hover:text-gray-600">
                                <i class="fa fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- 左侧：操作选择 -->
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">选择操作</label>
                                    <select id="batch-action" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="">请选择操作</option>
                                        <option value="delete">批量删除</option>
                                        <option value="export">批量导出</option>
                                        <option value="move">批量移动</option>
                                        <option value="tag">批量添加标签</option>
                                    </select>
                                </div>
                                
                                <div id="batch-options" class="hidden space-y-4">
                                    <!-- 动态选项将在这里显示 -->
                                </div>
                                
                                <div class="heritage-info rounded-lg p-3">
                                    <div class="flex items-start">
                                        <i class="fa fa-info-circle text-primary mt-1 mr-2"></i>
                                        <div class="text-sm">
                                            <div class="font-medium mb-1">操作说明：</div>
                                            <div id="batch-description">请选择要执行的操作类型</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右侧：资源选择 -->
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <label class="block text-sm font-medium text-gray-700">选择资源</label>
                                    <div class="flex space-x-2">
                                        <button id="select-all-batch" class="text-xs px-3 py-1.5 bg-primary text-white rounded-lg hover:bg-primary-700 transition-colors font-medium">
                                            <i class="fa fa-check-square mr-1"></i>全选
                                        </button>
                                        <button id="deselect-all-batch" class="text-xs px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium">
                                            <i class="fa fa-square mr-1"></i>取消全选
                                        </button>

                                    </div>
                                </div>
                                

                                

                                
                                <div class="max-h-80 overflow-y-auto border border-gray-300 rounded-lg p-2 bg-white">
                                    <div id="batch-resource-list" class="space-y-2">
                                        <!-- 资源列表将在这里显示 -->
                                    </div>
                                </div>
                                
                                <div class="flex justify-between items-center text-sm">
                                    <div class="text-gray-600">
                                        已选择 <span id="selected-count" class="font-semibold text-primary">0</span> 个资源
                                    </div>
                                    <div class="text-gray-500">
                                        总计 <span id="total-count" class="font-semibold">0</span> 个资源
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                            <button id="cancel-batch" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 btn-hover">
                                取消
                            </button>
                            <button id="execute-batch" class="px-4 py-2 bg-primary text-white rounded-lg btn-hover disabled:opacity-50">
                                <i class="fa fa-play mr-2"></i>执行操作
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(dialog);
                this.populateBatchResourceList();
                this.bindBatchActions(dialog);
            }

            async populateBatchResourceList() {
                const resourceList = document.getElementById('batch-resource-list');
                resourceList.innerHTML = '';

                try {
                    const data = await this.getResources({ limit: 1000 });
                    let totalCount = 0;
                    

                    
                    for (const [category, resources] of Object.entries(data.resources)) {
                        for (const [id, resource] of Object.entries(resources)) {
                            totalCount++;
                            const item = document.createElement('div');
                            item.className = 'flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg border border-transparent hover:border-primary transition-all duration-200 cursor-pointer resource-item';
                            item.setAttribute('data-category', category);

                            item.innerHTML = `
                                <div class="flex items-center space-x-3 flex-1">
                                    <input type="checkbox" class="batch-resource-checkbox w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2" data-category="${category}" data-id="${id}">
                                    <div class="w-8 h-8 bg-gradient-to-r from-primary to-primary-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i class="fa fa-file-alt text-white text-xs"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-sm text-gray-900 truncate">${resource.title || '未命名资源'}</div>
                                        <div class="flex items-center space-x-2 text-xs text-gray-500">
                                            <span class="px-2 py-1 bg-gray-100 rounded-full">${this.getCategoryName(category)}</span>
                                            <span class="text-gray-400">•</span>
                                            <span>${resource.createdAt ? new Date(resource.createdAt).toLocaleDateString() : '未知时间'}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // 点击整行也可以选中/取消选中
                            item.addEventListener('click', (e) => {
                                if (e.target.type !== 'checkbox') {
                                    const checkbox = item.querySelector('.batch-resource-checkbox');
                                    checkbox.checked = !checkbox.checked;
                                    this.updateSelectedCount();
                                }
                            });
                            
                            resourceList.appendChild(item);
                        }
                    }
                    
                    // 更新总计数量
                    const totalCountElement = document.getElementById('total-count');
                    if (totalCountElement) {
                        totalCountElement.textContent = totalCount;
                    }
                    
                } catch (error) {
                    console.error('获取资源列表失败:', error);
                    resourceList.innerHTML = '<div class="text-red-500 p-4">获取资源列表失败</div>';
                }
            }

            bindBatchActions(dialog) {
                const actionSelect = document.getElementById('batch-action');
                const optionsDiv = document.getElementById('batch-options');
                const executeBtn = document.getElementById('execute-batch');
                const descriptionDiv = document.getElementById('batch-description');
                

                


                // 操作说明映射
                const actionDescriptions = {
                    'delete': '删除选中的资源，此操作不可撤销。请谨慎操作。',
                    'export': '将选中的资源导出为JSON格式文件。',
                    'move': '将选中的资源移动到指定的分类。',
                    'tag': '为选中的资源添加新的标签。'
                };

                // 操作选择变化时显示相应选项
                actionSelect.addEventListener('change', () => {
                    const action = actionSelect.value;
                    optionsDiv.innerHTML = '';
                    optionsDiv.classList.add('hidden');
                    
                    // 更新操作说明
                    descriptionDiv.textContent = actionDescriptions[action] || '请选择要执行的操作类型';

                    if (action === 'move') {
                        optionsDiv.innerHTML = `
                            <label class="block text-sm font-medium text-gray-700 mb-2">目标分类</label>
                            <select id="target-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">请选择目标分类</option>
                                <option value="traditionalFoods">传统美食</option>
                                <option value="traditionalCrafts">传统工艺</option>
                                <option value="traditionalOpera">传统戏曲</option>
                                <option value="traditionalFestivals">传统节日</option>
                                <option value="traditionalMedicine">传统医药</option>
                                <option value="traditionalArchitecture">传统建筑</option>
                            </select>
                        `;
                        optionsDiv.classList.remove('hidden');
                    } else if (action === 'tag') {
                        optionsDiv.innerHTML = `
                            <label class="block text-sm font-medium text-gray-700 mb-2">添加标签</label>
                            <input type="text" id="new-tags" placeholder="用逗号分隔多个标签，如：文化,传统,艺术" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">标签将添加到现有标签中，不会覆盖原有标签</p>
                        `;
                        optionsDiv.classList.remove('hidden');
                    
                    } else if (action === 'export') {
                        optionsDiv.innerHTML = `
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">导出格式</label>
                                    <select id="export-format" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="json">JSON 格式</option>
                                        <option value="csv">CSV 格式</option>
                                        <option value="txt">文本格式</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">文件名</label>
                                    <input type="text" id="export-filename" value="exported_resources" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                                <div class="text-sm text-gray-600">
                                    将导出选中的资源为指定格式文件
                                </div>
                            </div>
                        `;
                        optionsDiv.classList.remove('hidden');

                    }
                });

                // 全选/取消全选功能
                document.getElementById('select-all-batch').addEventListener('click', () => {
                    const checkboxes = document.querySelectorAll('.batch-resource-checkbox');
                    checkboxes.forEach(cb => cb.checked = true);
                    this.updateSelectedCount();
                });

                document.getElementById('deselect-all-batch').addEventListener('click', () => {
                    const checkboxes = document.querySelectorAll('.batch-resource-checkbox');
                    checkboxes.forEach(cb => cb.checked = false);
                    this.updateSelectedCount();
                });

                // 监听单个复选框变化
                document.addEventListener('change', (e) => {
                    if (e.target.classList.contains('batch-resource-checkbox')) {
                        this.updateSelectedCount();
                    }
                });

                // 执行批量操作
                executeBtn.addEventListener('click', async () => {
                    const action = actionSelect.value;
                    const selectedResources = this.getSelectedBatchResources();

                    if (!action) {
                        this.showNotification('请选择要执行的操作', 'warning');
                        return;
                    }

                    if (selectedResources.length === 0) {
                        this.showNotification('请选择要操作的资源', 'warning');
                        return;
                    }

                    // 禁用执行按钮，防止重复点击
                    executeBtn.disabled = true;
                    executeBtn.textContent = '执行中...';
                    executeBtn.className = 'px-4 py-2 bg-gray-400 text-white rounded-lg cursor-not-allowed';

                    try {
                        console.log('开始执行批量操作:', { action, resourceCount: selectedResources.length });
                        
                        await this.executeBatchAction(action, selectedResources);
                        
                        // 操作成功，关闭对话框
                        document.body.removeChild(dialog);
                        
                        // 显示成功通知
                        this.showNotification(`批量操作完成，已处理 ${selectedResources.length} 个资源`, 'success');
                        
                    } catch (error) {
                        console.error('批量操作执行失败:', error);
                        this.showNotification('批量操作失败: ' + error.message, 'error');
                    } finally {
                        // 恢复按钮状态
                        executeBtn.disabled = false;
                        executeBtn.textContent = '执行操作';
                        executeBtn.className = 'px-4 py-2 bg-primary text-white rounded-lg hover:bg-red-700 btn-hover';
                    }
                });

                // 取消操作
                document.getElementById('cancel-batch').addEventListener('click', () => {
                    document.body.removeChild(dialog);
                });

                // 关闭对话框
                document.getElementById('close-batch-dialog').addEventListener('click', () => {
                    document.body.removeChild(dialog);
                });
            }

            getSelectedBatchResources() {
                const checkboxes = document.querySelectorAll('.batch-resource-checkbox:checked');
                return Array.from(checkboxes).map(cb => ({
                    category: cb.dataset.category,
                    id: cb.dataset.id
                }));
            }

            async executeBatchAction(action, resources) {
                try {
                    let options = {};
                    
                    // 根据操作类型准备选项
                    switch (action) {
                        case 'move':
                            const targetCategory = document.getElementById('target-category').value;
                            if (!targetCategory) {
                                this.showNotification('请选择目标分类', 'warning');
                                return;
                            }
                            options.targetCategory = targetCategory;
                            break;
                            
                        case 'tag':
                            const newTags = document.getElementById('new-tags').value.split(',').map(t => t.trim()).filter(t => t);
                            if (newTags.length === 0) {
                                this.showNotification('请输入要添加的标签', 'warning');
                                return;
                            }
                            options.tags = newTags;
                            break;
                            

                            
                        case 'export':
                            const exportFormat = document.getElementById('export-format').value;
                            const exportFilename = document.getElementById('export-filename').value || 'exported_resources';
                            options.format = exportFormat;
                            options.filename = exportFilename;
                            break;
                            

                    }
                    
                    // 显示确认对话框
                    let confirmMessage = '';
                    switch (action) {
                        case 'delete':
                            confirmMessage = `确定要删除选中的 ${resources.length} 个资源吗？此操作不可撤销。`;
                            break;
                        case 'move':
                            confirmMessage = `确定要将选中的 ${resources.length} 个资源移动到 ${this.getCategoryName(options.targetCategory)} 吗？`;
                            break;
                        case 'tag':
                            confirmMessage = `确定要为选中的 ${resources.length} 个资源添加标签 "${options.tags.join(', ')}" 吗？`;
                            break;


                        case 'export':
                            confirmMessage = `确定要导出选中的 ${resources.length} 个资源吗？`;
                            break;
                        default:
                            confirmMessage = `确定要执行批量操作 "${action}" 吗？`;
                    }
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    // 显示进度指示器
                    this.showBatchProgress(resources.length);
                    
                    // 调用批量操作API
                    console.log('发送批量操作请求:', { action, resources, options });
                    
                    const result = await this.batchOperation(action, resources, options);
                    
                    // 隐藏进度指示器
                    this.hideBatchProgress();
                    
                    // 处理结果
                    if (result.success) {
                        // 安全地获取summary，避免解构undefined
                        const summary = result.summary || { success: 0, failed: 0 };
                        let message = '';
                        
                        switch (action) {
                            case 'delete':
                                message = `成功删除 ${summary.success || 0} 个资源`;
                                break;
                            case 'move':
                                message = `成功移动 ${summary.success || 0} 个资源到 ${this.getCategoryName(options.targetCategory)}`;
                                break;
                            case 'tag':
                                message = `成功为 ${summary.success || 0} 个资源添加标签`;
                                break;


                            case 'export':
                                // 处理导出结果
                                if (result.results && result.results.success) {
                                    await this.handleBatchExport(result.results.success, options.format, options.filename);
                                }
                                message = `成功导出 ${summary.success || 0} 个资源`;
                                break;
                            default:
                                message = `批量操作完成：成功 ${summary.success || 0} 个，失败 ${summary.failed || 0} 个`;
                        }
                        
                        if (summary.failed > 0) {
                            message += `，${summary.failed} 个操作失败`;
                        }
                        
                        this.showNotification(message, (summary.failed || 0) > 0 ? 'warning' : 'success');
                        
                        // 显示详细结果
                        if (result.results && result.results.failed && result.results.failed.length > 0) {
                            this.showBatchResults(result.results);
                        }
                        
                        // 刷新资源列表和统计信息
                        await this.forceRefreshData();
                        
                    } else {
                        throw new Error(result.error || '批量操作失败');
                    }
                    
                } catch (error) {
                    this.hideBatchProgress();
                    this.showNotification('批量操作失败: ' + error.message, 'error');
                    console.error('批量操作错误:', error);
                }
            }

            // 视图模式切换
            toggleViewMode() {
                // 这个方法现在由下拉菜单选项处理
                console.log('视图模式切换已改为下拉菜单方式');
            }

            // 初始化视图模式
            initViewMode() {
                const grid = document.getElementById('resources-grid');
                const currentMode = localStorage.getItem('resourceViewMode') || 'grid';
                this.switchViewMode(currentMode);
                this.updateViewModeUI(currentMode);
            }

            // 切换视图模式
            switchViewMode(mode) {
                const grid = document.getElementById('resources-grid');
                grid.dataset.viewMode = mode;
                localStorage.setItem('resourceViewMode', mode);
                
                // 根据模式设置不同的布局
                switch (mode) {
                    case 'grid':
                        grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 lg:gap-7';
                        break;
                    case 'list':
                    grid.className = 'space-y-4';
                        break;
                    case 'compact':
                        grid.className = 'grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-3 lg:gap-4';
                        break;
                    case 'detail':
                        grid.className = 'space-y-6';
                        break;
                    default:
                        grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 lg:gap-7';
                }
                
                // 重新渲染资源
                    this.renderResources();
                this.updateViewModeUI(mode);
                
                const modeNames = {
                    'grid': '网格视图',
                    'list': '列表视图', 
                    'compact': '紧凑视图',
                    'detail': '详细视图'
                };
                
                this.showNotification(`已切换到${modeNames[mode]}`, 'info');
            }

            // 更新视图模式UI
            updateViewModeUI(selectedMode) {
                // 移除所有选中状态
                document.querySelectorAll('.view-mode-option').forEach(option => {
                    option.classList.remove('bg-green-50', 'border-green-200');
                    const checkIcon = option.querySelector('.fa-check');
                    if (checkIcon) checkIcon.classList.add('hidden');
                });
                
                // 设置选中状态
                const selectedOption = document.querySelector(`[data-mode="${selectedMode}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('bg-green-50', 'border-green-200');
                    const checkIcon = selectedOption.querySelector('.fa-check');
                    if (checkIcon) checkIcon.classList.remove('hidden');
                }
                
                // 更新按钮图标
                const btn = document.getElementById('view-mode-btn');
                const iconMap = {
                    'grid': 'fa-th-large',
                    'list': 'fa-list',
                    'compact': 'fa-th',
                    'detail': 'fa-file-alt'
                };
                
                if (btn) {
                    const icon = btn.querySelector('.fa-th-large, .fa-list, .fa-th, .fa-file-alt');
                    if (icon) {
                        icon.className = `fa ${iconMap[selectedMode]} mr-1 lg:mr-2`;
                    }
                }
            }

            renderResourcesAsList() {
                const grid = document.getElementById('resources-grid');
                grid.innerHTML = '';

                // 重新加载资源并渲染为列表格式
                this.renderResources();
            }

            // 显示批量操作进度
            showBatchProgress(totalItems) {
                const progressDialog = document.createElement('div');
                progressDialog.id = 'batch-progress-dialog';
                progressDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                progressDialog.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">正在执行批量操作</h3>
                            <p class="text-gray-600 mb-4">请稍候，正在处理 <span id="progress-count">${totalItems}</span> 个资源...</p>
                            <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                                <div id="progress-bar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div class="text-sm text-gray-500">
                                <span id="progress-percentage">0%</span> 完成
                            </div>
                            <div class="mt-4 text-xs text-gray-400">
                                <i class="fa fa-info-circle mr-1"></i>
                                操作完成后将自动刷新资源列表
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(progressDialog);
                
                // 模拟进度更新
                this.updateBatchProgress(0, totalItems);
            }
            
            // 更新批量操作进度
            updateBatchProgress(current, total) {
                const progressBar = document.getElementById('progress-bar');
                const progressPercentage = document.getElementById('progress-percentage');
                const progressCount = document.getElementById('progress-count');
                
                if (progressBar && progressPercentage && progressCount) {
                    const percentage = Math.min((current / total) * 100, 100);
                    progressBar.style.width = `${percentage}%`;
                    progressPercentage.textContent = `${Math.round(percentage)}%`;
                    progressCount.textContent = `${current}/${total}`;
                }
            }

            // 隐藏批量操作进度
            hideBatchProgress() {
                const progressDialog = document.getElementById('batch-progress-dialog');
                if (progressDialog) {
                    document.body.removeChild(progressDialog);
                }
            }

            // 显示批量操作结果
            showBatchResults(results) {
                const resultsDialog = document.createElement('div');
                resultsDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                resultsDialog.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fa fa-clipboard-check text-primary mr-2"></i>批量操作结果
                            </h3>
                            <button class="text-gray-400 hover:text-gray-600 transition-colors" onclick="this.closest('.fixed').remove()">
                                <i class="fa fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            ${results.failed && results.failed.length > 0 ? `
                                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fa fa-exclamation-triangle text-red-500 mr-2"></i>
                                        <h4 class="text-red-800 font-medium">失败的操作 (${results.failed.length})</h4>
                                    </div>
                                    <div class="space-y-2 max-h-32 overflow-y-auto">
                                        ${results.failed.map(item => `
                                            <div class="text-sm text-red-700 bg-red-100 p-2 rounded">
                                                <div class="font-medium">${this.getCategoryName(item.category)}/${item.id}</div>
                                                <div class="text-xs mt-1">${item.error}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${results.success && results.success.length > 0 ? `
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fa fa-check-circle text-green-500 mr-2"></i>
                                        <h4 class="text-green-800 font-medium">成功的操作 (${results.success.length})</h4>
                                    </div>
                                    <div class="text-sm text-green-700">
                                        <div class="flex items-center">
                                            <i class="fa fa-thumbs-up mr-2"></i>
                                        所有操作都成功完成
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                            <button class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors" onclick="this.closest('.fixed').remove()">
                                关闭
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(resultsDialog);
            }

            // 处理批量导出结果
            async handleBatchExport(exportedResources, format = 'json', filename = 'exported_resources') {
                try {
                    if (!exportedResources || exportedResources.length === 0) {
                        this.showNotification('没有可导出的资源', 'error');
                        return;
                    }
                    
                    // 执行导出，使用指定的格式和文件名
                    await this.performBatchExport(exportedResources, format, filename);
                } catch (error) {
                    console.error('处理批量导出失败:', error);
                    this.showNotification('导出失败: ' + error.message, 'error');
                }
            }
            
            // 执行批量导出
            async performBatchExport(resources, format, filename) {
                try {
                    this.showNotification('正在准备导出文件...', 'info');
                    
                    const response = await fetch('/api/resources/export', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            resources: resources,
                            format: format,
                            filename: filename
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '导出失败');
                    }
                    
                    // 获取文件名
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let downloadFilename = `${filename}_${new Date().toISOString().slice(0, 10)}.${format}`;
                    
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="([^"]+)"/);
                        if (filenameMatch) {
                            downloadFilename = filenameMatch[1];
                        }
                    }
                    
                    // 获取文件内容
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    
                    // 创建下载链接
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = downloadFilename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showNotification(`成功导出 ${resources.length} 个资源`, 'success');
                    
                } catch (error) {
                    console.error('批量导出失败:', error);
                    throw error;
                }
            }

            // 更新选中计数
            updateSelectedCount() {
                const selectedCount = document.querySelectorAll('.batch-resource-checkbox:checked').length;
                const countElement = document.getElementById('selected-count');
                if (countElement) {
                    countElement.textContent = selectedCount;
                }
            }
            

            






            // 资源预览功能
            async showResourcePreview(resource) {
                try {
                    console.log('开始预览资源:', resource);
                    
                    // 从服务器获取最新的资源数据，确保预览内容与编辑内容一致
                    const data = await this.getResources({ category: resource.category, limit: 100 });
                    const categoryResources = data.resources[resource.category];
                    
                    if (!categoryResources) {
                        this.showNotification(`分类不存在: ${resource.category}`, 'error');
                        return;
                    }

                    const latestResource = categoryResources[resource.id];
                    if (!latestResource) {
                        this.showNotification(`资源不存在: ${resource.id}`, 'error');
                        return;
                    }

                    // 使用最新的资源数据
                    const resourceToShow = {
                        ...latestResource,
                        category: resource.category,
                        id: resource.id
                    };

                    console.log('准备显示的资源数据:', resourceToShow);

                    // 临时设置currentResource以便renderResourceMedia能正确判断
                    const originalCurrentResource = this.currentResource;
                    this.currentResource = resourceToShow;
                    
                    // 跟踪当前打开的详细信息模态框
                    this.currentPreviewModal = {
                        category: resource.category,
                        id: resource.id,
                        resource: resourceToShow
                    };
                
                const preview = document.createElement('div');
                preview.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9998]';
                
                // 添加点击外部关闭功能
                preview.addEventListener('click', (e) => {
                    if (e.target === preview) {
                        preview.remove();
                        this.currentPreviewModal = null;
                    }
                });
                preview.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                    <h2 class="text-2xl font-bold text-gray-800">${resourceToShow.title || '未命名资源'}</h2>
                                <button class="text-gray-400 hover:text-gray-600" onclick="this.closest('.fixed').remove(); window.resourceManagerUI.currentPreviewModal = null;">
                                    <i class="fa fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800 mb-2">基本信息</h3>
                                    <div class="space-y-2">
                                        <div><strong>分类:</strong> ${this.getCategoryName(resourceToShow.category)}</div>
                                        <div><strong>描述:</strong> ${resourceToShow.description || '暂无描述'}</div>
                                            <div><strong>创建时间:</strong> ${resourceToShow.createdAt ? new Date(resourceToShow.createdAt).toLocaleString() : '未知'}</div>
                                            <div><strong>更新时间:</strong> ${resourceToShow.updatedAt ? new Date(resourceToShow.updatedAt).toLocaleString() : '未知'}</div>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800 mb-2">标签和关键词</h3>
                                    <div class="space-y-2">
                                        <div>
                                            <strong>标签:</strong>
                                            <div class="flex flex-wrap gap-1 mt-1">
                                                    ${(resourceToShow.tags || []).length > 0 ? 
                                                        (resourceToShow.tags || []).map(tag => 
                                                    `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${tag}</span>`
                                                        ).join('') : 
                                                        '<span class="text-gray-500 text-xs">暂无标签</span>'
                                                    }
                                            </div>
                                        </div>
                                        <div>
                                            <strong>关键词:</strong>
                                            <div class="flex flex-wrap gap-1 mt-1">
                                                    ${(resourceToShow.keywords || []).length > 0 ? 
                                                        (resourceToShow.keywords || []).map(keyword => 
                                                    `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">${keyword}</span>`
                                                        ).join('') : 
                                                        '<span class="text-gray-500 text-xs">暂无关键词</span>'
                                                    }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">详细内容</h3>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p class="text-gray-700 whitespace-pre-wrap">${resourceToShow.content || '暂无内容'}</p>
                                </div>
                            </div>
                            ${resourceToShow.history ? `
                                <div class="mt-6">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-2">历史背景</h3>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <p class="text-gray-700 whitespace-pre-wrap">${resourceToShow.history}</p>
                                    </div>
                                </div>
                            ` : ''}
                            ${this.renderResourceMedia(resourceToShow)}
                        </div>
                        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                            <button onclick="window.resourceManagerUI.editResource('${resourceToShow.category}', '${resourceToShow.id}')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fa fa-edit mr-2"></i>编辑
                            </button>
                            <button onclick="window.resourceManagerUI.deleteResourceFromPreview('${resourceToShow.category}', '${resourceToShow.id}', this)" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                <i class="fa fa-trash mr-2"></i>删除
                            </button>
                        </div>
                    </div>
                `;

                                    // 恢复原来的currentResource
                    this.currentResource = originalCurrentResource;
                    document.body.appendChild(preview);
                    
                    console.log('资源预览模态框已创建');
                } catch (error) {
                    console.error('预览资源失败:', error);
                    this.showNotification('预览失败: ' + error.message, 'error');
                }
            }



            async showCategoryStats() {
                try {
                    // 添加点击动画
                    this.animateStatCardClick('category');
                    
                    // 显示加载状态
                    const dialog = document.createElement('div');
                    dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    dialog.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] flex flex-col">
                            <!-- 固定标题栏 -->
                            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-white rounded-t-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center">
                                        <i class="fa fa-folder text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">分类统计详情</h3>
                                        <p class="text-sm text-gray-600">各分类资源使用情况分析</p>
                                    </div>
                                </div>
                                <button class="text-gray-400 hover:text-gray-600 transition-colors" onclick="this.closest('.fixed').remove()">
                                    <i class="fa fa-times text-xl"></i>
                                </button>
                            </div>
                            <!-- 可滚动内容区域 -->
                            <div class="flex-1 overflow-y-auto p-6">
                                <div class="flex items-center justify-center py-12">
                                <div class="text-center">
                                        <div class="w-16 h-16 bg-gradient-to-br from-orange-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <i class="fa fa-spinner fa-spin text-white text-2xl"></i>
                                        </div>
                                        <p class="text-gray-600 font-medium">正在加载分类统计...</p>
                                        <p class="text-sm text-gray-500 mt-1">请稍候，正在分析各分类数据</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(dialog);

                    // 从服务器获取最新统计信息
                    const data = await this.getStatistics();
                    const stats = data.statistics;
                    
                    // 组装分类数据
                    const categories = stats.categories || {};
                    const categoryEntries = Object.entries(categories).map(([category, info]) => ({
                        key: category,
                        name: this.getCategoryName(category),
                        resources: (info && info.resourceCount) || 0,
                        media: (info && info.mediaCount) || 0,
                        updated: (info && info.lastUpdated) ? new Date(info.lastUpdated).toLocaleDateString() : '未知',
                        size: (info && info.totalSize) || 0
                    }));
                    
                    // 计算总计
                    const totalResources = categoryEntries.reduce((sum, e) => sum + e.resources, 0);
                    const totalMedia = categoryEntries.reduce((sum, e) => sum + e.media, 0);
                    const totalSize = categoryEntries.reduce((sum, e) => sum + e.size, 0);
                    
                    // 按资源数降序排序
                    categoryEntries.sort((a, b) => b.resources - a.resources);
                    
                    // 更新对话框内容
                    dialog.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] flex flex-col">
                            <!-- 固定标题栏 -->
                            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-white rounded-t-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center">
                                        <i class="fa fa-folder text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">分类统计详情</h3>
                                        <p class="text-sm text-gray-600">各分类资源使用情况分析</p>
                                    </div>
                                </div>
                                <button class="text-gray-400 hover:text-gray-600 transition-colors" onclick="this.closest('.fixed').remove()">
                                    <i class="fa fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <!-- 可滚动内容区域 -->
                            <div class="flex-1 overflow-y-auto p-6">
                                <!-- 总体概览卡片 -->
                                <div class="bg-gradient-to-r from-orange-50 to-yellow-50 p-6 rounded-xl border border-orange-200 mb-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-lg font-bold text-orange-800 flex items-center">
                                            <i class="fa fa-chart-pie mr-2"></i>分类概览
                                        </h4>
                                        <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium">
                                            ${categoryEntries.length} 个分类
                                        </span>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-blue-600">${categoryEntries.length}</div>
                                            <div class="text-sm text-gray-600">总分类数</div>
                                    </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-green-600">${totalResources}</div>
                                            <div class="text-sm text-gray-600">总资源数</div>
                                </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-purple-600">${totalMedia}</div>
                                            <div class="text-sm text-gray-600">总文件数</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-orange-600">${this.formatFileSize(totalSize)}</div>
                                            <div class="text-sm text-gray-600">总存储空间</div>
                                        </div>
                                            </div>
                                    </div>
                            
                            <!-- 分类详细列表 -->
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-lg font-bold text-gray-800 flex items-center">
                                            <i class="fa fa-list mr-2 text-orange-500"></i>各分类详情
                                        </h4>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-xs text-gray-500">按资源数量排序</span>
                                            <i class="fa fa-sort-amount-desc text-xs text-orange-500"></i>
                                        </div>
                                    </div>
                                    
                                ${categoryEntries.map((entry, index) => {
                                    const resourcePercent = totalResources > 0 ? Math.round((entry.resources / totalResources) * 100) : 0;
                                    const mediaPercent = totalMedia > 0 ? Math.round((entry.media / totalMedia) * 100) : 0;
                                        const sizePercent = totalSize > 0 ? Math.round((entry.size / totalSize) * 100) : 0;
                                        
                                        // 根据资源数量确定状态颜色
                                        let statusColor = 'gray';
                                        let statusText = '较少';
                                        if (entry.resources >= 20) {
                                            statusColor = 'green';
                                            statusText = '丰富';
                                        } else if (entry.resources >= 10) {
                                            statusColor = 'blue';
                                            statusText = '良好';
                                        } else if (entry.resources >= 5) {
                                            statusColor = 'yellow';
                                            statusText = '一般';
                                        }
                                    
                                    return `
                                            <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-all duration-300 cursor-pointer transform hover:-translate-y-1" 
                                             onclick="window.resourceManagerUI.filterByCategory('${entry.key}')">
                                                
                                                <!-- 头部信息 -->
                                                <div class="flex justify-between items-start mb-4">
                                                    <div class="flex items-center space-x-3">
                                                        <div class="w-10 h-10 bg-gradient-to-br from-orange-400 to-orange-500 rounded-lg flex items-center justify-center">
                                                            <span class="text-white font-bold text-sm">#${index + 1}</span>
                                </div>
                                                        <div>
                                                            <h5 class="font-bold text-gray-800 text-lg">${entry.name}</h5>
                                                            <p class="text-sm text-gray-500">最后更新: ${entry.updated}</p>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center space-x-2">
                                                        <span class="px-3 py-1 bg-${statusColor}-100 text-${statusColor}-700 rounded-full text-xs font-medium">
                                                            ${statusText}
                                                        </span>
                                                        <span class="text-xs text-gray-400">点击查看</span>
                                                    </div>
                                    </div>
                                            
                                                <!-- 统计数据 -->
                                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                                                        <div class="text-xl font-bold text-blue-600">${entry.resources}</div>
                                                        <div class="text-xs text-gray-600">资源数量</div>
                                                        <div class="text-xs text-blue-500 font-medium">${resourcePercent}%</div>
                                </div>
                                                    <div class="text-center p-3 bg-green-50 rounded-lg">
                                                        <div class="text-xl font-bold text-green-600">${entry.media}</div>
                                                        <div class="text-xs text-gray-600">文件数量</div>
                                                        <div class="text-xs text-green-500 font-medium">${mediaPercent}%</div>
                                                </div>
                                                    <div class="text-center p-3 bg-purple-50 rounded-lg">
                                                        <div class="text-xl font-bold text-purple-600">${this.formatFileSize(entry.size)}</div>
                                                        <div class="text-xs text-gray-600">存储空间</div>
                                                        <div class="text-xs text-purple-500 font-medium">${sizePercent}%</div>
                                                </div>
                                                    <div class="text-center p-3 bg-orange-50 rounded-lg">
                                                        <div class="text-xl font-bold text-orange-600">${entry.resources > 0 ? Math.round(entry.media / entry.resources * 100) : 0}%</div>
                                                        <div class="text-xs text-gray-600">媒体覆盖率</div>
                                                        <div class="text-xs text-orange-500 font-medium">文件/资源</div>
                                                </div>
                                            </div>
                                            
                                            <!-- 进度条 -->
                                                <div class="space-y-3">
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-sm font-medium text-gray-700">资源占比</span>
                                                        <span class="text-sm font-bold text-orange-600">${resourcePercent}%</span>
                                                </div>
                                                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                                        <div class="bg-gradient-to-r from-orange-400 to-orange-500 h-3 rounded-full transition-all duration-1000" 
                                                             style="width: ${resourcePercent}%"></div>
                                                </div>
                                                    
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-sm font-medium text-gray-700">存储占比</span>
                                                        <span class="text-sm font-bold text-purple-600">${sizePercent}%</span>
                                                    </div>
                                                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                                        <div class="bg-gradient-to-r from-purple-400 to-purple-500 h-2 rounded-full transition-all duration-1000" 
                                                             style="width: ${sizePercent}%"></div>
                                                    </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                                <!-- 底部说明 -->
                                <div class="mt-6 p-4 bg-orange-50 rounded-lg border border-orange-200">
                                    <div class="flex items-center space-x-2">
                                        <i class="fa fa-info-circle text-orange-500"></i>
                                        <p class="text-sm text-orange-700">
                                            点击任意分类卡片可快速筛选并查看该分类的资源。分类按资源数量降序排列，便于识别最活跃的分类。
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('获取分类统计失败:', error);
                    // 显示错误信息
                    const dialog = document.querySelector('.fixed');
                    if (dialog) {
                        dialog.innerHTML = `
                            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 flex flex-col">
                                <!-- 固定标题栏 -->
                                <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-white rounded-t-lg">
                                    <h3 class="text-xl font-semibold text-gray-800">分类统计</h3>
                                    <button class="text-gray-400 hover:text-gray-600" onclick="this.closest('.fixed').remove()">
                                        <i class="fa fa-times text-xl"></i>
                                    </button>
                                </div>
                                <!-- 内容区域 -->
                                <div class="flex-1 p-6">
                                <div class="text-center py-8">
                                    <i class="fa fa-exclamation-triangle text-3xl text-red-500 mb-4"></i>
                                        <p class="text-red-600">获取分类统计失败</p>
                                    <p class="text-sm text-gray-600 mt-2">${error.message}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            }

            async showFileStats() {
                try {
                    // 添加点击动画
                    this.animateStatCardClick('file');
                    
                    // 显示加载状态
                    const dialog = document.createElement('div');
                    dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    dialog.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 flex flex-col">
                            <!-- 固定标题栏 -->
                            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-white rounded-t-lg">
                                <h3 class="text-xl font-semibold text-gray-800">文件统计</h3>
                                <button class="text-gray-400 hover:text-gray-600" onclick="this.closest('.fixed').remove()">
                                    <i class="fa fa-times text-xl"></i>
                                </button>
                            </div>
                            <!-- 可滚动内容区域 -->
                            <div class="flex-1 overflow-y-auto p-6">
                            <div class="flex items-center justify-center py-8">
                                <div class="text-center">
                                    <i class="fa fa-spinner fa-spin text-2xl text-blue-500 mb-2"></i>
                                        <p class="text-gray-600">正在加载文件统计...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(dialog);

                    // 从服务器获取最新统计信息
                    const data = await this.getStatistics();
                    const stats = data.statistics;
                    
                    // 更新对话框内容
                    dialog.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] flex flex-col">
                            <!-- 固定标题栏 -->
                            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-white rounded-t-lg">
                                <h3 class="text-xl font-semibold text-gray-800">媒体文件使用统计</h3>
                                <button class="text-gray-400 hover:text-gray-600" onclick="this.closest('.fixed').remove()">
                                    <i class="fa fa-times text-xl"></i>
                                </button>
                            </div>
                            <!-- 可滚动内容区域 -->
                            <div class="flex-1 overflow-y-auto p-6">
                            
                            <!-- 总体统计 -->
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                                    <h4 class="font-semibold text-blue-800">总媒体文件</h4>
                                    <p class="text-2xl font-bold text-blue-600">${stats.totalMedia || 0}</p>
                                    <p class="text-sm text-blue-600">个文件</p>
                                        </div>
                                <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                                    <h4 class="font-semibold text-green-800">总存储空间</h4>
                                    <p class="text-2xl font-bold text-green-600">${this.formatFileSize(stats.totalFileSize || 0)}</p>
                                    <p class="text-sm text-green-600">已使用</p>
                                        </div>
                                <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500">
                                    <h4 class="font-semibold text-yellow-800">有媒体资源</h4>
                                    <p class="text-2xl font-bold text-yellow-600">${stats.resourceUsage?.withMedia || 0}</p>
                                    <p class="text-sm text-yellow-600">个资源</p>
                                    </div>
                                <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500">
                                    <h4 class="font-semibold text-purple-800">无媒体资源</h4>
                                    <p class="text-2xl font-bold text-purple-600">${stats.resourceUsage?.withoutMedia || 0}</p>
                                    <p class="text-sm text-purple-600">个资源</p>
                                </div>
                            </div>
                            
                            <!-- 文件类型统计 -->
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-blue-800">图片文件</h4>
                                    <p class="text-2xl font-bold text-blue-600">${stats.mediaFiles?.images || 0}</p>
                                    <p class="text-sm text-blue-600">.jpg, .png, .webp</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-green-800">视频文件</h4>
                                    <p class="text-2xl font-bold text-green-600">${stats.mediaFiles?.videos || 0}</p>
                                    <p class="text-sm text-green-600">.mp4, .webm</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-yellow-800">音频文件</h4>
                                    <p class="text-2xl font-bold text-yellow-600">${stats.mediaFiles?.audio || 0}</p>
                                    <p class="text-sm text-yellow-600">.mp3, .wav</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-purple-800">文档文件</h4>
                                    <p class="text-2xl font-bold text-purple-600">${stats.mediaFiles?.documents || 0}</p>
                                    <p class="text-sm text-purple-600">.pdf, .doc</p>
                                </div>
                            </div>
                            
                            <!-- 文件类型详细分布 -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">文件类型详细分布</h4>
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 text-sm">
                                    ${Object.entries(stats.fileTypes || {}).map(([ext, count]) => 
                                        `<div class="flex justify-between items-center bg-white p-2 rounded border">
                                            <span class="font-mono">${ext}</span>
                                            <span class="font-semibold text-blue-600">${count}</span>
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                            
                            <!-- 使用说明 -->
                            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                                <p class="text-sm text-blue-800">
                                    <i class="fa fa-info-circle mr-1"></i>
                                    此统计显示的是资源实际使用的媒体文件。
                                </p>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('获取文件统计失败:', error);
                    // 显示错误信息
                    const dialog = document.querySelector('.fixed');
                    if (dialog) {
                        dialog.innerHTML = `
                            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 flex flex-col">
                                <!-- 固定标题栏 -->
                                <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-white rounded-t-lg">
                                    <h3 class="text-xl font-semibold text-gray-800">文件统计</h3>
                                    <button class="text-gray-400 hover:text-gray-600" onclick="this.closest('.fixed').remove()">
                                        <i class="fa fa-times text-xl"></i>
                                    </button>
                                </div>
                                <!-- 内容区域 -->
                                <div class="flex-1 p-6">
                                <div class="text-center py-8">
                                    <i class="fa fa-exclamation-triangle text-3xl text-red-500 mb-4"></i>
                                        <p class="text-red-600">获取文件统计失败</p>
                                    <p class="text-sm text-gray-600 mt-2">${error.message}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            }

            async showStorageStats() {
                try {
                    // 添加点击动画
                    this.animateStatCardClick('storage');
                    
                    // 显示加载状态
                    const dialog = document.createElement('div');
                    dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    dialog.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 flex flex-col">
                            <!-- 固定标题栏 -->
                            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-white rounded-t-lg">
                                <h3 class="text-xl font-semibold text-gray-800">存储统计</h3>
                                <button class="text-gray-400 hover:text-gray-600" onclick="this.closest('.fixed').remove()">
                                    <i class="fa fa-times text-xl"></i>
                                </button>
                            </div>
                            <!-- 可滚动内容区域 -->
                            <div class="flex-1 overflow-y-auto p-6">
                            <div class="flex items-center justify-center py-8">
                                <div class="text-center">
                                    <i class="fa fa-spinner fa-spin text-2xl text-blue-500 mb-2"></i>
                                        <p class="text-gray-600">正在加载存储统计...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(dialog);

                    // 从服务器获取最新统计信息
                    const data = await this.getStatistics();
                    const stats = data.statistics;
                    
                    // 更新对话框内容
                    dialog.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 flex flex-col max-h-[90vh] storage-modal">
                            <!-- 固定标题栏 -->
                            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-white rounded-t-lg flex-shrink-0">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-gold to-yellow-500 rounded-lg flex items-center justify-center">
                                        <i class="fa fa-hdd text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">存储空间详情</h3>
                                        <p class="text-sm text-gray-600">存储使用情况与优化建议</p>
                                    </div>
                                </div>
                                <button class="text-gray-400 hover:text-gray-600 transition-colors" onclick="this.closest('.fixed').remove()">
                                    <i class="fa fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <!-- 主要内容区域 -->
                            <div class="flex-1 flex overflow-hidden modal-content">
                                <!-- 左侧：存储概览 -->
                                <div class="w-1/3 bg-gradient-to-b from-yellow-50 to-orange-50 p-6 border-r border-gray-200 flex flex-col storage-sidebar">
                                    <!-- 存储状态卡片 -->
                                    <div class="bg-white rounded-xl p-6 shadow-sm border border-yellow-200 mb-6 storage-status-card">
                                        <div class="flex items-center justify-between mb-4">
                                            <h4 class="text-lg font-bold text-gray-800 flex items-center">
                                                <i class="fa fa-chart-pie mr-2 text-gold"></i>存储状态
                                            </h4>
                                            <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-medium">
                                                ${this.getStorageStatus(stats.totalFileSize || 0)}
                                            </span>
                                </div>
                                        
                                        <!-- 存储进度条 -->
                                                        <div class="mb-4">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-sm font-medium text-gray-700">使用率</span>
                                                <span class="text-sm font-bold text-gold">${this.getStorageUsagePercentage(stats.totalFileSize || 0)}%</span>
                    </div>
                                            <div class="bg-gray-200 rounded-full h-3 overflow-hidden progress-bar">
                                                <div class="bg-gradient-to-r from-gold to-yellow-500 h-3 rounded-full transition-all duration-1000" 
                                                     style="width: ${this.getStorageUsagePercentage(stats.totalFileSize || 0)}%"></div>
                        </div>
                                        </div>
                                        
                                        <!-- 核心数据 -->
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <i class="fa fa-hdd text-gold mr-2"></i>
                                                    <span class="text-sm text-gray-600">总存储</span>
                                                </div>
                                                <span class="font-bold text-gold">${this.formatFileSize(stats.totalFileSize || 0)}</span>
                                            </div>
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <i class="fa fa-file text-blue-500 mr-2"></i>
                                                    <span class="text-sm text-gray-600">文件数量</span>
                                                </div>
                                                <span class="font-bold text-blue-600">${stats.totalMedia || 0}</span>
                                            </div>
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <i class="fa fa-chart-line text-green-500 mr-2"></i>
                                                    <span class="text-sm text-gray-600">平均大小</span>
                                                </div>
                                                <span class="font-bold text-green-600">${this.formatFileSize((stats.totalFileSize || 0) / Math.max(stats.totalMedia || 1, 1))}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 快速操作 -->
                                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                                        <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                            <i class="fa fa-tools mr-2 text-blue-600"></i>快速操作
                                        </h4>
                                        <div class="space-y-2">
                                            <button class="w-full text-left p-3 rounded-lg hover:bg-gray-50 transition-colors flex items-center quick-action-btn">
                                                <i class="fa fa-trash text-red-500 mr-3"></i>
                                                <span class="text-sm text-gray-700">清理缓存</span>
                                            </button>
                                            <button class="w-full text-left p-3 rounded-lg hover:bg-gray-50 transition-colors flex items-center quick-action-btn">
                                                <i class="fa fa-compress text-orange-500 mr-3"></i>
                                                <span class="text-sm text-gray-700">压缩文件</span>
                                            </button>
                                            <button class="w-full text-left p-3 rounded-lg hover:bg-gray-50 transition-colors flex items-center quick-action-btn">
                                                <i class="fa fa-cloud text-blue-500 mr-3"></i>
                                                <span class="text-sm text-gray-700">备份数据</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 右侧：详细统计 -->
                                <div class="flex-1 overflow-y-auto p-6">
                                    <div class="space-y-6">
                                        <!-- 文件类型统计 -->
                                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm stats-card">
                                            <div class="p-6 border-b border-gray-100">
                                                <h4 class="font-bold text-lg text-gray-900 flex items-center">
                                                    <i class="fa fa-file mr-2 text-blue-600"></i>文件类型分布
                                                </h4>
                                                <p class="text-sm text-gray-600 mt-1">当前存储中各种文件格式的数量统计</p>
                                            </div>
                                            <div class="p-6">
                                                <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                                        ${Object.entries(stats.fileTypes || {}).map(([type, count]) => `
                                                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 hover:bg-gray-100 transition-colors">
                                                            <div class="flex items-center justify-between mb-2">
                                                                <span class="font-medium text-gray-800">${type.toLowerCase()}</span>
                                                                <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-medium">${count} 个</span>
                                                            </div>
                                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                                <div class="bg-blue-500 h-2 rounded-full" style="width: ${(count / Math.max(stats.totalMedia || 1, 1)) * 100}%"></div>
                                                            </div>
                                </div>
                                        `).join('')}
                                                    ${Object.keys(stats.fileTypes || {}).length === 0 ? `
                                                        <div class="col-span-full text-center py-8 text-gray-500">
                                                            <i class="fa fa-file text-3xl mb-2"></i>
                                                            <p>暂无文件类型数据</p>
                                                        </div>
                                                    ` : ''}
                                                </div>
                        </div>
                    </div>
                    
                                        <!-- 分类资源统计 -->
                                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm stats-card">
                                            <div class="p-6 border-b border-gray-100">
                                                <h4 class="font-bold text-lg text-gray-900 flex items-center">
                                                    <i class="fa fa-folder mr-2 text-green-600"></i>分类资源分布
                                                </h4>
                                                <p class="text-sm text-gray-600 mt-1">各分类的资源数量分布情况</p>
                    </div>
                                            <div class="p-6">
                                                <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                                                    ${Object.entries(stats.categories || {}).map(([category, data]) => `
                                                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 hover:bg-gray-100 transition-colors">
                                                            <div class="flex items-center justify-between mb-2">
                                                                <span class="font-medium text-gray-800">${this.getCategoryDisplayName(category)}</span>
                                                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-medium">${data.resourceCount || 0} 个</span>
                                    </div>
                                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                                <div class="bg-green-500 h-2 rounded-full" style="width: ${(data.resourceCount || 0) / Math.max(stats.totalResources || 1, 1) * 100}%"></div>
                                </div>
                                    </div>
                                                    `).join('')}
                                                    ${Object.keys(stats.categories || {}).length === 0 ? `
                                                        <div class="col-span-full text-center py-8 text-gray-500">
                                                            <i class="fa fa-folder text-3xl mb-2"></i>
                                                            <p>暂无分类数据</p>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 存储优化建议 -->
                                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200 stats-card">
                                            <div class="p-6 border-b border-blue-100">
                                                <h4 class="font-bold text-lg text-blue-800 flex items-center">
                                                    <i class="fa fa-lightbulb mr-2"></i>存储优化建议
                                                </h4>
                                                <p class="text-sm text-blue-700 mt-1">基于当前使用情况提供的优化建议</p>
                                            </div>
                                            <div class="p-6">
                                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                                    <div class="bg-white p-4 rounded-lg border border-blue-100 hover:shadow-md transition-shadow">
                                                        <div class="flex items-center mb-3">
                                                            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                                                <i class="fa fa-trash text-red-500 text-sm"></i>
                                                            </div>
                                                            <span class="font-medium text-gray-800">定期清理</span>
                                                        </div>
                                                        <p class="text-sm text-gray-600">定期清理未使用的文件和重复资源，释放存储空间</p>
                                                    </div>
                                                    <div class="bg-white p-4 rounded-lg border border-blue-100 hover:shadow-md transition-shadow">
                                                        <div class="flex items-center mb-3">
                                                            <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center mr-3">
                                                                <i class="fa fa-compress text-orange-500 text-sm"></i>
                                                            </div>
                                                            <span class="font-medium text-gray-800">压缩优化</span>
                                                        </div>
                                                        <p class="text-sm text-gray-600">压缩大文件以节省存储空间，提高传输效率</p>
                                                    </div>
                                                    <div class="bg-white p-4 rounded-lg border border-blue-100 hover:shadow-md transition-shadow">
                                                        <div class="flex items-center mb-3">
                                                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                                                <i class="fa fa-cloud text-blue-500 text-sm"></i>
                                                            </div>
                                                            <span class="font-medium text-gray-800">云端备份</span>
                                                        </div>
                                                        <p class="text-sm text-gray-600">备份重要的资源文件到云端，确保数据安全</p>
                                                    </div>
                                                    <div class="bg-white p-4 rounded-lg border border-blue-100 hover:shadow-md transition-shadow">
                                                        <div class="flex items-center mb-3">
                                                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                                <i class="fa fa-chart-line text-green-500 text-sm"></i>
                                                            </div>
                                                            <span class="font-medium text-gray-800">监控使用</span>
                                                        </div>
                                                        <p class="text-sm text-gray-600">定期监控存储使用情况，及时发现问题</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 移除图表创建代码，因为现在使用纯文字显示
                } catch (error) {
                    console.error('获取存储统计失败:', error);
                    // 显示错误信息
                    const dialog = document.querySelector('.fixed');
                    if (dialog) {
                        dialog.innerHTML = `
                            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 flex flex-col">
                                <!-- 固定标题栏 -->
                                <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-white rounded-t-lg">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-red-600 rounded-lg flex items-center justify-center">
                                            <i class="fa fa-exclamation-triangle text-white text-lg"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-xl font-bold text-gray-800">存储统计</h3>
                                            <p class="text-sm text-gray-600">获取数据时出现错误</p>
                                        </div>
                                    </div>
                                    <button class="text-gray-400 hover:text-gray-600 transition-colors" onclick="this.closest('.fixed').remove()">
                                        <i class="fa fa-times text-xl"></i>
                                    </button>
                                </div>
                                <!-- 内容区域 -->
                                <div class="flex-1 p-6">
                                <div class="text-center py-8">
                                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <i class="fa fa-exclamation-triangle text-2xl text-red-500"></i>
                                        </div>
                                        <h4 class="text-lg font-semibold text-red-600 mb-2">获取存储统计失败</h4>
                                        <p class="text-sm text-gray-600 mb-4">${error.message}</p>
                                        <button class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors" onclick="this.closest('.fixed').remove()">
                                            <i class="fa fa-times mr-2"></i>关闭
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            }

            // 总览统计对话框（用于第一个卡片）
            async showOverallStats() {
                try {
                    // 添加点击动画
                    this.animateStatCardClick('overall');
                    
                    const dialog = document.createElement('div');
                    dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    dialog.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl max-w-xl w-full mx-4 flex flex-col">
                            <!-- 固定标题栏 -->
                            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-white rounded-t-lg">
                                <h3 class="text-xl font-semibold text-gray-800">总体统计</h3>
                                <button class="text-gray-400 hover:text-gray-600" onclick="this.closest('.fixed').remove()">
                                    <i class="fa fa-times text-xl"></i>
                                </button>
                            </div>
                            <!-- 可滚动内容区域 -->
                            <div class="flex-1 overflow-y-auto p-6">
                            <div class="flex items-center justify-center py-8">
                                <div class="text-center">
                                    <i class="fa fa-spinner fa-spin text-2xl text-blue-500 mb-2"></i>
                                        <p class="text-gray-600">正在加载总体统计...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(dialog);

                    const data = await this.getStatistics();
                    const stats = data.statistics || {};
                    const fileTypes = stats.fileTypes || {};
                    const categories = stats.categories || {};
                    
                    dialog.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] flex flex-col">
                            <!-- 固定标题栏 -->
                            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-white rounded-t-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-slate-600 to-slate-800 rounded-lg flex items-center justify-center">
                                        <i class="fa fa-chart-line text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">总体统计</h3>
                                        <p class="text-sm text-gray-600">资源库完整数据分析</p>
                                    </div>
                                </div>
                                <button class="text-gray-400 hover:text-gray-600 transition-colors" onclick="this.closest('.fixed').remove()">
                                    <i class="fa fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <!-- 可滚动内容区域 -->
                            <div class="flex-1 overflow-y-auto p-6">
                                <!-- 核心指标卡片 -->
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                    <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-gray-600 text-sm font-medium">总资源数</p>
                                                <p class="text-3xl font-bold mt-1 text-gray-900">${stats.totalResources || 0}</p>
                                                <p class="text-gray-500 text-xs mt-1">个资源条目</p>
                                    </div>
                                            <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center">
                                                <i class="fa fa-database text-blue-600 text-xl"></i>
                                    </div>
                                </div>
                                    </div>
                                    
                                    <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-gray-600 text-sm font-medium">总文件数</p>
                                                <p class="text-3xl font-bold mt-1 text-gray-900">${stats.totalMedia || 0}</p>
                                                <p class="text-gray-500 text-xs mt-1">个媒体文件</p>
                                            </div>
                                            <div class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center">
                                                <i class="fa fa-file-text text-green-600 text-xl"></i>
                                            </div>
                                    </div>
                                </div>

                                    <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                                        <div class="flex items-center justify-between">
                                <div>
                                                <p class="text-gray-600 text-sm font-medium">总存储空间</p>
                                                <p class="text-2xl font-bold mt-1 text-gray-900">${this.formatFileSize(stats.totalFileSize || 0)}</p>
                                                <p class="text-gray-500 text-xs mt-1">已占用空间</p>
                                            </div>
                                            <div class="w-12 h-12 bg-orange-50 rounded-lg flex items-center justify-center">
                                                <i class="fa fa-hdd text-orange-600 text-xl"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-gray-600 text-sm font-medium">分类数量</p>
                                                <p class="text-3xl font-bold mt-1 text-gray-900">${stats.totalCategories || Object.keys(categories).length || 0}</p>
                                                <p class="text-gray-500 text-xs mt-1">个资源分类</p>
                                            </div>
                                            <div class="w-12 h-12 bg-purple-50 rounded-lg flex items-center justify-center">
                                                <i class="fa fa-folder text-purple-600 text-xl"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 图表区域 -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <!-- 文件类型分布 -->
                                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                                        <div class="mb-4">
                                            <h4 class="font-bold text-lg text-gray-900 mb-1 flex items-center">
                                                <span class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center mr-3">
                                                    <i class="fa fa-pie-chart text-blue-600 text-sm"></i>
                                                </span>
                                                文件类型分布
                                            </h4>
                                            <p class="text-sm text-gray-600">显示所有资源中各种文件格式的数量统计</p>
                                        </div>
                                        <div class="flex items-center justify-center space-x-6 min-h-[200px]">
                                            <div class="flex-1 min-w-0 max-w-md">
                                                <canvas id="overallFileTypeChart" width="200" height="150"></canvas>
                                            </div>
                                            <div class="text-sm text-gray-600 space-y-2 w-32 flex-shrink-0">
                                        ${Object.keys(fileTypes).length > 0 ?
                                            Object.entries(fileTypes).map(([type, count]) => `
                                                        <div class="flex justify-between items-center">
                                                            <span class="font-medium truncate">${type.toLowerCase()}</span>
                                                            <span class="bg-gray-100 px-2 py-1 rounded text-xs ml-2 flex-shrink-0">${count} 个</span>
                                    </div>
                                            `).join('') :
                                            '<div class="text-gray-500 text-sm">暂无数据</div>'}
                                            </div>
                                </div>
                                </div>

                                    <!-- 各分类资源数 -->
                                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                                        <div class="mb-4">
                                            <h4 class="font-bold text-lg text-gray-900 mb-1 flex items-center">
                                                <span class="w-8 h-8 bg-green-50 rounded-lg flex items-center justify-center mr-3">
                                                    <i class="fa fa-bar-chart text-green-600 text-sm"></i>
                                                </span>
                                                各分类资源数
                                            </h4>
                                            <p class="text-sm text-gray-600">显示不同分类的资源数量统计</p>
                                                </div>
                                        <div class="mt-4">
                                            <canvas id="overallCategoryChart" width="400" height="250"></canvas>
                                    </div>
                                </div>
                                </div>
                                

                            </div>
                        </div>
                    `;
                    
                    // 创建文件类型分布图表
                    setTimeout(() => {
                        this.createOverallFileTypeChart(fileTypes);
                    }, 100);

                    // 创建分类资源数柱状图
                    setTimeout(() => {
                        // 转换数据格式：从 {category: {resourceCount: number}} 转换为 {category: number}
                        const categoryData = {};
                        if (categories) {
                            Object.entries(categories).forEach(([category, data]) => {
                                categoryData[category] = data.resourceCount || 0;
                            });
                        }
                        this.createOverallCategoryChart(categoryData);
                    }, 200);
                } catch (error) {
                    console.error('获取总体统计失败:', error);
                    const dialog = document.querySelector('.fixed');
                    if (dialog) {
                        dialog.innerHTML = `
                            <div class="bg-white rounded-lg shadow-xl max-w-xl w-full mx-4 flex flex-col">
                                <!-- 固定标题栏 -->
                                <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-white rounded-t-lg">
                                    <h3 class="text-xl font-semibold text-gray-800">总体统计</h3>
                                    <button class="text-gray-400 hover:text-gray-600" onclick="this.closest('.fixed').remove()">
                                        <i class="fa fa-times text-xl"></i>
                                    </button>
                                </div>
                                <!-- 内容区域 -->
                                <div class="flex-1 p-6">
                                <div class="text-center py-8">
                                    <i class="fa fa-exclamation-triangle text-3xl text-red-500 mb-4"></i>
                                        <p class="text-red-600">获取总体统计失败</p>
                                    <p class="text-sm text-gray-600 mt-2">${error.message}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            }

            // 快速菜单功能
            showQuickMenu() {
                const menu = document.createElement('div');
                menu.id = 'quick-menu-overlay';
                menu.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                menu.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4" role="dialog" aria-modal="true">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">快速操作菜单</h3>
                            <button class="text-gray-400 hover:text-gray-600" onclick="document.getElementById('quick-menu-overlay')?.remove()" aria-label="关闭">
                                <i class="fa fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="window.resourceManagerUI.quickAction('add')" class="p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                                <i class="fa fa-plus text-2xl text-blue-500 mb-2"></i>
                                <div class="text-sm font-medium">添加资源</div>
                            </button>
                            <button onclick="window.resourceManagerUI.quickAction('refresh')" class="p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                                <i class="fa fa-refresh text-2xl text-green-500 mb-2"></i>
                                <div class="text-sm font-medium">刷新数据</div>
                            </button>
                            <button onclick="window.resourceManagerUI.quickAction('export')" class="p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-colors">
                                <i class="fa fa-download text-2xl text-yellow-500 mb-2"></i>
                                <div class="text-sm font-medium">导出资源</div>
                            </button>
                            <button onclick="window.resourceManagerUI.quickAction('import')" class="p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                                <i class="fa fa-upload text-2xl text-purple-500 mb-2"></i>
                                <div class="text-sm font-medium">导入资源</div>
                            </button>
                            <button onclick="window.resourceManagerUI.quickAction('batch')" class="p-4 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
                                <i class="fa fa-tasks text-2xl text-red-500 mb-2"></i>
                                <div class="text-sm font-medium">批量操作</div>
                            </button>
                            <button onclick="window.resourceManagerUI.quickAction('stats')" class="p-4 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors">
                                <i class="fa fa-chart-bar text-2xl text-indigo-500 mb-2"></i>
                                <div class="text-sm font-medium">统计信息</div>
                            </button>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="text-sm text-gray-600 mb-2">最近操作</div>
                            <div class="space-y-1 text-xs text-gray-500">
                                <div>• 添加了 3 个传统美食资源</div>
                                <div>• 导出了传统工艺分类</div>
                                <div>• 更新了 2 个资源信息</div>
                            </div>
                        </div>
                    </div>
                `;
                // 点击遮罩关闭
                menu.addEventListener('click', (e) => {
                    if (e.target === menu) {
                        menu.remove();
                    }
                });
                document.body.appendChild(menu);
            }

            quickAction(action) {
                // 关闭菜单（仅移除本组件覆盖层）
                const overlay = document.getElementById('quick-menu-overlay');
                if (overlay) {
                    overlay.remove();
                }

                // 执行相应的快速操作
                switch (action) {
                    case 'add':
                        this.showResourceModal();
                        break;
                    case 'refresh':
                        this.forceRefreshData();
                        break;
                    case 'export':
                        this.exportResources();
                        break;
                    case 'import':
                        this.importResources();
                        break;
                    case 'batch':
                        this.showBatchActions();
                        break;
                    case 'stats':
                        this.showOverallStats();
                        break;
                    default:
                        console.log('未知的快速操作:', action);
                }
            }

            async editResource(category, id) {
                console.log('编辑资源被调用:', category, id);
                
                try {
                    // 显示加载状态
                    this.showNotification('正在加载资源信息...', 'info');
                    
                    // 优化：使用更精确的查询参数
                    const data = await this.getResources({ 
                        category, 
                        limit: 1000, // 增加限制确保能找到目标资源

                        page: 1 
                    });

                    const categoryResources = data.resources[category];
                    
                    if (!categoryResources) {
                        this.showNotification(`分类不存在: ${this.getCategoryName(category)}`, 'error');
                        return;
                    }

                    const resource = categoryResources[id];
                    console.log('找到的资源:', resource);
                    
                    if (resource) {
                        // 创建新的资源对象，确保包含完整的元数据
                        const resourceWithMetadata = {
                            ...resource,
                            category: category,
                            id: id,
                            // 确保时间戳字段存在
                            createdAt: resource.createdAt || new Date().toISOString(),
                            updatedAt: resource.updatedAt || new Date().toISOString()
                        };
                        
                        console.log('准备传递给模态框的资源:', resourceWithMetadata);
                        
                        // 隐藏加载通知
                        this.hideNotification();
                        
                        // 显示编辑模态框
                        this.showResourceModal(resourceWithMetadata);
                        
                        // 显示成功通知
                        this.showNotification(`正在编辑: ${resource.title || '未命名资源'}`, 'success');
                    } else {
                        console.error(`资源不存在: ${id}`);
                        console.log('该分类下的资源ID列表:', Object.keys(categoryResources));
                        this.showNotification(`资源不存在或已被删除`, 'error');
                    }
                } catch (error) {
                    console.error('编辑资源失败:', error);
                    this.showNotification('编辑失败: ' + error.message, 'error');
                }
            }

            async deleteResource(category, id) {
                try {
                    // 先获取资源信息用于显示
                    const data = await this.getResources({ category, limit: 100 });
                    const categoryResources = data.resources[category];
                    const resource = categoryResources?.[id];
                const resourceName = resource?.title || '未知资源';
                
                // 显示自定义确认模态框
                this.showDeleteConfirmModal(resourceName, category, id);
                } catch (error) {
                    console.error('获取资源信息失败:', error);
                    this.showNotification('获取资源信息失败', 'error');
                }
            }

            showDeleteConfirmModal(resourceName, category, id) {
                const modal = document.getElementById('delete-confirm-modal');
                const message = document.getElementById('delete-confirm-message');
                const cancelBtn = document.getElementById('delete-cancel');
                const confirmBtn = document.getElementById('delete-confirm');
                
                // 获取资源详细信息
                this.getResources({ category, limit: 100 }).then(data => {
                    const categoryResources = data.resources[category];
                    const resource = categoryResources?.[id];
                    
                    let messageText = `您确定要删除"${resourceName}"吗？此操作无法撤销。`;
                    
                    // 如果有媒体文件，显示详细信息
                    if (resource && resource.media && Array.isArray(resource.media) && resource.media.length > 0) {
                        const mediaCount = resource.media.length;
                        const mediaTypes = {};
                        
                        resource.media.forEach(media => {
                            const type = media.type || '未知';
                            mediaTypes[type] = (mediaTypes[type] || 0) + 1;
                        });
                        
                        const mediaDetails = Object.entries(mediaTypes)
                            .map(([type, count]) => `${count}个${this.getMediaTypeName(type)}`)
                            .join('、');
                        
                        messageText += `\n\n同时将删除 ${mediaCount} 个媒体文件：${mediaDetails}`;
                    }
                
                // 设置确认消息
                    message.innerHTML = messageText.replace(/\n/g, '<br>');
                }).catch(error => {
                    console.error('获取资源详情失败:', error);
                message.textContent = `您确定要删除"${resourceName}"吗？此操作无法撤销。`;
                });
                
                // 显示模态框
                modal.classList.remove('hidden');
                
                // 绑定事件
                const handleCancel = () => {
                    modal.classList.add('hidden');
                    cancelBtn.removeEventListener('click', handleCancel);
                    confirmBtn.removeEventListener('click', handleConfirm);
                };
                
                const handleConfirm = async () => {
                    try {
                        // 先执行删除动画
                        await this.animateResourceDeletion(category, id);
                        
                        // 使用批量操作API删除资源
                        const result = await this.batchOperation('delete', [{ category, id }]);
                        
                        if (result.success) {
                            // 验证资源是否真的被删除了
                            const isDeleted = await this.verifyResourceDeleted(category, id);
                            
                            if (isDeleted) {
                        this.showNotification('资源删除成功', 'success');
                                
                                // 关闭所有相关的模态框
                                this.closeAllRelatedModals(category, id);
                                
                                // 清理API缓存，确保获取最新数据
                                this.clearApiCache();
                                
                                // 重新渲染当前页面
                                await this.renderResources();
                                
                                // 更新统计信息
                                await this.updateStatistics();
                            } else {
                                this.showNotification('资源删除可能失败，请刷新页面检查', 'warning');
                            }
                            } else {
                            throw new Error(result.error || '删除失败');
                        }
                    } catch (error) {
                        console.error('删除失败:', error);
                        this.showNotification('删除失败: ' + (error?.message || '未知错误'), 'error');
                    } finally {
                        modal.classList.add('hidden');
                        cancelBtn.removeEventListener('click', handleCancel);
                        confirmBtn.removeEventListener('click', handleConfirm);
                    }
                };
                
                cancelBtn.addEventListener('click', handleCancel);
                confirmBtn.addEventListener('click', handleConfirm);
            }

            // 从预览模态框中删除资源
            async deleteResourceFromPreview(category, id, buttonElement) {
                try {
                    console.log('从预览模态框删除资源:', category, id);
                    
                    // 禁用删除按钮，防止重复点击
                    buttonElement.disabled = true;
                    buttonElement.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>删除中...';
                    
                    // 先执行删除动画
                    await this.animateResourceDeletion(category, id);
                    
                    // 使用批量操作API删除资源
                    const result = await this.batchOperation('delete', [{ category, id }]);
                    
                    if (result.success) {
                        // 验证资源是否真的被删除了
                        const isDeleted = await this.verifyResourceDeleted(category, id);
                        
                        if (isDeleted) {
                            this.showNotification('资源删除成功', 'success');
                            
                            // 关闭预览模态框
                            const previewModal = buttonElement.closest('.fixed');
                            if (previewModal) {
                                previewModal.remove();
                            }
                            
                            // 清理API缓存，确保获取最新数据
                            this.clearApiCache();
                            
                            // 重新渲染当前页面
                            await this.renderResources();
                            
                            // 更新统计信息
                            await this.updateStatistics();
                        } else {
                            this.showNotification('资源删除可能失败，请刷新页面检查', 'warning');
                            // 恢复按钮状态
                            buttonElement.disabled = false;
                            buttonElement.innerHTML = '<i class="fa fa-trash mr-2"></i>删除';
                        }
                    } else {
                        throw new Error(result.error || '删除失败');
                    }
                } catch (error) {
                    console.error('删除失败:', error);
                    this.showNotification('删除失败: ' + (error?.message || '未知错误'), 'error');
                    // 恢复按钮状态
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="fa fa-trash mr-2"></i>删除';
                }
            }

            // 关闭所有相关的模态框
            closeAllRelatedModals(category, id) {
                console.log('关闭所有相关的模态框:', category, id);
                
                // 关闭资源预览模态框
                const previewModals = document.querySelectorAll('.fixed[style*="z-index: 9998"], .fixed[style*="z-index: 9999"]');
                previewModals.forEach(modal => {
                    // 检查模态框是否包含被删除的资源信息
                    const modalContent = modal.innerHTML;
                    if (modalContent.includes(`category: '${category}'`) || 
                        modalContent.includes(`category: "${category}"`) ||
                        modalContent.includes(`'${id}'`) ||
                        modalContent.includes(`"${id}"`)) {
                        console.log('关闭资源预览模态框');
                        modal.remove();
                    }
                });

                // 关闭删除确认模态框
                const deleteConfirmModal = document.getElementById('delete-confirm-modal');
                if (deleteConfirmModal && !deleteConfirmModal.classList.contains('hidden')) {
                    console.log('关闭删除确认模态框');
                    deleteConfirmModal.classList.add('hidden');
                }

                // 关闭编辑模态框（如果正在编辑被删除的资源）
                const editModals = document.querySelectorAll('.fixed[style*="z-index: 9997"]');
                editModals.forEach(modal => {
                    const modalContent = modal.innerHTML;
                    if (modalContent.includes(`category: '${category}'`) || 
                        modalContent.includes(`category: "${category}"`) ||
                        modalContent.includes(`'${id}'`) ||
                        modalContent.includes(`"${id}"`)) {
                        console.log('关闭编辑模态框');
                        modal.remove();
                    }
                });

                // 关闭任何其他可能包含被删除资源信息的模态框
                const allModals = document.querySelectorAll('.fixed');
                allModals.forEach(modal => {
                    const modalContent = modal.innerHTML;
                    // 检查是否包含被删除的资源信息
                    if ((modalContent.includes(`category: '${category}'`) || 
                         modalContent.includes(`category: "${category}"`) ||
                         modalContent.includes(`'${id}'`) ||
                         modalContent.includes(`"${id}"`)) &&
                        !modal.classList.contains('hidden')) {
                        console.log('关闭其他相关模态框');
                        modal.remove();
                    }
                });
            }

            // 刷新当前打开的详细信息模态框
            async refreshCurrentPreviewModal(updatedResource) {
                if (!this.currentPreviewModal) {
                    console.log('没有当前打开的详细信息模态框需要刷新');
                    return;
                }
                
                // 检查是否是同一个资源
                if (this.currentPreviewModal.category === updatedResource.category && 
                    this.currentPreviewModal.id === updatedResource.id) {
                    
                    console.log('刷新当前打开的详细信息模态框');
                    
                    // 关闭当前的详细信息模态框
                    const currentPreviewModal = document.querySelector('.fixed[style*="z-index: 9998"]');
                    if (currentPreviewModal) {
                        currentPreviewModal.remove();
                    }
                    
                    // 重新打开详细信息模态框，显示更新后的数据
                    await this.showResourcePreview({
                        category: updatedResource.category,
                        id: updatedResource.id
                    });
                }
            }

            // 更新页面上的资源卡片 - 优化版本
            async updateResourceCardInPage(updatedResource) {
                const grid = document.getElementById('resources-grid');
                if (!grid) {
                    console.warn('资源网格不存在，无法更新资源卡片');
                    return;
                }
                
                // 查找对应的资源卡片
                const cards = grid.querySelectorAll('.resource-card');
                let targetCard = null;
                
                for (const card of cards) {
                    // 检查卡片是否包含编辑按钮，且按钮的data属性匹配目标category和id
                    const editBtn = card.querySelector('button[data-category][data-id]');
                    if (editBtn && editBtn.getAttribute('data-category') === updatedResource.category && editBtn.getAttribute('data-id') === updatedResource.id) {
                        targetCard = card;
                        break;
                    }
                }
                
                if (!targetCard) {
                    console.warn('未找到要更新的资源卡片，可能需要重新渲染页面');
                    // 如果找不到卡片，重新渲染整个页面
                    await this.renderResources();
                    return;
                }
                
                // 添加更新中的视觉状态
                targetCard.classList.add('updating');
                targetCard.style.opacity = '0.7';
                targetCard.style.transform = 'scale(0.98)';
                
                // 创建新的资源卡片
                const newCard = this.createResourceCard(updatedResource);
                if (!newCard) {
                    console.warn('创建新资源卡片失败');
                    targetCard.classList.remove('updating');
                    targetCard.style.opacity = '1';
                    targetCard.style.transform = 'scale(1)';
                    return;
                }
                
                // 添加更新完成的标记
                newCard.classList.add('just-updated');
                newCard.setAttribute('data-updated-at', new Date().toISOString());
                
                // 替换旧卡片
                targetCard.parentNode.replaceChild(newCard, targetCard);
                
                // 执行更新动画
                setTimeout(() => {
                    newCard.style.opacity = '1';
                    newCard.style.transform = 'translateX(0) scale(1)';
                    
                    // 添加更新成功的闪烁效果
                    newCard.classList.add('update-highlight');
                    
                    // 移除动画类
                    setTimeout(() => {
                        newCard.classList.remove('update-highlight');
                        newCard.classList.remove('just-updated');
                    }, 800);
                }, 50);
                
                console.log('资源卡片已更新:', updatedResource.id);
            }

            // 显示更新成功的视觉反馈
            showUpdateSuccessFeedback(updatedResource) {
                // 验证更新是否成功
                this.validateUpdateSuccess(updatedResource);
                
                // 创建临时成功提示
                const successTip = document.createElement('div');
                successTip.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
                successTip.innerHTML = `
                    <div class="flex items-center">
                        <i class="fa fa-check-circle mr-2"></i>
                        <span>资源"${updatedResource.title || '未命名'}"已更新</span>
                    </div>
                `;
                
                document.body.appendChild(successTip);
                
                // 显示动画
                setTimeout(() => {
                    successTip.style.transform = 'translateX(0)';
                }, 100);
                
                // 自动隐藏
                setTimeout(() => {
                    successTip.style.transform = 'translateX(full)';
                    setTimeout(() => {
                        if (successTip.parentNode) {
                            successTip.parentNode.removeChild(successTip);
                        }
                    }, 300);
                }, 3000);
                
                // 高亮显示更新后的卡片
                const grid = document.getElementById('resources-grid');
                if (grid) {
                    const cards = grid.querySelectorAll('.resource-card');
                    for (const card of cards) {
                        const editBtn = card.querySelector('button[data-category][data-id]');
                        if (editBtn && editBtn.getAttribute('data-category') === updatedResource.category && editBtn.getAttribute('data-id') === updatedResource.id) {
                            // 添加高亮效果
                            card.style.boxShadow = '0 0 20px rgba(34, 197, 94, 0.5)';
                            card.style.borderColor = '#22c55e';
                            
                            // 移除高亮效果
                            setTimeout(() => {
                                card.style.boxShadow = '';
                                card.style.borderColor = '';
                            }, 2000);
                            break;
                        }
                    }
                }
            }

            // 验证更新是否成功
            async validateUpdateSuccess(updatedResource) {
                try {
                    // 延迟验证，确保服务器数据已更新
                    setTimeout(async () => {
                        const data = await this.getResources({ 
                            category: updatedResource.category, 
                            limit: 1000,
                            page: 1 
                        });
                        
                        const categoryResources = data.resources[updatedResource.category];
                        const serverResource = categoryResources[updatedResource.id];
                        
                        if (!serverResource) {
                            console.warn('服务器数据可能未同步，建议刷新页面');
                            this.showNotification('数据同步中，建议刷新页面', 'warning');
                            return;
                        }
                        
                        // 检查关键字段是否一致
                        const keyFields = ['title', 'content', 'updatedAt'];
                        const isConsistent = keyFields.every(field => {
                            return serverResource[field] === updatedResource[field];
                        });
                        
                        if (!isConsistent) {
                            console.warn('本地数据与服务器数据不一致，重新渲染页面');
                            await this.renderResources();
                        }
                    }, 1000);
                } catch (error) {
                    console.error('验证更新失败:', error);
                }
            }

            // 添加新资源到页面
            async addNewResourceToPage(resource) {
                const grid = document.getElementById('resources-grid');
                if (!grid) {
                    console.warn('资源网格不存在，无法添加新资源');
                    return;
                }
                
                // 创建新资源卡片
                const card = this.createResourceCard(resource);
                if (!card) {
                    console.warn('创建资源卡片失败');
                    return;
                }
                
                // 将卡片插入到网格的开头
                if (grid.firstChild) {
                    grid.insertBefore(card, grid.firstChild);
                } else {
                    grid.appendChild(card);
                }
                
                // 执行添加动画
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateX(0)';
                }, 50);
                
                // 更新结果统计（包含动态获取资源总数）
                await this.updateResultsInfo();
                
                console.log('新资源已添加到页面:', resource.id);
            }

            // 检查并加载更多资源
            async checkAndLoadMoreResources() {
                const grid = document.getElementById('resources-grid');
                if (!grid) {
                    console.warn('资源网格不存在');
                    return;
                }
                
                // 获取当前页面的资源数量
                const currentCards = grid.querySelectorAll('.resource-card');
                const currentCount = currentCards.length;
                
                console.log(`当前页面有 ${currentCount} 个资源卡片，页面大小: ${this.pageSize}`);
                
                // 如果当前页面的资源数量少于页面大小，说明需要补充资源
                if (currentCount < this.pageSize) {
                    console.log('当前页面资源不足，需要补充资源');
                    
                    // 检查是否是最后一页
                    if (this.pagination && this.pagination.currentPage >= this.pagination.totalPages) {
                        console.log('当前是最后一页，没有更多资源可以补充');
                        return;
                    }
                    
                    // 计算需要补充的数量
                    const needToLoad = this.pageSize - currentCount;
                    console.log(`需要补充 ${needToLoad} 个资源`);
                    
                    // 获取下一页的资源来补充当前页面
                    await this.loadMoreResourcesToCurrentPage(needToLoad);
                }
            }

            // 按分类筛选资源
            async filterByCategory(category) {
                try {
                    // 关闭统计对话框
                    const dialog = document.querySelector('.fixed');
                    if (dialog) {
                        dialog.remove();
                    }
                    
                    // 设置分类筛选
                    const categoryFilter = document.getElementById('category-filter');
                    if (categoryFilter) {
                        categoryFilter.value = category;
                    }
                    
                    // 更新当前分类和筛选条件
                    this.currentCategory = category;
                    this.currentFilters = this.currentFilters || {};
                    this.currentFilters.category = category;
                    
                    // 重置到第一页
                    this.pagination.currentPage = 1;
                    
                    // 重新渲染资源列表
                    await this.renderResources();
                    
                    // 更新统计信息显示
                    await this.updateResultsInfo();
                    
                    // 显示成功通知
                    this.showNotification(`已切换到分类：${this.getCategoryDisplayName(category)}`, 'success');
                    
                } catch (error) {
                    console.error('筛选分类失败:', error);
                    this.showNotification('筛选失败: ' + error.message, 'error');
                }
            }

            // 检查并跳转到上一页（如果当前页面为空）
            async checkAndNavigateToPreviousPage() {
                const grid = document.getElementById('resources-grid');
                if (!grid) {
                    console.warn('资源网格不存在');
                    return;
                }
                
                // 获取当前页面的资源数量
                const currentCards = grid.querySelectorAll('.resource-card');
                const currentCount = currentCards.length;
                
                // 如果当前页面没有任何资源，且不是第一页，则跳转到上一页
                if (currentCount === 0 && this.pagination && this.pagination.currentPage > 1) {
                    console.log('当前页面为空，跳转到上一页');
                    this.showNotification('当前页面为空，正在跳转到上一页...', 'info');
                    
                    // 跳转到上一页
                    await this.goToPage(this.pagination.currentPage - 1);
                }
            }

            // 加载更多资源到当前页面
            async loadMoreResourcesToCurrentPage(count) {
                try {
                    console.log(`开始加载 ${count} 个资源到当前页面`);
                    
                    // 构建查询参数，获取下一页的资源
                    const params = {
                        page: this.currentPage + 1, // 获取下一页
                        limit: count,
                        sortBy: this.currentFilters.sortBy,
                        sortOrder: this.currentFilters.sortOrder,
                        _t: Date.now()
                    };

                    if (this.currentFilters.category) {
                        params.category = this.currentFilters.category;
                    }
                    
                    console.log('加载更多资源的参数:', params);
                    
                    const data = await this.getResources(params);
                    
                    // 转换资源为数组
                    const resourceArray = [];
                    for (const [category, categoryResources] of Object.entries(data.resources)) {
                        for (const [id, resource] of Object.entries(categoryResources)) {
                            const resourceWithMeta = {
                                id: id,
                                category: category,
                                ...resource
                            };
                            resourceArray.push(resourceWithMeta);
                        }
                    }
                    
                    console.log(`获取到 ${resourceArray.length} 个额外资源`);
                    
                    if (resourceArray.length > 0) {
                        // 将新资源添加到当前页面
                        const grid = document.getElementById('resources-grid');
                        
                        for (let i = 0; i < resourceArray.length; i++) {
                            const resource = resourceArray[i];
                            const card = this.createResourceCard(resource);
                            
                            if (card && grid) {
                                grid.appendChild(card);
                                
                                // 执行添加动画
                                setTimeout(() => {
                                    card.style.opacity = '1';
                                    card.style.transform = 'translateX(0)';
                                }, i * 100); // 每个卡片延迟100ms
                            }
                        }
                        
                        console.log(`成功添加 ${resourceArray.length} 个资源到当前页面`);
                        
                        // 更新结果统计（包含动态获取资源总数）
                        await this.updateResultsInfo();
                    }
                    
                } catch (error) {
                    console.error('加载更多资源失败:', error);
                    // 不显示错误通知，因为这是静默操作
                }
            }

            // 删除资源动画 - 优化版
            async animateResourceDeletion(category, id) {
                return new Promise((resolve) => {
                    // 查找对应的资源卡片
                    const grid = document.getElementById('resources-grid');
                    if (!grid) {
                        resolve();
                        return;
                    }
                    
                    // 查找包含该资源的卡片
                    const cards = grid.querySelectorAll('.resource-card');
                    let targetCard = null;
                    
                    for (const card of cards) {
                        // 检查卡片是否包含删除按钮，且按钮的data属性匹配目标category和id
                        const deleteBtn = card.querySelector('button[data-category][data-id]');
                        if (deleteBtn && deleteBtn.getAttribute('data-category') === category && deleteBtn.getAttribute('data-id') === id) {
                            targetCard = card;
                            break;
                        }
                    }
                    
                    if (!targetCard) {
                        resolve();
                        return;
                    }
                    
                    // 添加删除动画类
                    targetCard.classList.add('deleting');
                    
                    // 添加删除音效（可选）
                    try {
                        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                        audio.volume = 0.1;
                        audio.play().catch(() => {});
                    } catch (e) {
                        // 忽略音效错误
                    }
                    
                    // 等待动画完成
                    setTimeout(() => {
                        if (targetCard && targetCard.parentNode) {
                            targetCard.parentNode.removeChild(targetCard);
                        }
                        resolve();
                    }, 600);
                });
            }

            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                const icon = document.getElementById('notification-icon');
                const messageEl = document.getElementById('notification-message');
                
                // 检查元素是否存在
                if (!notification || !icon || !messageEl) {
                    console.error('通知元素不存在，使用console.log代替:', message);
                    console.log(`[${type.toUpperCase()}] ${message}`);
                    return;
                }
                
                messageEl.textContent = message;
                
                const icons = {
                    'success': 'fa-check-circle text-green-500',
                    'error': 'fa-exclamation-circle text-red-500',
                    'warning': 'fa-exclamation-triangle text-yellow-500',
                    'info': 'fa-info-circle text-primary'
                };
                
                icon.className = `fa ${icons[type]} mr-2`;
                
                // 显示通知
                notification.classList.remove('translate-x-full', 'opacity-0', 'pointer-events-none');
                notification.classList.add('opacity-100');
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    if (notification) {
                        notification.classList.add('translate-x-full', 'opacity-0', 'pointer-events-none');
                        notification.classList.remove('opacity-100');
                    }
                }, 1500);
            }

            // 渲染资源媒体文件
            renderResourceMedia(resource) {
                console.log('renderResourceMedia 被调用，资源:', resource);
                
                // 数据验证
                if (!resource) {
                    console.warn('renderResourceMedia: 资源对象为空');
                    return '<div class="text-xs text-gray-400 mb-3">暂无媒体文件</div>';
                }
                
                const media = Array.isArray(resource.media) ? resource.media : [];
                console.log('媒体文件数组:', media);
                
                // 去重并记录日志
                const dedupMap = new Map();
                for (const f of media) {
                    const key = `${f.url}|${f.name}`;
                    if (!dedupMap.has(key)) dedupMap.set(key, f);
                }
                const dedupedMedia = Array.from(dedupMap.values());
                if (dedupedMedia.length !== media.length) {
                    console.warn('[renderResourceMedia] 媒体存在重复，展示将使用去重后的列表:', { before: media.length, after: dedupedMedia.length });
                }
                const mediaToRender = dedupedMedia;
                if (mediaToRender.length === 0) {
                    return '<div class="text-xs text-gray-400 mb-3">暂无媒体文件</div>';
                }

                // 检查是否在详情预览模式（通过检查调用上下文）
                const isDetailView = this.currentResource && this.currentResource.id === resource.id;
                console.log('是否为详情预览模式:', isDetailView);
                
                if (isDetailView) {
                    // 详情预览模式：显示网格布局和预览按钮
                    return `
                        <div class="mt-3">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">媒体文件</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                ${mediaToRender.map((file, index) => {
                                    const isImage = file.type === 'image' || file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i);
                                    const isVideo = file.type === 'video' || file.name.match(/\.(mp4|avi|mov|wmv|flv)$/i);
                                    const isAudio = file.type === 'audio' || file.name.match(/\.(mp3|wav|ogg|aac)$/i);
                                    
                                    let icon = 'fa-file';
                                    if (isImage) icon = 'fa-image';
                                    else if (isVideo) icon = 'fa-video';
                                    else if (isAudio) icon = 'fa-music';
                                    
                                    return `
                                        <div class="relative group">
                                            <div class="bg-gray-100 rounded-lg p-2 hover:bg-gray-200 transition-colors">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex items-center space-x-2 flex-1 min-w-0">
                                                        <i class="fa ${icon} text-gray-600 flex-shrink-0"></i>
                                                        <span class="text-xs text-gray-700 truncate">${file.name}</span>
                                                    </div>
                                                    <div class="flex items-center space-x-1 ml-2">
                                                        <button class="text-blue-500 hover:text-blue-700 text-xs p-1 rounded hover:bg-blue-50 transition-colors" 
                                                                onclick="event.stopPropagation(); window.resourceManagerUI.previewMedia('${file.name}', '${file.url}', '${file.type || 'unknown'}')" 
                                                                title="预览">
                                                            <i class="fa fa-eye mr-1"></i>预览
                                                        </button>
                                                        ${this.isEditing ? `
                                                            <button class="text-red-500 hover:text-red-700 text-xs p-1 rounded hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100"
                                                                    onclick="event.stopPropagation(); window.resourceManagerUI.removeMediaFile(${index})" title="删除">
                                                                <i class="fa fa-trash"></i>
                                                            </button>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    // 资源卡片模式：显示第一个媒体文件的预览
                    const firstMedia = mediaToRender[0];
                    const isImage = firstMedia.type === 'image' || firstMedia.name.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i);
                    const isVideo = firstMedia.type === 'video' || firstMedia.name.match(/\.(mp4|avi|mov|wmv|flv|mkv|webm)$/i);
                    const isAudio = firstMedia.type === 'audio' || firstMedia.name.match(/\.(mp3|wav|ogg|aac|flac|m4a)$/i);
                    
                    if (isImage) {
                        return `
                            <div class="mb-3">
                                <div class="relative group overflow-hidden rounded-lg border border-gray-200 bg-gray-50">
                                    <img src="${firstMedia.url}" alt="${firstMedia.name}" 
                                         class="w-full h-24 object-cover transition-transform duration-300 group-hover:scale-105"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="hidden absolute inset-0 bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                                        <div class="text-center">
                                            <i class="fa fa-image text-gray-400 text-2xl mb-1"></i>
                                            <div class="text-gray-500 text-xs">图片加载失败</div>
                                    </div>
                                    </div>
                                    
                                    <!-- 预览按钮 -->
                                    <div class="absolute top-2 right-2 bg-black bg-opacity-60 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-full cursor-pointer hover:bg-opacity-80 transition-all duration-200 opacity-0 group-hover:opacity-100 transform translate-y-1 group-hover:translate-y-0" 
                                         onclick="window.resourceManagerUI.previewMedia('${firstMedia.name}', '${firstMedia.url}', 'image')">
                                        <i class="fa fa-eye mr-1"></i>预览
                                    </div>
                                    
                                    <!-- 媒体数量指示器 -->
                                    ${mediaToRender.length > 1 ? `
                                        <div class="absolute bottom-2 right-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full shadow-lg">
                                            <i class="fa fa-images mr-1"></i>+${mediaToRender.length - 1}
                                        </div>
                                    ` : ''}
                                    
                                    <!-- 文件类型标识 -->
                                    <div class="absolute top-2 left-2 bg-white bg-opacity-80 backdrop-blur-sm text-gray-700 text-xs px-2 py-1 rounded-full">
                                        <i class="fa fa-image mr-1"></i>图片
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (isVideo) {
                        return `
                            <div class="mb-3">
                                <div class="relative group overflow-hidden rounded-lg border border-gray-200 bg-gray-50">
                                    <video src="${firstMedia.url}" 
                                           class="w-full h-24 object-cover transition-transform duration-300 group-hover:scale-105" 
                                           preload="metadata" muted 
                                           onloadeddata="this.style.display='block'; this.nextElementSibling.style.display='none';" 
                                           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    </video>
                                    
                                    <!-- 视频加载失败占位符 -->
                                    <div class="hidden w-full h-24 bg-gradient-to-br from-red-500 to-red-700 flex items-center justify-center">
                                        <div class="text-center">
                                            <i class="fa fa-video text-white text-2xl mb-1"></i>
                                            <div class="text-white text-xs font-medium">视频加载失败</div>
                                        </div>
                                    </div>
                                    
                                    <!-- 播放按钮覆盖层 -->
                                    <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20 group-hover:bg-opacity-30 transition-all duration-200">
                                        <div class="bg-black bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center group-hover:scale-110 transition-transform duration-200">
                                            <i class="fa fa-play text-sm ml-1"></i>
                                        </div>
                                    </div>
                                    
                                    <!-- 预览按钮 -->
                                    <div class="absolute top-2 right-2 bg-black bg-opacity-60 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-full cursor-pointer hover:bg-opacity-80 transition-all duration-200 opacity-0 group-hover:opacity-100 transform translate-y-1 group-hover:translate-y-0" 
                                         onclick="window.resourceManagerUI.previewMedia('${firstMedia.name}', '${firstMedia.url}', 'video')">
                                        <i class="fa fa-eye mr-1"></i>预览
                                    </div>
                                    
                                    <!-- 媒体数量指示器 -->
                                    ${mediaToRender.length > 1 ? `
                                        <div class="absolute bottom-2 right-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full shadow-lg">
                                            <i class="fa fa-video mr-1"></i>+${mediaToRender.length - 1}
                                        </div>
                                    ` : ''}
                                    
                                    <!-- 文件类型标识 -->
                                    <div class="absolute top-2 left-2 bg-white bg-opacity-80 backdrop-blur-sm text-gray-700 text-xs px-2 py-1 rounded-full">
                                        <i class="fa fa-video mr-1"></i>视频
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (isAudio) {
                        return `
                            <div class="mb-3">
                                <div class="relative group overflow-hidden rounded-lg border border-gray-200">
                                    <div class="w-full h-24 bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center group-hover:scale-105 transition-transform duration-300">
                                        <div class="text-center">
                                            <i class="fa fa-music text-white text-3xl mb-2 group-hover:scale-110 transition-transform duration-200"></i>
                                            <div class="text-white text-sm font-medium">音频文件</div>
                                        </div>
                                    </div>
                                    
                                    <!-- 音频波形动画 -->
                                    <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-1">
                                        <div class="w-1 bg-white bg-opacity-60 rounded-full animate-pulse" style="height: 8px;"></div>
                                        <div class="w-1 bg-white bg-opacity-60 rounded-full animate-pulse" style="height: 12px; animation-delay: 0.1s;"></div>
                                        <div class="w-1 bg-white bg-opacity-60 rounded-full animate-pulse" style="height: 8px; animation-delay: 0.2s;"></div>
                                        <div class="w-1 bg-white bg-opacity-60 rounded-full animate-pulse" style="height: 16px; animation-delay: 0.3s;"></div>
                                        <div class="w-1 bg-white bg-opacity-60 rounded-full animate-pulse" style="height: 8px; animation-delay: 0.4s;"></div>
                                    </div>
                                    
                                    <!-- 预览按钮 -->
                                    <div class="absolute top-2 right-2 bg-black bg-opacity-60 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-full cursor-pointer hover:bg-opacity-80 transition-all duration-200 opacity-0 group-hover:opacity-100 transform translate-y-1 group-hover:translate-y-0" 
                                         onclick="window.resourceManagerUI.previewMedia('${firstMedia.name}', '${firstMedia.url}', 'audio')">
                                        <i class="fa fa-eye mr-1"></i>预览
                                    </div>
                                    
                                    <!-- 媒体数量指示器 -->
                                    ${mediaToRender.length > 1 ? `
                                        <div class="absolute bottom-2 right-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full shadow-lg">
                                            <i class="fa fa-music mr-1"></i>+${mediaToRender.length - 1}
                                        </div>
                                    ` : ''}
                                    
                                    <!-- 文件类型标识 -->
                                    <div class="absolute top-2 left-2 bg-white bg-opacity-80 backdrop-blur-sm text-gray-700 text-xs px-2 py-1 rounded-full">
                                        <i class="fa fa-music mr-1"></i>音频
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="mb-3">
                                <div class="relative group overflow-hidden rounded-lg border border-gray-200">
                                    <div class="w-full h-24 bg-gradient-to-br from-gray-500 to-gray-700 flex items-center justify-center group-hover:scale-105 transition-transform duration-300">
                                        <div class="text-center">
                                            <i class="fa fa-file text-white text-3xl mb-2 group-hover:scale-110 transition-transform duration-200"></i>
                                            <div class="text-white text-sm font-medium">文档文件</div>
                                        </div>
                                    </div>
                                    
                                    <!-- 文件图标装饰 -->
                                    <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2">
                                        <div class="bg-white bg-opacity-20 rounded-full p-1">
                                            <i class="fa fa-file-alt text-white text-xs"></i>
                                        </div>
                                    </div>
                                    
                                    <!-- 预览按钮 -->
                                    <div class="absolute top-2 right-2 bg-black bg-opacity-60 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-full cursor-pointer hover:bg-opacity-80 transition-all duration-200 opacity-0 group-hover:opacity-100 transform translate-y-1 group-hover:translate-y-0" 
                                         onclick="window.resourceManagerUI.previewMedia('${firstMedia.name}', '${firstMedia.url}', 'file')">
                                        <i class="fa fa-eye mr-1"></i>预览
                                    </div>
                                    
                                    <!-- 媒体数量指示器 -->
                                    ${mediaToRender.length > 1 ? `
                                        <div class="absolute bottom-2 right-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full shadow-lg">
                                            <i class="fa fa-file mr-1"></i>+${mediaToRender.length - 1}
                                        </div>
                                    ` : ''}
                                    
                                    <!-- 文件类型标识 -->
                                    <div class="absolute top-2 left-2 bg-white bg-opacity-80 backdrop-blur-sm text-gray-700 text-xs px-2 py-1 rounded-full">
                                        <i class="fa fa-file mr-1"></i>文档
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            }

            // 检查文件是否存在
            checkFileExists(filePath) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve(true);
                    img.onerror = () => resolve(false);
                    img.src = filePath;
                    // 设置超时
                    setTimeout(() => resolve(false), 2000);
                });
            }

            // 获取文件类型显示名称
            getFileTypeDisplayName(fileType) {
                const typeMap = {
                    'image': '图片文件',
                    'video': '视频文件',
                    'audio': '音频文件',
                    'document': '文档文件',
                    'pdf': 'PDF文档',
                    'archive': '压缩文件',
                    'unknown': '未知文件'
                };
                
                return typeMap[fileType] || '文件';
            }
            
            // 获取文档图标
            getDocumentIcon(fileName) {
                const extension = fileName.split('.').pop().toLowerCase();
                const iconMap = {
                    'doc': 'fa fa-file-word',
                    'docx': 'fa fa-file-word',
                    'txt': 'fa fa-file-text',
                    'rtf': 'fa fa-file-text',
                    'pdf': 'fa fa-file-pdf'
                };
                return iconMap[extension] || 'fa fa-file';
            }
            
            // 获取推荐软件
            getRecommendedSoftware(fileName) {
                const extension = fileName.split('.').pop().toLowerCase();
                const softwareMap = {
                    'doc': 'Microsoft Word',
                    'docx': 'Microsoft Word',
                    'txt': '记事本/文本编辑器',
                    'rtf': 'WordPad/文本编辑器',
                    'pdf': 'Adobe Reader/浏览器'
                };
                return softwareMap[extension] || '相应软件';
            }
            
            // 全屏查看文档
            openDocumentInFullscreen(filePath, fileName) {
                const features = 'width=screen.width,height=screen.height,scrollbars=yes,resizable=yes,menubar=yes,toolbar=yes,location=yes,status=yes';
                const newWindow = window.open(filePath, '_blank', features);
                
                if (newWindow) {
                    // 尝试全屏
                    if (newWindow.document.documentElement.requestFullscreen) {
                        newWindow.document.documentElement.requestFullscreen();
                    } else if (newWindow.document.documentElement.webkitRequestFullscreen) {
                        newWindow.document.documentElement.webkitRequestFullscreen();
                    } else if (newWindow.document.documentElement.msRequestFullscreen) {
                        newWindow.document.documentElement.msRequestFullscreen();
                    }
                }
                
                // 关闭预览模态框
                const modal = document.querySelector('.media-preview-modal');
                if (modal) {
                    modal.remove();
                }
            }
            
            // 使用默认应用打开文档
            openDocumentWithDefaultApp(filePath) {
                // 创建一个隐藏的下载链接来触发默认应用打开
                const link = document.createElement('a');
                link.href = filePath;
                link.download = ''; // 不指定下载文件名，让浏览器决定如何处理
                link.target = '_blank';
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 关闭预览模态框
                const modal = document.querySelector('.media-preview-modal');
                if (modal) {
                    modal.remove();
                }
                
                this.showNotification('正在使用默认应用打开文档...', 'info');
            }
            
            // 使用Google Docs预览PDF
            openPDFWithGoogleDocs(filePath) {
                // 将PDF文件URL编码
                const encodedUrl = encodeURIComponent(filePath);
                const googleDocsUrl = `https://docs.google.com/viewer?url=${encodedUrl}&embedded=true`;
                
                // 在新窗口中打开Google Docs预览
                const features = 'width=1200,height=800,scrollbars=yes,resizable=yes';
                const newWindow = window.open(googleDocsUrl, '_blank', features);
                
                if (newWindow) {
                    this.showNotification('正在使用Google Docs预览PDF...', 'info');
                } else {
                    this.showNotification('无法打开Google Docs预览，请检查弹窗设置', 'error');
                }
                
                // 关闭预览模态框
                const modal = document.querySelector('.media-preview-modal');
                if (modal) {
                    modal.remove();
                }
            }
            
            // 尝试多种PDF预览方式
            tryPDFPreview(filePath, fileName) {
                // 方法1：尝试使用object标签
                const objectElement = document.createElement('object');
                objectElement.data = filePath;
                objectElement.type = 'application/pdf';
                objectElement.style.width = '100%';
                objectElement.style.height = '400px';
                
                objectElement.onload = () => {
                    console.log('PDF预览成功');
                };
                
                objectElement.onerror = () => {
                    console.log('PDF预览失败，尝试其他方法');
                    // 方法2：尝试使用embed标签
                    this.tryEmbedPreview(filePath);
                };
                
                return objectElement;
            }
            
            // 尝试使用embed标签预览
            tryEmbedPreview(filePath) {
                const embedElement = document.createElement('embed');
                embedElement.src = filePath;
                embedElement.type = 'application/pdf';
                embedElement.style.width = '100%';
                embedElement.style.height = '400px';
                
                embedElement.onload = () => {
                    console.log('Embed预览成功');
                };
                
                embedElement.onerror = () => {
                    console.log('所有预览方法都失败，显示下载选项');
                    this.showDownloadOptions(filePath);
                };
            }
            
            // 显示下载选项
            showDownloadOptions(filePath) {
                const previewContent = document.getElementById('preview-content');
                if (previewContent) {
                    previewContent.innerHTML = `
                        <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-12">
                            <div class="max-w-lg mx-auto text-center">
                                <div class="bg-gradient-to-br from-gray-500 to-gray-600 text-white rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-8">
                                    <i class="fa fa-file-pdf text-4xl"></i>
                                </div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-4">PDF预览</h3>
                                <p class="text-gray-500 mb-8">由于浏览器安全设置，无法直接预览PDF</p>
                                
                                <div class="flex flex-wrap gap-4 justify-center">
                                    <button onclick="window.open('${filePath}', '_blank')" 
                                            class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                                        在新窗口打开
                                    </button>
                                    <button onclick="window.resourceManagerUI.downloadFile('${filePath}', 'document.pdf')" 
                                            class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-medium">
                                        下载文件
                                    </button>
                                    <button onclick="this.closest('.fixed').remove()" 
                                            class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                                        关闭
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // 下载文件
            downloadFile(filePath, fileName) {
                try {
                    const link = document.createElement('a');
                    link.href = filePath;
                    link.download = fileName;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification('开始下载文件', 'success');
                } catch (error) {
                    console.error('下载文件失败:', error);
                    this.showNotification('下载失败，请手动下载', 'error');
                }
            }

            // 图片放大功能
            zoomImage(button) {
                const modal = button.closest('.fixed');
                const img = modal.querySelector('img');
                
                if (img) {
                    if (img.classList.contains('zoomed')) {
                        // 恢复原始大小
                        img.classList.remove('zoomed');
                        img.style.transform = 'scale(1)';
                        img.style.cursor = 'zoom-in';
                        button.innerHTML = '<i class="fa fa-search-plus"></i>';
                        button.title = '放大';
                    } else {
                        // 放大图片
                        img.classList.add('zoomed');
                        img.style.transform = 'scale(1.5)';
                        img.style.cursor = 'zoom-out';
                        button.innerHTML = '<i class="fa fa-search-minus"></i>';
                        button.title = '缩小';
                    }
                }
            }



            // 预览媒体文件
            previewMedia(fileName, filePath, fileType) {
                console.log('previewMedia 被调用:', { fileName, filePath, fileType });
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[9999] media-preview-modal backdrop-blur-sm';
                
                // 修复文件路径
                let correctedPath = filePath;
                
                // 处理各种可能的错误路径格式
                if (filePath.startsWith('/uploads/') || filePath.startsWith('uploads/')) {
                    console.log('检测到可能的错误文件路径，尝试修复:', filePath);
                    
                    // 提取文件名
                    const fileNameOnly = filePath.split('/').pop();
                    
                    // 根据文件类型确定正确的路径
                    if (fileType === 'image' || fileName.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i)) {
                        correctedPath = `/resources/images/${fileNameOnly}`;
                    } else if (fileType === 'video' || fileName.match(/\.(mp4|avi|mov|wmv|flv|mkv|webm)$/i)) {
                        correctedPath = `/resources/videos/${fileNameOnly}`;
                    } else if (fileType === 'audio' || fileName.match(/\.(mp3|wav|ogg|aac|flac|m4a)$/i)) {
                        correctedPath = `/resources/audio/${fileNameOnly}`;
                    } else {
                        correctedPath = `/resources/documents/${fileNameOnly}`;
                    }
                    
                    console.log('修复后的路径:', correctedPath);
                }
                
                // 创建加载状态
                let content = `
                    <div class="flex items-center justify-center">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-16 w-16 border-4 border-white border-t-transparent mx-auto mb-6"></div>
                            <p class="text-white text-xl font-medium">正在加载预览...</p>
                            <p class="text-gray-300 text-sm mt-2">${fileName}</p>
                        </div>
                    </div>
                `;
                
                modal.innerHTML = `
                    <div class="relative max-w-7xl w-full mx-4 max-h-screen">
                        <!-- 关闭按钮 -->
                        <button class="absolute -top-6 -right-6 bg-white text-gray-600 rounded-full w-12 h-12 flex items-center justify-center media-preview-close hover:bg-gray-100 transition-all duration-200 shadow-lg hover:scale-110 z-20" 
                                onclick="this.closest('.fixed').remove()">
                            <i class="fa fa-times text-lg"></i>
                        </button>
                        
                        <!-- 预览内容容器 -->
                        <div id="preview-content" class="bg-white rounded-2xl shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300">
                            ${content}
                        </div>
                        
                        <!-- 文件信息栏 -->
                        <div class="mt-4 text-center transform translate-y-4 opacity-0 transition-all duration-300 delay-200">
                            <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-full px-6 py-3 inline-block">
                                <p class="text-white text-lg font-medium">${fileName}</p>
                                <p class="text-gray-300 text-sm">${this.getFileTypeDisplayName(fileType)}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                // 点击背景关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
                // ESC键关闭
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                document.body.appendChild(modal);
                
                // 触发动画
                setTimeout(() => {
                    const previewContent = document.getElementById('preview-content');
                    const fileInfo = modal.querySelector('.mt-4');
                    if (previewContent) {
                        previewContent.style.transform = 'scale(1)';
                        previewContent.style.opacity = '1';
                    }
                    if (fileInfo) {
                        fileInfo.style.transform = 'translateY(0)';
                        fileInfo.style.opacity = '1';
                    }
                }, 50);
                
                // 根据文件类型创建预览内容
                const previewContent = document.getElementById('preview-content');
                
                if (fileType === 'image' || fileName.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i)) {
                    const img = new Image();
                    img.alt = fileName;
                    
                    img.onload = () => {
                        previewContent.innerHTML = `
                            <div class="relative bg-gray-50 flex items-center justify-center min-h-[85vh]">
                                <div class="relative max-w-4xl w-full">
                                    <img src="${correctedPath}" alt="${fileName}" 
                                         class="w-full h-auto max-h-[85vh] object-contain mx-auto group">
                                    
                                    <!-- 图片操作工具栏 -->
                                    <div class="absolute top-4 right-4 bg-black bg-opacity-50 backdrop-blur-sm rounded-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-20">
                                        <div class="flex space-x-2">
                                            <button onclick="window.open('${correctedPath}', '_blank')" 
                                                    class="text-white hover:text-blue-300 p-2 rounded hover:bg-white hover:bg-opacity-20 transition-colors" 
                                                    title="在新窗口打开">
                                                <i class="fa fa-external-link"></i>
                                            </button>
                                            <button onclick="window.resourceManagerUI.downloadFile('${correctedPath}', '${fileName}')" 
                                                    class="text-white hover:text-green-300 p-2 rounded hover:bg-white hover:bg-opacity-20 transition-colors" 
                                                    title="下载">
                                                <i class="fa fa-download"></i>
                                            </button>
                                            <button onclick="window.resourceManagerUI.zoomImage(this)" 
                                                    class="text-white hover:text-yellow-300 p-2 rounded hover:bg-white hover:bg-opacity-20 transition-colors" 
                                                    title="放大">
                                                <i class="fa fa-search-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- 图片信息 -->
                                    <div class="absolute bottom-4 left-4 bg-black bg-opacity-50 backdrop-blur-sm rounded-lg p-3 text-white z-20">
                                        <div class="text-sm">
                                            <div class="flex items-center space-x-2">
                                                <i class="fa fa-image"></i>
                                                <span class="font-medium">图片文件</span>
                                            </div>
                                            <div class="text-xs text-gray-300 mt-1">${fileName}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    };
                    
                    img.onerror = () => {
                        previewContent.innerHTML = `
                            <div class="bg-gradient-to-br from-red-50 to-red-100 p-12 text-center">
                                <div class="max-w-md mx-auto">
                                    <div class="bg-red-500 text-white rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                                        <i class="fa fa-exclamation-triangle text-3xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-red-800 mb-4">图片加载失败</h3>
                                    <p class="text-red-600 mb-6">无法加载图片: ${fileName}</p>
                                    <div class="bg-white rounded-lg p-4 mb-6">
                                        <p class="text-sm text-gray-600">文件路径: ${correctedPath}</p>
                                    </div>
                                    <div class="flex space-x-3 justify-center">
                                        <button onclick="this.closest('.fixed').remove()" 
                                                class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors font-medium">
                                    关闭
                                </button>
                                        <button onclick="window.open('${correctedPath}', '_blank')" 
                                                class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                                            尝试打开
                                </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    };
                    
                    img.src = correctedPath;
                    
                } else if (fileType === 'video' || fileName.match(/\.(mp4|avi|mov|wmv|flv|mkv|webm)$/i)) {
                    previewContent.innerHTML = `
                        <div class="relative bg-black flex items-center justify-center min-h-[85vh]">
                            <div class="relative max-w-4xl w-full">
                                <video src="${correctedPath}" controls 
                                       class=" h-auto max-h-[85vh] object-contain mx-auto"
                                       style="padding-bottom: 25px;"
                                   onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='block';">
                            </video>
                                
                                <!-- 视频操作工具栏 - 调整位置避免遮挡播放控件 -->
                                <div class="absolute top-4 right-4 bg-black bg-opacity-50 backdrop-blur-sm rounded-lg p-2 z-20">
                                    <div class="flex space-x-2">
                                        <button onclick="window.open('${correctedPath}', '_blank')" 
                                                class="text-white hover:text-blue-300 p-2 rounded hover:bg-white hover:bg-opacity-20 transition-colors" 
                                                title="在新窗口打开">
                                            <i class="fa fa-external-link"></i>
                                        </button>
                                        <button onclick="window.resourceManagerUI.downloadFile('${correctedPath}', '${fileName}')" 
                                                class="text-white hover:text-green-300 p-2 rounded hover:bg-white hover:bg-opacity-20 transition-colors" 
                                                title="下载">
                                            <i class="fa fa-download"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            

                            
                            <!-- 视频加载失败提示 -->
                            <div class="hidden bg-gradient-to-br from-red-50 to-red-100 p-12 text-center">
                                <div class="max-w-md mx-auto">
                                    <div class="bg-red-500 text-white rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                                        <i class="fa fa-exclamation-triangle text-3xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-red-800 mb-4">视频加载失败</h3>
                                    <p class="text-red-600 mb-6">无法加载视频: ${fileName}</p>
                                    <div class="bg-white rounded-lg p-4 mb-6">
                                        <p class="text-sm text-gray-600">文件路径: ${correctedPath}</p>
                                    </div>
                                    <div class="flex space-x-3 justify-center">
                                        <button onclick="this.closest('.fixed').remove()" 
                                                class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors font-medium">
                                    关闭
                                </button>
                                        <button onclick="window.open('${correctedPath}', '_blank')" 
                                                class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                                            尝试打开
                                </button>
                            </div>
                                </div>
                            </div>
                            

                            
                            <!-- 视频播放提示 - 当视频未播放时显示 -->
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none" id="video-play-hint">
                                <div class="bg-black bg-opacity-60 backdrop-blur-sm text-white rounded-lg p-4 text-center opacity-0 transition-opacity duration-300">
                                    <i class="fa fa-play text-2xl mb-2"></i>
                                    <div class="text-sm">点击播放按钮开始播放</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 添加视频播放状态监听
                    setTimeout(() => {
                        const video = previewContent.querySelector('video');
                        const playHint = document.getElementById('video-play-hint');
                        
                        if (video && playHint) {
                            video.addEventListener('play', () => {
                                playHint.style.opacity = '0';
                            });
                            
                            video.addEventListener('pause', () => {
                                playHint.style.opacity = '0';
                            });
                            
                            // 3秒后自动隐藏提示
                            setTimeout(() => {
                                playHint.style.opacity = '0';
                            }, 3000);
                        }
                    }, 100);
                    
                } else if (fileType === 'audio' || fileName.match(/\.(mp3|wav|ogg|aac|flac|m4a)$/i)) {
                    previewContent.innerHTML = `
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 p-12">
                            <div class="max-w-lg mx-auto text-center">
                                <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-8">
                                    <i class="fa fa-music text-4xl"></i>
                                </div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-4">音频文件</h3>
                                <p class="text-gray-600 mb-8 text-lg">${fileName}</p>
                                
                                <!-- 音频播放器 -->
                                <div class="bg-white rounded-2xl p-6 shadow-lg mb-8">
                                    <audio src="${correctedPath}" controls 
                                           class="w-full h-12 rounded-lg" 
                                           preload="metadata">
                                        您的浏览器不支持音频播放
                                    </audio>
                                </div>
                                
                                <!-- 操作按钮 -->
                                <div class="flex space-x-4 justify-center">
                                    <button onclick="window.resourceManagerUI.downloadFile('${correctedPath}', '${fileName}')" 
                                            class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center space-x-2">
                                        <i class="fa fa-download"></i>
                                        <span>下载</span>
                                    </button>
                                    <button onclick="window.open('${correctedPath}', '_blank')" 
                                            class="bg-indigo-500 text-white px-6 py-3 rounded-lg hover:bg-indigo-600 transition-colors font-medium flex items-center space-x-2">
                                        <i class="fa fa-external-link"></i>
                                        <span>新窗口打开</span>
                                    </button>
                                    <button onclick="this.closest('.fixed').remove()" 
                                            class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                                关闭
                            </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                } else if (fileType === 'pdf' || fileName.match(/\.pdf$/i)) {
                    // PDF文档预览 - 使用兼容的方式
                    previewContent.innerHTML = `
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-12">
                            <div class="max-w-4xl mx-auto">
                                <div class="text-center mb-8">
                                    <div class="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-4">
                                        <i class="fa fa-file-pdf text-4xl"></i>
                                    </div>
                                    <h3 class="text-3xl font-bold text-gray-800 mb-2">PDF文档预览</h3>
                                    <p class="text-gray-600 text-lg">${fileName}</p>
                                </div>
                                
                                <!-- PDF预览区域 -->
                                <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-8">
                                    <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-3">
                                                <i class="fa fa-file-pdf text-red-500"></i>
                                                <span class="font-medium text-gray-700">PDF预览</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-sm text-gray-500">浏览器预览</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="h-96 bg-gray-50 flex items-center justify-center">
                                        <!-- 尝试使用object标签 -->
                                        <object data="${correctedPath}#toolbar=1&navpanes=1&scrollbar=1" 
                                                type="application/pdf" 
                                                class="w-full h-full"
                                                onload="this.style.display='block'"
                                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                            <p>您的浏览器不支持PDF预览，请使用下面的按钮打开</p>
                                        </object>
                                        
                                        <!-- 备选方案：直接链接 -->
                                        <div class="hidden flex-col items-center justify-center text-center p-8">
                                            <div class="bg-blue-100 text-blue-600 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                                                <i class="fa fa-file-pdf text-2xl"></i>
                                            </div>
                                            <p class="text-gray-600 mb-4">PDF预览</p>
                                            <p class="text-sm text-gray-500 mb-4">点击下方按钮在新窗口中打开PDF</p>
                                            <button onclick="window.open('${correctedPath}', '_blank')" 
                                                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                                在新窗口打开PDF
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 文件信息 -->
                                <div class="bg-white rounded-2xl p-6 shadow-lg mb-8">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-left">
                                        <div>
                                            <p class="text-sm text-gray-500">文件类型</p>
                                            <p class="font-medium">PDF文档</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">文件名称</p>
                                            <p class="font-medium text-sm break-all">${fileName}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">文件路径</p>
                                            <p class="font-medium text-xs break-all">${correctedPath}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 操作按钮 -->
                                <div class="flex flex-wrap gap-4 justify-center">
                                    <button onclick="window.open('${correctedPath}', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes')" 
                                            class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center space-x-2">
                                        <i class="fa fa-external-link"></i>
                                        <span>新窗口打开</span>
                                    </button>
                                    <button onclick="window.resourceManagerUI.downloadFile('${correctedPath}', '${fileName}')" 
                                            class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-medium flex items-center space-x-2">
                                        <i class="fa fa-download"></i>
                                        <span>下载文件</span>
                                    </button>
                                    <button onclick="window.resourceManagerUI.openDocumentInFullscreen('${correctedPath}', '${fileName}')" 
                                            class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors font-medium flex items-center space-x-2">
                                        <i class="fa fa-expand"></i>
                                        <span>全屏查看</span>
                                    </button>
                                    <button onclick="window.resourceManagerUI.openPDFWithGoogleDocs('${correctedPath}')" 
                                            class="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 transition-colors font-medium flex items-center space-x-2">
                                        <i class="fa fa-google"></i>
                                        <span>Google Docs预览</span>
                                    </button>
                                    <button onclick="this.closest('.fixed').remove()" 
                                            class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                                        关闭
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (fileType === 'document' || fileName.match(/\.(doc|docx|txt|rtf)$/i)) {
                    // 其他文档类型预览
                    const docIcon = this.getDocumentIcon(fileName);
                    const docType = this.getFileTypeDisplayName(fileType);
                    
                    previewContent.innerHTML = `
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 p-12">
                            <div class="max-w-2xl mx-auto text-center">
                                <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-8">
                                    <i class="${docIcon} text-4xl"></i>
                                </div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-4">文档预览</h3>
                                <p class="text-gray-600 mb-6 text-lg">${fileName}</p>
                                <p class="text-gray-500 mb-8">此文档类型需要下载后使用相应软件打开</p>
                                
                                <!-- 文档信息卡片 -->
                                <div class="bg-white rounded-2xl p-6 shadow-lg mb-8">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                                        <div>
                                            <p class="text-sm text-gray-500">文件类型</p>
                                            <p class="font-medium">${docType}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">推荐软件</p>
                                            <p class="font-medium">${this.getRecommendedSoftware(fileName)}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">文件名称</p>
                                            <p class="font-medium text-sm break-all">${fileName}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">文件路径</p>
                                            <p class="font-medium text-xs break-all">${correctedPath}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 操作按钮 -->
                                <div class="flex flex-wrap gap-4 justify-center">
                                    <button onclick="window.resourceManagerUI.downloadFile('${correctedPath}', '${fileName}')" 
                                            class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center space-x-2">
                                        <i class="fa fa-download"></i>
                                        <span>下载文件</span>
                                    </button>
                                    <button onclick="window.open('${correctedPath}', '_blank')" 
                                            class="bg-indigo-500 text-white px-6 py-3 rounded-lg hover:bg-indigo-600 transition-colors font-medium flex items-center space-x-2">
                                        <i class="fa fa-external-link"></i>
                                        <span>新窗口打开</span>
                                    </button>
                                    <button onclick="window.resourceManagerUI.openDocumentWithDefaultApp('${correctedPath}')" 
                                            class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-medium flex items-center space-x-2">
                                        <i class="fa fa-desktop"></i>
                                        <span>默认应用打开</span>
                                    </button>
                                    <button onclick="this.closest('.fixed').remove()" 
                                            class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                                        关闭
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // 其他文件类型
                    previewContent.innerHTML = `
                        <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-12">
                            <div class="max-w-lg mx-auto text-center">
                                <div class="bg-gradient-to-br from-gray-500 to-gray-600 text-white rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-8">
                                    <i class="fa fa-file text-4xl"></i>
                                </div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-4">文件预览</h3>
                                <p class="text-gray-600 mb-6 text-lg">${fileName}</p>
                                <p class="text-gray-500 mb-8">此文件类型暂不支持在线预览</p>
                                
                                <!-- 文件信息 -->
                                <div class="bg-white rounded-2xl p-6 shadow-lg mb-8">
                                    <div class="grid grid-cols-2 gap-4 text-left">
                                        <div>
                                            <p class="text-sm text-gray-500">文件类型</p>
                                            <p class="font-medium">${this.getFileTypeDisplayName(fileType)}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">文件路径</p>
                                            <p class="font-medium text-xs break-all">${correctedPath}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 操作按钮 -->
                                <div class="flex space-x-4 justify-center">
                                    <a href="${correctedPath}" target="_blank" 
                                       class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center space-x-2">
                                        <i class="fa fa-download"></i>
                                        <span>下载文件</span>
                                    </a>
                                    <button onclick="window.open('${correctedPath}', '_blank')" 
                                            class="bg-indigo-500 text-white px-6 py-3 rounded-lg hover:bg-indigo-600 transition-colors font-medium flex items-center space-x-2">
                                        <i class="fa fa-external-link"></i>
                                        <span>新窗口打开</span>
                                    </button>
                                    <button onclick="this.closest('.fixed').remove()" 
                                            class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                                        关闭
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // 删除媒体文件
            removeMediaFile(index) {
                if (this.currentResource && this.currentResource.media) {
                    console.log(`删除媒体文件索引 ${index}:`, this.currentResource.media[index]);
                    this.currentResource.media.splice(index, 1);
                    this.renderExistingMediaFiles();
                    
                    // 移除自动更新，用户点击保存时会统一处理
                }
            }

            // 隐藏通知
            hideNotification() {
                const notification = document.querySelector('.notification');
                if (notification) {
                    notification.remove();
                }
            }

            // 删除已有的媒体文件
            removeExistingMediaFile(index) {
                if (this.currentResource && this.currentResource.media) {
                    console.log(`删除已有媒体文件索引 ${index}:`, this.currentResource.media[index]);
                    this.currentResource.media.splice(index, 1);
                    this.renderExistingMediaFiles();
                }
            }

            // 移除媒体文件（从文件列表中移除DOM元素）
            removeMediaFileFromList(index) {
                const fileList = document.getElementById('file-list');
                if (fileList) {
                    const fileItems = fileList.querySelectorAll('.flex.items-center.justify-between');
                    if (fileItems[index]) {
                        fileItems[index].remove();
                    }
                }
            }

            // 渲染已有媒体文件
            renderExistingMediaFiles(mediaFiles = null) {
                const fileList = document.getElementById('file-list');
                if (!fileList) return;
                
                fileList.innerHTML = '';
                
                // 使用传入的媒体文件或当前资源的媒体文件
                const files = mediaFiles || (this.currentResource && this.currentResource.media);
                
                if (files && Array.isArray(files) && files.length > 0) {
                    console.log('渲染媒体文件:', files.length, '个文件');
                    
                    files.forEach((file, index) => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'flex items-center justify-between p-2 bg-gray-50 rounded border mb-2';
                        fileItem.setAttribute('data-file-name', file.name);
                        fileItem.setAttribute('data-file-size', file.size || 0);
                        fileItem.setAttribute('data-file-type', file.type || 'unknown');
                        fileItem.setAttribute('data-uploaded-url', file.url || '');
                        
                        // 根据文件类型显示不同的图标
                        const getFileIcon = (fileName, fileType) => {
                            const extension = fileName.split('.').pop().toLowerCase();
                            if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension) || fileType.startsWith('image/')) {
                                return 'fa fa-image';
                            } else if (['mp4', 'avi', 'mov', 'wmv'].includes(extension) || fileType.startsWith('video/')) {
                                return 'fa fa-video';
                            } else if (['mp3', 'wav', 'ogg'].includes(extension) || fileType.startsWith('audio/')) {
                                return 'fa fa-music';
                            } else if (['pdf'].includes(extension)) {
                                return 'fa fa-file-pdf';
                            } else {
                                return 'fa fa-file';
                            }
                        };
                        
                        fileItem.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <i class="${getFileIcon(file.name, file.type)} text-gray-500"></i>
                                <span class="text-sm text-gray-700">${file.name}</span>
                                <span class="text-xs text-gray-400">(${this.formatFileSize(file.size || 0)})</span>
                            </div>
                            <button type="button" onclick="window.resourceManagerUI.removeExistingMediaFile(${index})" 
                                    class="text-red-500 hover:text-red-700 p-1" title="删除文件">
                                <i class="fa fa-trash text-sm"></i>
                            </button>
                        `;
                        fileList.appendChild(fileItem);
                    });
                } else {
                    console.log('没有媒体文件需要渲染');
                }
            }

            // ==================== 搜索功能实现 ====================
            
            // 搜索相关属性
            searchState = {
                query: '',
                searchTimeout: null,
                lastSearchTime: 0,
                searchFilters: {
                    title: true,
                    description: true,
                    tags: true,
                    category: true
                }
            };

            // 绑定搜索事件
            bindSearchEvents() {
                const searchInput = document.getElementById('search-input');
                const clearSearchBtn = document.getElementById('clear-search-btn');
                const searchFilters = document.getElementById('search-filters');

                console.log('绑定搜索事件:', {
                    searchInput: !!searchInput,
                    clearSearchBtn: !!clearSearchBtn,
                    searchFilters: !!searchFilters
                });

                // 初始化搜索过滤器状态
                this.initSearchFilters();

                if (searchInput) {
                    // 输入事件 - 实时搜索
                    searchInput.addEventListener('input', (e) => {
                        console.log('搜索输入:', e.target.value);
                        this.handleSearchInput(e.target.value);
                    });

                    // 聚焦事件 - 显示搜索过滤器
                    searchInput.addEventListener('focus', () => {
                        console.log('搜索框获得焦点');
                        this.showSearchFilters();
                    });

                    // 失焦事件 - 延迟隐藏搜索过滤器
                    searchInput.addEventListener('blur', () => {
                        console.log('搜索框失去焦点');
                        // 延迟隐藏，给用户时间点击过滤器选项
                        setTimeout(() => {
                            this.hideSearchFiltersIfNoFocus();
                        }, 200);
                    });

                    // 键盘事件
                    searchInput.addEventListener('keydown', (e) => {
                        this.handleSearchKeydown(e);
                    });
                }

                if (clearSearchBtn) {
                    clearSearchBtn.addEventListener('click', () => {
                        this.clearSearch();
                    });
                }



                // 搜索过滤器事件
                document.addEventListener('change', (e) => {
                    if (e.target.matches('#search-title, #search-description, #search-tags, #search-category')) {
                        const filterType = e.target.id.replace('search-', '');
                        this.searchState.searchFilters[filterType] = e.target.checked;
                        console.log(`搜索过滤器 "${filterType}" 已${e.target.checked ? '启用' : '禁用'}`);
                        console.log('当前搜索过滤器状态:', this.searchState.searchFilters);
                        
                        if (this.searchState.query) {
                            this.performSearch(this.searchState.query);
                        }
                    }
                });

                // 搜索过滤器点击事件 - 防止失焦
                document.addEventListener('mousedown', (e) => {
                    if (e.target.closest('#search-filters')) {
                        e.preventDefault();
                        // 确保搜索框保持焦点
                        const searchInput = document.getElementById('search-input');
                        if (searchInput) {
                            searchInput.focus();
                        }
                    }
                });

                // 点击外部关闭搜索过滤器
                document.addEventListener('click', (e) => {
                    const searchContainer = e.target.closest('.search-container');
                    const searchFilters = document.getElementById('search-filters');
                    
                    if (!searchContainer && searchFilters && !searchFilters.classList.contains('hidden')) {
                        // 延迟检查，给用户时间点击过滤器选项
                        setTimeout(() => {
                            this.hideSearchFiltersIfNoFocus();
                        }, 100);
                    }
                });

                // 全局键盘事件监听
                document.addEventListener('keydown', (e) => {
                    // 如果当前焦点在输入框中，不处理全局快捷键
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                        return;
                    }
                    
                    // Ctrl/Cmd + K 聚焦搜索框
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        const searchInput = document.getElementById('search-input');
                        if (searchInput) {
                            searchInput.focus();
                        }
                    }
                    
                    // / 键聚焦搜索框
                    if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        const searchInput = document.getElementById('search-input');
                        if (searchInput) {
                            searchInput.focus();
                        }
                    }
                });

            }

            // 处理搜索输入
            async handleSearchInput(query) {
                this.searchState.query = query.trim();
                
                // 显示/隐藏清除按钮
                const clearSearchBtn = document.getElementById('clear-search-btn');
                if (clearSearchBtn) {
                    clearSearchBtn.classList.toggle('hidden', !this.searchState.query);
                }

                // 当有搜索内容时，确保搜索过滤器可见
                if (this.searchState.query.length > 0) {
                    this.showSearchFilters();
                }

                // 清除之前的搜索超时
                if (this.searchState.searchTimeout) {
                    clearTimeout(this.searchState.searchTimeout);
                }

                if (this.searchState.query.length === 0) {
                    await this.clearSearch();
                    return;
                }

                // 防抖搜索 - 300ms延迟
                this.searchState.searchTimeout = setTimeout(() => {
                    this.performSearch(this.searchState.query);
                }, 300);
            }

            // 处理搜索键盘事件
            handleSearchKeydown(e) {
                switch (e.key) {
                    case 'Enter':
                        e.preventDefault();
                        this.performSearch(this.searchState.query);
                        break;
                    case 'Escape':
                        e.preventDefault();
                        if (this.searchState.query) {
                            this.clearSearch();
                        } else {
                            // 如果没有搜索内容，隐藏过滤器
                            this.hideSearchFilters();
                        }
                        break;
                    case '/':
                        // 当按下 / 键时，如果搜索框没有焦点，则聚焦到搜索框
                        if (document.activeElement !== e.target) {
                        e.preventDefault();
                            e.target.focus();
                        }
                        break;
                }
            }

            // 执行搜索
            async performSearch(query) {
                console.log('开始执行搜索:', query);
                
                if (!query.trim()) {
                    console.log('搜索查询为空，清除搜索');
                    await this.clearSearch();
                    return;
                }

                const startTime = Date.now();
                this.showSearchStats();

                try {
                    console.log('获取所有资源...');
                    // 获取所有资源
                    const allResources = await this.getAllResources();
                    console.log('获取到的资源数量:', Object.keys(allResources).length);
                    
                    console.log('应用搜索过滤器...');
                    // 应用搜索过滤器
                    const filteredResources = this.filterResourcesByQuery(allResources, query);
                    console.log('过滤后的资源数量:', filteredResources.length);
                    
                    console.log('更新搜索结果...');
                    // 更新搜索结果
                    this.updateSearchResults(filteredResources, startTime);
                    
                    // 保存搜索历史
                    this.saveSearchHistory(query);
                    
                    console.log('搜索完成');
                } catch (error) {
                    console.error('搜索失败:', error);
                    this.showNotification('搜索失败: ' + error.message, 'error');
                }
            }

            // 根据查询过滤资源
            filterResourcesByQuery(resources, query) {
                console.log('开始过滤资源，查询:', query);
                console.log('当前搜索过滤器状态:', this.searchState.searchFilters);
                console.log('输入资源:', resources);
                
                const searchTerms = query.toLowerCase().split(/\s+/).filter(term => term.length > 0);
                console.log('搜索词:', searchTerms);
                const filteredResources = [];

                Object.keys(resources).forEach(category => {
                    console.log(`处理分类: ${category}`);
                    const categoryResources = resources[category];
                    console.log(`分类 ${category} 的资源:`, categoryResources);
                    
                    Object.keys(categoryResources).forEach(id => {
                        const resource = categoryResources[id];
                        console.log(`处理资源 ${id}:`, resource);
                        let matchScore = 0;

                        searchTerms.forEach(term => {
                            // 标题匹配 - 最高权重
                            if (this.searchState.searchFilters.title && 
                                resource.title && 
                                resource.title.toLowerCase().includes(term)) {
                                matchScore += 10;
                                console.log(`标题匹配 "${term}": +10分`);
                            }

                            // 描述匹配 - 中等权重
                            if (this.searchState.searchFilters.description && 
                                resource.description && 
                                resource.description.toLowerCase().includes(term)) {
                                matchScore += 5;
                                console.log(`描述匹配 "${term}": +5分`);
                            }

                            // 标签匹配 - 高权重
                            if (this.searchState.searchFilters.tags && 
                                resource.tags && 
                                Array.isArray(resource.tags)) {
                                console.log(`检查资源 ${resource.id} 的标签:`, resource.tags);
                                const tagMatch = resource.tags.some(tag => {
                                    const match = tag.toLowerCase().includes(term);
                                    if (match) {
                                        console.log(`标签 "${tag}" 匹配关键词 "${term}"`);
                                    }
                                    return match;
                                });
                                if (tagMatch) {
                                    matchScore += 8;
                                    console.log(`标签匹配 "${term}": +8分`);
                                }
                            } else {
                                if (!this.searchState.searchFilters.tags) {
                                    console.log(`标签搜索已禁用`);
                                } else if (!resource.tags) {
                                    console.log(`资源 ${resource.id} 没有标签`);
                                } else if (!Array.isArray(resource.tags)) {
                                    console.log(`资源 ${resource.id} 的标签不是数组:`, resource.tags);
                                }
                            }

                            // 分类匹配 - 低权重
                            if (this.searchState.searchFilters.category) {
                                const categoryName = this.getCategoryName(category);
                                const categoryLower = category.toLowerCase();
                                const categoryNameLower = categoryName.toLowerCase();
                                
                                if (categoryLower.includes(term) || categoryNameLower.includes(term)) {
                                matchScore += 3;
                                    console.log(`分类匹配 "${term}": +3分 (分类: ${categoryName})`);
                                }
                            }
                        });

                        console.log(`资源 ${id} 最终匹配分数: ${matchScore}`);
                        if (matchScore > 0) {
                            const filteredResource = {
                                ...resource,
                                category,
                                id,
                                matchScore
                            };
                            console.log('添加过滤资源:', filteredResource);
                            filteredResources.push(filteredResource);
                        }
                    });
                });

                console.log('过滤完成，结果数量:', filteredResources.length);
                // 按匹配分数排序
                const sortedResources = filteredResources.sort((a, b) => b.matchScore - a.matchScore);
                console.log('排序后的资源:', sortedResources);
                return sortedResources;
            }

            // 更新搜索结果
            updateSearchResults(filteredResources, startTime) {
                const searchTime = Date.now() - startTime;
                const resultsCount = filteredResources.length;

                // 更新搜索统计
                const searchStats = document.getElementById('search-stats');
                const searchResultsCount = document.getElementById('search-results-count');
                const searchTimeElement = document.getElementById('search-time');

                if (searchStats) {
                    searchStats.classList.remove('hidden');
                }

                if (searchResultsCount) {
                    searchResultsCount.textContent = resultsCount;
                }

                if (searchTimeElement) {
                    searchTimeElement.textContent = `(${searchTime}ms)`;
                }

                // 更新资源显示
                this.displaySearchResults(filteredResources);

                // 显示搜索结果通知
                if (resultsCount > 0) {
                    this.showNotification(`找到 ${resultsCount} 个相关资源`, 'success');
                } else {
                    this.showNotification('未找到相关资源', 'info');
                }
            }

            // 显示搜索结果
            displaySearchResults(filteredResources) {
                const resourcesGrid = document.getElementById('resources-grid');
                if (!resourcesGrid) return;

                console.log('显示搜索结果:', filteredResources);

                // 清空现有内容
                resourcesGrid.innerHTML = '';

                if (filteredResources.length === 0) {
                    // 显示空状态
                    resourcesGrid.innerHTML = `
                        <div class="col-span-full text-center py-12 animate-fade-in">
                            <i class="fa fa-search text-6xl text-gray-300 mb-4 float-animation"></i>
                            <h3 class="text-xl font-semibold gradient-text mb-2">未找到相关资源</h3>
                            <p class="text-gray-500 mb-6">尝试使用不同的关键词或调整搜索范围</p>
                            <button onclick="window.resourceManagerUI.clearSearch()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-red-700 btn-hover transition-colors duration-200">
                                <i class="fa fa-times mr-2"></i>清除搜索
                            </button>
                        </div>
                    `;
                    return;
                }

                // 渲染搜索结果
                filteredResources.forEach((resource, index) => {
                    console.log('创建搜索资源卡片:', resource);
                    // 确保资源对象包含所有必要字段
                    const completeResource = {
                        ...resource,
                        category: resource.category || 'unknown',
                        title: resource.title || '无标题',
                        description: resource.description || resource.content || '暂无描述',
                        content: resource.content || resource.description || '暂无内容',
                        icon: resource.icon || 'fa-utensils',
                        tags: Array.isArray(resource.tags) ? resource.tags : [],
                        media: Array.isArray(resource.media) ? resource.media : [],
                        updatedAt: resource.updatedAt || new Date().toISOString()
                    };
                    
                    const resourceCard = this.createResourceCard(completeResource);
                    resourcesGrid.appendChild(resourceCard);
                    
                    // 添加动画显示效果
                    setTimeout(() => {
                        if (resourceCard) {
                            resourceCard.style.opacity = '1';
                            resourceCard.style.transform = 'translateX(0)';
                        }
                    }, index * 100); // 每个卡片延迟100ms显示
                });

                // 隐藏分页（搜索时不分页）
                const pagination = document.getElementById('pagination');
                if (pagination) {
                    pagination.classList.add('hidden');
                }
            }



            // 显示搜索过滤器
            showSearchFilters() {
                const searchFilters = document.getElementById('search-filters');
                if (searchFilters) {
                    searchFilters.classList.remove('hidden');
                    // 添加显示动画
                    searchFilters.style.opacity = '0';
                    searchFilters.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        searchFilters.style.transition = 'all 0.3s ease';
                        searchFilters.style.opacity = '1';
                        searchFilters.style.transform = 'translateY(0)';
                    }, 10);
                }
            }

            // 隐藏搜索过滤器
            hideSearchFilters() {
                const searchFilters = document.getElementById('search-filters');
                if (searchFilters) {
                    // 添加淡出动画
                    searchFilters.style.transition = 'all 0.3s ease';
                    searchFilters.style.opacity = '0';
                    searchFilters.style.transform = 'translateY(-10px)';
                    
                    setTimeout(() => {
                        searchFilters.classList.add('hidden');
                        // 重置样式
                        searchFilters.style.opacity = '';
                        searchFilters.style.transform = '';
                        searchFilters.style.transition = '';
                    }, 300);
                }
            }

            // 智能隐藏搜索过滤器（检查是否真的没有焦点）
            hideSearchFiltersIfNoFocus() {
                const searchInput = document.getElementById('search-input');
                const searchFilters = document.getElementById('search-filters');
                
                // 检查搜索框是否重新获得焦点
                if (searchInput && document.activeElement === searchInput) {
                    console.log('搜索框重新获得焦点，不隐藏过滤器');
                    return;
                }
                
                // 检查是否有过滤器元素获得焦点
                const focusedElement = document.activeElement;
                if (focusedElement && searchFilters && searchFilters.contains(focusedElement)) {
                    console.log('过滤器元素获得焦点，不隐藏过滤器');
                    return;
                }

                // 检查是否有搜索相关的元素获得焦点
                if (focusedElement && (
                    focusedElement.id === 'search-input' ||
                    focusedElement.id === 'clear-search-btn' ||
                    focusedElement.id === 'search-title' ||
                    focusedElement.id === 'search-description' ||
                    focusedElement.id === 'search-tags' ||
                    focusedElement.id === 'search-category'
                )) {
                    console.log('搜索相关元素获得焦点，不隐藏过滤器');
                    return;
                }
                
                console.log('隐藏搜索过滤器');
                this.hideSearchFilters();
            }

            // 初始化搜索过滤器状态
            initSearchFilters() {
                const titleCheckbox = document.getElementById('search-title');
                const descriptionCheckbox = document.getElementById('search-description');
                const tagsCheckbox = document.getElementById('search-tags');
                const categoryCheckbox = document.getElementById('search-category');

                if (titleCheckbox) {
                    this.searchState.searchFilters.title = titleCheckbox.checked;
                }
                if (descriptionCheckbox) {
                    this.searchState.searchFilters.description = descriptionCheckbox.checked;
                }
                if (tagsCheckbox) {
                    this.searchState.searchFilters.tags = tagsCheckbox.checked;
                }
                if (categoryCheckbox) {
                    this.searchState.searchFilters.category = categoryCheckbox.checked;
                }

                console.log('搜索过滤器初始化完成:', this.searchState.searchFilters);
            }

            // 显示搜索统计
            showSearchStats() {
                const searchStats = document.getElementById('search-stats');
                if (searchStats) {
                    searchStats.classList.remove('hidden');
                }
            }

            // 隐藏搜索统计
            hideSearchStats() {
                const searchStats = document.getElementById('search-stats');
                if (searchStats) {
                    searchStats.classList.add('hidden');
                }
            }

            // 清除搜索
            async clearSearch() {
                const searchInput = document.getElementById('search-input');
                const clearSearchBtn = document.getElementById('clear-search-btn');
                const searchStats = document.getElementById('search-stats');
                const searchFilters = document.getElementById('search-filters');

                if (searchInput) {
                    searchInput.value = '';
                }

                if (clearSearchBtn) {
                    clearSearchBtn.classList.add('hidden');
                }

                if (searchStats) {
                    searchStats.classList.add('hidden');
                }

                if (searchFilters) {
                    searchFilters.classList.add('hidden');
                }



                // 重置搜索状态
                this.searchState.query = '';

                // 恢复原始资源显示
                await this.renderResources();
            }

            // 保存搜索历史
            saveSearchHistory(query) {
                try {
                    const searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
                    const newHistory = [query, ...searchHistory.filter(item => item !== query)].slice(0, 10);
                    localStorage.setItem('searchHistory', JSON.stringify(newHistory));
                } catch (error) {
                    console.error('保存搜索历史失败:', error);
                }
            }

            // 获取搜索历史
            getSearchHistory() {
                try {
                    return JSON.parse(localStorage.getItem('searchHistory') || '[]');
                } catch (error) {
                    console.error('获取搜索历史失败:', error);
                    return [];
                }
            }

            // 高亮文本中的搜索关键词
            highlightText(text, query) {
                if (!text || !query) return text;
                
                const searchTerms = query.toLowerCase().split(/\s+/).filter(term => term.length > 0);
                let highlightedText = text;
                
                searchTerms.forEach(term => {
                    const regex = new RegExp(`(${this.escapeRegExp(term)})`, 'gi');
                    highlightedText = highlightedText.replace(regex, '<mark class="search-highlight" title="匹配关键词: $1">$1</mark>');
                });
                
                return highlightedText;
            }
            
            // 转义正则表达式特殊字符
            escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // 获取所有资源（用于搜索）
            async getAllResources() {
                try {
                    console.log('开始获取所有资源...');
                    // 使用专门的搜索端点获取所有资源
                    const response = await this.callResourceAPI(this.resourceServerConfig.endpoints.searchAll);
                    console.log('API响应:', response);
                    const resources = response.resources || {};
                    console.log('获取到的资源:', resources);
                    console.log('资源分类数量:', Object.keys(resources).length);
                    console.log('总资源数:', response.totalCount || 0);
                    
                    return resources;
                } catch (error) {
                    console.error('获取所有资源失败:', error);
                    return {};
                }
            }
            
            // 绑定动画事件
            bindAnimationEvents() {
                try {
                    // 使用防抖优化事件绑定
                    const debounce = (func, wait) => {
                        let timeout;
                        return function executedFunction(...args) {
                            const later = () => {
                                clearTimeout(timeout);
                                func(...args);
                            };
                            clearTimeout(timeout);
                            timeout = setTimeout(later, wait);
                        };
                    };
                    
                    // 为所有按钮添加点击动画
                    const buttons = document.querySelectorAll('button, .btn, .btn-primary, .btn-secondary');
                    buttons.forEach(button => {
                        if (button) {
                            button.classList.add('btn-clickable');
                        }
                    });
                    
                    // 为卡片添加悬停动画（使用事件委托优化性能）
                    const grid = document.getElementById('resources-grid');
                    if (grid) {
                        grid.addEventListener('mouseenter', (e) => {
                            const card = e.target.closest('.resource-card');
                            if (card) {
                                card.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                            }
                        }, true);
                    }
                    
                    // 为分页按钮添加动画
                    const pagination = document.getElementById('pagination');
                    if (pagination) {
                        pagination.addEventListener('mouseenter', (e) => {
                            const item = e.target.closest('.pagination-item');
                            if (item) {
                                item.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                            }
                        }, true);
                    }
                    
                    // 为标签添加动画
                    const tagContainers = document.querySelectorAll('.resource-card');
                    tagContainers.forEach(container => {
                        container.addEventListener('mouseenter', (e) => {
                            const tag = e.target.closest('.tag-item');
                            if (tag) {
                                tag.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                            }
                        }, true);
                    });
                    
                    // 为统计卡片添加动画
                    const statsCards = document.querySelectorAll('.stats-card');
                    statsCards.forEach(card => {
                        if (card) {
                            card.addEventListener('mouseenter', () => {
                                card.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                            });
                        }
                    });
                    
                    // 为文件上传区域添加动画
                    const uploadZones = document.querySelectorAll('.file-upload-zone');
                    uploadZones.forEach(zone => {
                        if (zone) {
                            zone.addEventListener('mouseenter', () => {
                                zone.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                            });
                        }
                    });
                    
                    console.log('✅ 动画事件绑定完成（已优化性能）');
                } catch (error) {
                    console.error('❌ 动画事件绑定失败:', error);
                }
            }
            
            // 初始化页面加载动画
            initPageLoadAnimation() {
                const mainContent = document.querySelector('.container');
                if (mainContent) {
                    mainContent.classList.add('page-loading');
                    
                    // 移除加载动画类
                    setTimeout(() => {
                        mainContent.classList.remove('page-loading');
                    }, 1000);
                }
            }
        }

        // 移动端菜单功能
        function initMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileExportBtn = document.getElementById('mobile-export-btn');
            const mobileImportBtn = document.getElementById('mobile-import-btn');
            const mobileQuickMenuBtn = document.getElementById('mobile-quick-menu-btn');

            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }

            // 移动端按钮事件绑定
            if (mobileExportBtn) {
                mobileExportBtn.addEventListener('click', () => {
                    window.resourceManagerUI.exportResources();
                    mobileMenu.classList.add('hidden');
                });
            }

            if (mobileImportBtn) {
                mobileImportBtn.addEventListener('click', () => {
                    window.resourceManagerUI.importResources();
                    mobileMenu.classList.add('hidden');
                });
            }

            if (mobileQuickMenuBtn) {
                mobileQuickMenuBtn.addEventListener('click', () => {
                    window.resourceManagerUI.showQuickMenu();
                    mobileMenu.classList.add('hidden');
                });
            }

            // 点击外部关闭菜单
            document.addEventListener('click', (e) => {
                if (mobileMenu && !mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                    mobileMenu.classList.add('hidden');
                }
            });
        }

        // 初始化
        window.resourceManagerUI = new SimpleResourceManagerUI();
        
        // 添加全局测试函数
        window.testEditFunction = function() {
            console.log('测试编辑功能');
            if (window.resourceManagerUI && window.resourceManagerUI.editResource) {
                console.log('编辑功能可用');
                return true;
            } else {
                console.log('编辑功能不可用');
                return false;
            }
        };
        
        // 初始化移动端菜单
        document.addEventListener('DOMContentLoaded', () => {
            initMobileMenu();
            
            // 初始化分类筛选器监听
            if (window.resourceManagerUI) {
                window.resourceManagerUI.initCategoryFilterListener();
            }
        });
    </script>
</body>
</html> 
</html> 